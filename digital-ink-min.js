!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("js-ext"),require("js-md5"),require("long"),require("gl-matrix"),require("clipper-lib"),require("rbush"),require("poly2tri"),require("protobufjs")):"function"==typeof define&&define.amd?define(["exports","js-ext","js-md5","long","gl-matrix","clipper-lib","rbush","poly2tri","protobufjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).DigitalInk={},e.jsExt,null,null,e.glMatrix,null,e.RBush)}(this,(function(e,t,r,n,i,o,a){"use strict";function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}"undefined"!=typeof window&&"function"==typeof require?(globalThis.ClipperLib=require("clipper-lib"),globalThis.poly2tri=require("poly2tri"),globalThis.md5=require("js-md5"),globalThis.Long=require("long"),globalThis.protobuf=require("protobufjs")):(void 0===globalThis.jsExt&&console.warn("digital-ink dependency js-ext not found, expected in global scope"),void 0===globalThis.glMatrix&&console.warn("digital-ink dependency gl-matrix not found, expected in global scope"),void 0===globalThis.RBush&&console.warn("digital-ink dependency rbush not found, expected in global scope")),void 0===globalThis.ClipperLib&&console.warn("digital-ink dependency clipper-lib not found, expected in global scope"),void 0===globalThis.poly2tri&&console.warn("digital-ink dependency poly2tri not found, expected in global scope"),void 0===globalThis.md5&&console.warn("digital-ink dependency js-md5 not found, expected in global scope"),void 0===globalThis.Long&&console.warn("digital-ink dependency long not found, expected in global scope"),void 0===globalThis.protobuf&&console.warn("digital-ink dependency protobufjs not found, expected in global scope");var u=s(a);function l(e){var t={exports:{}};return e(t,t.exports),t.exports}var c=l((function(e){function t(r){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?e.exports=t=function(e){return typeof e}:e.exports=t=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(r)}e.exports=t}));var h=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function f(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var d=function(e,t,r){return t&&f(e.prototype,t),r&&f(e,r),e},p=function(){function e(){h(this,e)}return d(e,[{key:"getInkBuilder",value:function(e){throw new Error("InkController.getInkBuilder(pointerID) should be implemented")}},{key:"registerInputProvider",value:function(e,t){throw new Error("InkController.registerInputProvider(pointerID, isPrimary) should be implemented")}},{key:"reset",value:function(e){throw new Error("InkController.reset(sensorPoint) should be implemented")}},{key:"begin",value:function(e){throw new Error("InkController.begin(sensorPoint) should be implemented")}},{key:"move",value:function(e){throw new Error("InkController.move(sensorPoint) should be implemented")}},{key:"end",value:function(e){throw new Error("InkController.end(sensorPoint) should be implemented")}},{key:"abort",value:function(e){throw new Error("InkController.abort(pointerID) should be implemented")}},{key:"resize",value:function(){throw new Error("InkController.resize() should be implemented")}}]),e}();var y=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},v=l((function(e){function t(r,n){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(r,n)}e.exports=t}));var g=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&v(e,t)};var m=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var b=function(e,t){return!t||"object"!==c(t)&&"function"!=typeof t?m(e):t},E=l((function(e){function t(r){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},t(r)}e.exports=t}));var x=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")};var P=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}},k=l((function(e){function t(r,n,i){return P()?e.exports=t=Reflect.construct:e.exports=t=function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&v(i,r.prototype),i},t.apply(null,arguments)}e.exports=t})),w=l((function(e){function t(r){var n="function"==typeof Map?new Map:void 0;return e.exports=t=function(e){if(null===e||!x(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return k(e,arguments,E(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),v(t,e)},t(r)}e.exports=t})),R="1.3.0";Object.defineProperty(globalThis,"DIGITAL_INK_ENV",{value:"AUTO",enumerable:!0,configurable:!0});var I={version:R};Object.defineEnum(I,"Type",["WEB","WORKER","NODE","SHELL"]),Object.defineEnum(I,"Type2D",["SCREEN","OFFSCREEN"]),Object.defineEnum(I,"TypeGL",["WEB","STACK"]),function(e){var t,r="BROWSER"!=DIGITAL_INK_ENV&&"object"===("undefined"==typeof process?"undefined":c(process))&&"function"==typeof require;t="object"===("undefined"==typeof window?"undefined":c(window))?"WEB":"function"==typeof importScripts?"WORKER":r?"NODE":"SHELL";var n="undefined"==typeof OffscreenCanvas?"OFFSCREEN":"SCREEN",i="undefined"==typeof WebGLRenderingContext?"STACK":"WEB";Object.defineProperty(I,"commonJS",{value:r,enumerable:!0}),Object.defineProperty(I,"type",{value:I.Type[t],enumerable:!0}),Object.defineProperty(I,"type2D",{value:I.Type2D[n],enumerable:!0}),Object.defineProperty(I,"typeGL",{value:I.TypeGL[i],enumerable:!0})}();var S=I.commonJS?require("js-md5"):globalThis.md5,T=I.commonJS?require("long"):globalThis.Long,A={mask:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",generate:function(){var e=Date.now();return this.mask.replace(/[xy]/g,(function(t){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:3&r|8).toString(16)}))},fromString:function(e){return this.fromBytes(new Uint8Array(S.arrayBuffer(e)))},toBytes:function(e){var t=[];return e.split("-").map((function(e,r){(r<3?e.match(/.{1,2}/g).reverse():e.match(/.{1,2}/g)).map((function(e){return t.push(parseInt(e,16))}))})),new Uint8Array(t)},fromBytes:function(e){var t=Array.from(e).map((function(e){return e.toString(16)})).map((function(e){return(1==e.length?"0":"")+e}));return t.slice(0,4).reverse().join("")+"-"+t.slice(4,6).reverse().join("")+"-"+t.slice(6,8).reverse().join("")+"-"+t.slice(8,10).join("")+"-"+t.slice(10).join("")},toUint32Array:function(e){var t=new Uint32Array(4),r=this.toBytes(e);return t[0]=new Uint32Array(r.slice(0,4).buffer)[0],t[1]=new Uint32Array(r.slice(4,8).buffer)[0],t[2]=new Uint32Array(r.slice(8,12).buffer)[0],t[3]=new Uint32Array(r.slice(12).buffer)[0],t},fromUint32Array:function(e){return this.fromBytes(new Uint8Array(e.buffer))},toUint64Array:function(e){var t=new BigUint64Array(2),r=this.toBytes(e);return t[0]=new BigUint64Array(r.slice(0,8).buffer)[0],t[1]=new BigUint64Array(r.slice(8).buffer)[0],t},fromUint64Array:function(e){return this.fromBytes(new Uint8Array(e.buffer))},toLongArray:function(e){var t=new Array(2),r=this.toBytes(e);return t[0]=T.fromBytes(r.slice(0,8)),t[1]=T.fromBytes(r.slice(8)),t},fromLongArray:function(e){var t=e[0].toBytes().concat(e[1].toBytes());return this.fromBytes(t)}};function O(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return C(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return C(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function C(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var D=function(){function e(t){var r=this;h(this,e),Object.defineProperty(this,"id",{get:function(){return t||(t=this.resolveID()),t},set:function(e){var r=t;t=e,this.updateID(r,t)},enumerable:!0}),Object.defineProperty(this,"algorithm",{get:function(){return"function"==typeof r.getMD5Message?e.Algorithm.MD5:e.Algorithm.GUID},enumerable:!0})}return d(e,null,[{key:"SEPARATOR",get:function(){return"\n"}}]),d(e,[{key:"resolveID",value:function(){if(this.algorithm==e.Algorithm.MD5){var t,r="",n=O(this.getMD5Message());try{for(n.s();!(t=n.n()).done;){var i=t.value;if(Array.isArray(i)){var o,a=O(i);try{for(a.s();!(o=a.n()).done;){r+=o.value,r+="\n"}}catch(e){a.e(e)}finally{a.f()}}else r+=i;r+="\n"}}catch(e){n.e(e)}finally{n.f()}if(!r)throw new Error("Empty MD5 message container found");return S(r)}return A.generate()}},{key:"updateID",value:function(e,t){}},{key:"invalidateID",value:function(){this.id=void 0}}],[{key:"getMD5Tokens",value:function(e){var t=[];return Object.keys(e).sort().forEach((function(r){return t.push(r,e[r])})),t}}]),e}();function N(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}Object.defineEnum(D,"Algorithm",["GUID","MD5"]);var M=function(e){g(r,e);var t=N(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return h(this,r),(n=t.call(this)).type=e,n.props=Object.assign({},i),n}return d(r,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. InkInputProvider do not belongs to any SensorChannelsContext yet");return["InkInputProvider",this.type.name,D.getMD5Tokens(this.props)]}}]),r}(D);Object.defineEnum(M,"Type",["PEN","TOUCH","MOUSE","CONTROLLER"]);var L=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n};var _=function(e){if(Array.isArray(e))return L(e)};var F=function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)};var B=function(e,t){if(e){if("string"==typeof e)return L(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?L(e,t):void 0}};var U=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var j=function(e){return _(e)||F(e)||B(e)||U()},G=function(){function e(){h(this,e),this.path=[],this.phase=e.Phase.END;var t=!1;Object.defineProperty(this,"keepAllData",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),e.OutputType.ALL_DATA)},enumerable:!0})}return d(e,[{key:"add",value:function(t,r,n){var i;if(!this.move(t))throw new Error("Cannot move from phase ".concat(this.phase.name," to phase ").concat(t.name));this.debug&&(console.log("-------------------------------------"),console.log(this.constructor.name,t.name));var o=this.addImpl(r,n);return this.keepAllData&&(i=this.path).push.apply(i,j(o.added)),{added:this.getOutput(o.added,e.OutputType.ADDITION),predicted:this.getOutput(o.predicted,e.OutputType.PREDICTION)}}},{key:"addImpl",value:function(e,t){throw new Error("Abstract method addImpl of DataProcessor should be implemented")}},{key:"getOutput",value:function(e,t){return e}},{key:"move",value:function(t){return(this.phase!=e.Phase.END||t==e.Phase.BEGIN)&&((this.phase!=e.Phase.BEGIN||t==e.Phase.UPDATE||t==e.Phase.END)&&((this.phase!=e.Phase.UPDATE||t==e.Phase.UPDATE||t==e.Phase.END)&&(t==e.Phase.BEGIN&&this.reset(),this.phase=t,!0)))}},{key:"reset",value:function(){this.path.clear(),this.phase=e.Phase.END}}]),e}();Object.defineEnum(G,"Phase",["BEGIN","UPDATE","END"]),Object.defineEnum(G,"OutputType",["ADDITION","PREDICTION","ALL_DATA"]);var Y=function(){function e(t,r,n,o){var a=this;if(h(this,e),isNaN(t))throw new Error("Invalid x found: ".concat(t));if(isNaN(r))throw new Error("Invalid y found: ".concat(r));var s=[t,r];isFinite(n)&&(s.push(n),isFinite(o)&&s.push(o)),this.value=s.toFloat32Array(),Object.defineProperty(this,"x",{get:function(){return a.value[0]},set:function(e){a.value[0]=e},enumerable:!0}),Object.defineProperty(this,"y",{get:function(){return a.value[1]},set:function(e){a.value[1]=e},enumerable:!0}),2==s.length?this.vec=i.vec2:3==s.length?(this.vec=i.vec3,Object.defineProperty(this,"z",{get:function(){return a.value[2]},set:function(e){a.value[2]=e},enumerable:!0})):(this.vec=i.vec4,Object.defineProperty(this,"w",{get:function(){return a.value[3]},set:function(e){a.value[3]=e},enumerable:!0}))}return d(e,[{key:"add",value:function(t){t instanceof e||(t=e.fromPoint(t));var r=this.vec.create();return this.vec.add(r,this.value,t.value),e.fromPoint(r)}},{key:"addSelf",value:function(t){return t instanceof e||(t=e.fromPoint(t)),this.vec.add(this.value,this.value,t.value),this}},{key:"subtract",value:function(t){t instanceof e||(t=e.fromPoint(t));var r=this.vec.create();return this.vec.subtract(r,this.value,t.value),e.fromPoint(r)}},{key:"subtractSelf",value:function(t){return t instanceof e||(t=e.fromPoint(t)),this.vec.subtract(this.value,this.value,t.value),this}},{key:"multiply",value:function(t){t instanceof e||(t=e.fromPoint(t));var r=this.vec.create();return this.vec.multiply(r,this.value,t.value),e.fromPoint(r)}},{key:"multiplySelf",value:function(t){return t instanceof e||(t=e.fromPoint(t)),this.vec.multiply(this.value,this.value,t.value),this}},{key:"divide",value:function(t){t instanceof e||(t=e.fromPoint(t));var r=this.vec.create();return this.vec.divide(r,this.value,t.value),e.fromPoint(r)}},{key:"divideSelf",value:function(t){return t instanceof e||(t=e.fromPoint(t)),this.vec.divide(this.value,this.value,t.value),this}},{key:"scale",value:function(t){var r=this.vec.create();return this.vec.scale(r,this.value,t),e.fromPoint(r)}},{key:"scaleSelf",value:function(e){return this.vec.scale(this.value,this.value,e),this}},{key:"abs",value:function(){return new e(Math.abs(this.x),Math.abs(this.y),isFinite(this.z)?Math.abs(this.z):void 0,isFinite(this.w)?Math.abs(this.w):void 0)}},{key:"absSelf",value:function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),isFinite(this.z)&&(this.z=Math.abs(this.z)),isFinite(this.w)&&(this.w=Math.abs(this.w)),this}},{key:"transform",value:function(t){if(!t)return this;var r=this.vec.create();return this.vec.transformMat4(r,this.value,t.toFloat32Array()),e.fromPoint(r)}},{key:"transformSelf",value:function(e){return this.vec.transformMat4(this.value,this.value,e.toFloat32Array()),this}},{key:"toFloat32Array",value:function(){return this.value}},{key:"toJSON",value:function(){var e={x:this.x,y:this.y};return isFinite(this.z)&&(e.z=this.z,isFinite(this.w)&&(e.w=this.w)),e}},{key:"toString",value:function(){return"point(".concat(this.value.join(", "),")")}},{key:"clone",value:function(){return e.fromPoint(this)}}],[{key:"fromPoint",value:function(t){return Array.isArray(t)||ArrayBuffer.isTypedArray(t)?new e(t[0],t[1],t[2],t[3]):new e(t.x,t.y,t.z,t.w)}}]),e}(),z=function(){function e(t,r,n){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;h(this,e),this.red=t,this.green=r,this.blue=n,this.alpha=o,Object.defineProperty(this,"hex",{get:function(){return"#"+i.red.toString(16).pad(2,"0")+i.green.toString(16).pad(2,"0")+i.blue.toString(16).pad(2,"0")},enumerable:!0})}return d(e,[{key:"premultiply",value:function(){return new e(this.red/255*this.alpha,this.green/255*this.alpha,this.blue/255*this.alpha,this.alpha)}},{key:"postdivide",value:function(t,r,n,i){return new e(parseInt(255*t/i),parseInt(255*r/i),parseInt(255*n/i),i)}},{key:"equals",value:function(e){return e&&this.red==e.red&&this.green==e.green&&this.blue==e.blue&&this.alpha==e.alpha}},{key:"toRGB",value:function(){return 1==this.alpha?this:new e(this.red,this.green,this.blue)}},{key:"toRGBA",value:function(t){return new e(this.red,this.green,this.blue,t)}},{key:"toHSLA",value:function(){var e=this.red/255,t=this.green/255,r=this.blue/255,n=Math.min(e,t,r),i=Math.max(e,t,r),o=0,a=0,s=(i+n)/2;if(i!=n){var u=i-n;switch(a=u/(1-Math.abs(2*s-1)),i){case e:o=(t-r)/u%6;break;case t:o=(r-e)/u+2;break;case r:o=(e-t)/u+4}}return(o*=60)<0&&(o+=360),{hue:parseFloat(o.toFixed(0)),saturation:parseFloat((100*a).toFixed(2)),lightness:parseFloat((100*s).toFixed(2)),alpha:this.alpha}}},{key:"toArray",value:function(){return[this.red,this.green,this.blue,this.alpha]}},{key:"toJSON",value:function(){return{red:this.red,green:this.green,blue:this.blue,alpha:this.alpha}}},{key:"toString",value:function(){return 1==this.alpha?"rgb(".concat(this.red,", ").concat(this.green,", ").concat(this.blue,")"):"rgba(".concat(this.red,", ").concat(this.green,", ").concat(this.blue,", ").concat(this.alpha,")")}}],[{key:"isColor",value:function(e){return e&&isFinite(e.red)&&isFinite(e.green)&&isFinite(e.blue)}},{key:"fromColor",value:function(t){var r,n,i,o;if("string"==typeof t){if(!t.startsWith("rgb")){if(t.startsWith("#"))return t=t.substring(1),new e(parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16));throw new Error("Unknown input found: ".concat(t,". Expected data starts with rgba, rgb or #."))}t=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(/,\s*/g),r=parseInt(t[0]),n=parseInt(t[1]),i=parseInt(t[2]),o=t[3]?parseInt(t[3]):1}else Array.isArray(t)?(r=t[0],n=t[1],i=t[2],o=t[3]):(r=t.red,n=t.green,i=t.blue,o=t.alpha);return new e(r,n,i,o)}},{key:"fromHSLA",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0;t/=60,r/=100,n/=100;var o=(1-Math.abs(2*n-1))*r,a=o*(1-Math.abs(t%2-1)),s=0,u=0,l=0;t>=0&&t<1?(s=o,u=a):t>=1&&t<2?(s=a,u=o):t>=2&&t<3?(u=o,l=a):t>=3&&t<4?(u=a,l=o):t>=4&&t<5?(s=a,l=o):(s=o,l=a);var c=n-o/2;return s+=c,u+=c,l+=c,new e(Math.round(255*s),Math.round(255*u),Math.round(255*l),i)}},{key:"random",value:function(t){return new e(Math.randomInt(0,255),Math.randomInt(0,255),Math.randomInt(0,255),t?Math.random():1)}}]),e}();z.TRANSPERENT=new z(0,0,0,0),z.BLACK=new z(0,0,0,1),z.WHITE=new z(255,255,255,1),z.RED=new z(255,0,0,1),z.GREEN=new z(0,255,0,1),z.BLUE=new z(0,0,255,1);var X=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=E(e)););return e},V=l((function(e){function t(r,n,i){return"undefined"!=typeof Reflect&&Reflect.get?e.exports=t=Reflect.get:e.exports=t=function(e,t,r){var n=X(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(r):i.value}},t(r,n,i||r)}e.exports=t})),H={m11:0,m12:1,m13:2,m14:3,m21:4,m22:5,m23:6,m24:7,m31:8,m32:9,m33:10,m34:11,m41:12,m42:13,m43:14,m44:15},q=H.m11,Z=H.m12,W=H.m21,K=H.m22,J=H.m41,Q=H.m42,$=function(){function e(){var t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i.mat4.create(),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.MultiplicationType.PRE;h(this,e),Object.defineProperty(this,"value",{value:r,enumerable:!0}),Object.defineProperty(this,"multiplicationType",{value:n,enumerable:!0});var o=function(e,t){var r=H[e];this.value[r]=t};Object.defineProperty(this,"a",{get:function(){return t.value[q]},set:o.bind(this,"m11"),enumerable:!0}),Object.defineProperty(this,"b",{get:function(){return t.value[Z]},set:o.bind(this,"m12"),enumerable:!0}),Object.defineProperty(this,"c",{get:function(){return t.value[W]},set:o.bind(this,"m21"),enumerable:!0}),Object.defineProperty(this,"d",{get:function(){return t.value[K]},set:o.bind(this,"m22"),enumerable:!0}),Object.defineProperty(this,"e",{get:function(){return t.value[J]},set:o.bind(this,"m41"),enumerable:!0}),Object.defineProperty(this,"f",{get:function(){return t.value[Q]},set:o.bind(this,"m42"),enumerable:!0}),Object.defineProperty(this,"tx",{get:function(){return t.value[J]},set:o.bind(this,"m41"),enumerable:!0}),Object.defineProperty(this,"ty",{get:function(){return t.value[Q]},set:o.bind(this,"m42"),enumerable:!0}),Object.defineProperty(this,"m11",{get:function(){return t.value[0]},set:o.bind(this,"m11"),enumerable:!0}),Object.defineProperty(this,"m12",{get:function(){return t.value[1]},set:o.bind(this,"m12"),enumerable:!0}),Object.defineProperty(this,"m13",{get:function(){return t.value[2]},set:o.bind(this,"m13"),enumerable:!0}),Object.defineProperty(this,"m14",{get:function(){return t.value[3]},set:o.bind(this,"m14"),enumerable:!0}),Object.defineProperty(this,"m21",{get:function(){return t.value[4]},set:o.bind(this,"m21"),enumerable:!0}),Object.defineProperty(this,"m22",{get:function(){return t.value[5]},set:o.bind(this,"m22"),enumerable:!0}),Object.defineProperty(this,"m23",{get:function(){return t.value[6]},set:o.bind(this,"m23"),enumerable:!0}),Object.defineProperty(this,"m24",{get:function(){return t.value[7]},set:o.bind(this,"m24"),enumerable:!0}),Object.defineProperty(this,"m31",{get:function(){return t.value[8]},set:o.bind(this,"m31"),enumerable:!0}),Object.defineProperty(this,"m32",{get:function(){return t.value[9]},set:o.bind(this,"m32"),enumerable:!0}),Object.defineProperty(this,"m33",{get:function(){return t.value[10]},set:o.bind(this,"m33"),enumerable:!0}),Object.defineProperty(this,"m34",{get:function(){return t.value[11]},set:o.bind(this,"m34"),enumerable:!0}),Object.defineProperty(this,"m41",{get:function(){return t.value[12]},set:o.bind(this,"m41"),enumerable:!0}),Object.defineProperty(this,"m42",{get:function(){return t.value[13]},set:o.bind(this,"m42"),enumerable:!0}),Object.defineProperty(this,"m43",{get:function(){return t.value[14]},set:o.bind(this,"m43"),enumerable:!0}),Object.defineProperty(this,"m44",{get:function(){return t.value[15]},set:o.bind(this,"m44"),enumerable:!0}),Object.defineProperty(this,"isIdentity",{get:function(){return 1==t.a&&0==t.b&&0==t.c&&1==t.d&&0==t.tx&&0==t.ty},enumerable:!0}),Object.defineProperty(this,"is2D",{get:function(){return!(0!=t.m31||0!=t.m32||0!=t.m13||0!=t.m23||1!=t.m33||0!=t.m43||0!=t.m14||0!=t.m24||0!=t.m34||1!=t.m44)},enumerable:!0}),Object.defineProperty(this,"translateX",{get:function(){return t.tx}}),Object.defineProperty(this,"translateY",{get:function(){return t.ty}}),Object.defineProperty(this,"skewX",{get:function(){return Math.tan(t.c)}}),Object.defineProperty(this,"skewY",{get:function(){return Math.tan(t.b)}}),Object.defineProperty(this,"scaleX",{get:function(){return Math.sqrt(t.a*t.a+t.c*t.c)}}),Object.defineProperty(this,"scaleY",{get:function(){return Math.sqrt(t.d*t.d+t.b*t.b)}}),Object.defineProperty(this,"rotation",{get:function(){return Math.atan2(t.b,t.a)}})}return d(e,[{key:"clone",value:function(){return new e(this.value.clone(),this.multiplicationType)}},{key:"translate",value:function(t){return this.multiply(e.fromTranslate(t))}},{key:"translateSelf",value:function(t){this.multiplySelf(e.fromTranslate(t))}},{key:"rotate",value:function(t,r){return this.multiply(e.fromRotate(t,r))}},{key:"rotateSelf",value:function(t,r){this.multiplySelf(e.fromRotate(t,r))}},{key:"scale",value:function(t,r){return this.multiply(e.fromScale(t,r))}},{key:"scaleSelf",value:function(t,r){this.multiplySelf(e.fromScale(t,r))}},{key:"multiply",value:function(t){return this.multiplicationType==e.MultiplicationType.PRE?this.preMultiply(t):this.postMultiply(t)}},{key:"preMultiply",value:function(t){var r=i.mat4.create();return i.mat4.multiply(r,t.toFloat32Array(),this.value),new e(r,this.multiplicationType)}},{key:"postMultiply",value:function(t){var r=i.mat4.create();return i.mat4.multiply(r,this.value,t.toFloat32Array()),new e(r,this.multiplicationType)}},{key:"multiplySelf",value:function(t){this.multiplicationType==e.MultiplicationType.PRE?this.preMultiplySelf(t):this.postMultiplySelf(t)}},{key:"preMultiplySelf",value:function(e){i.mat4.multiply(this.value,e.toFloat32Array(),this.value)}},{key:"postMultiplySelf",value:function(e){i.mat4.multiply(this.value,this.value,e.toFloat32Array())}},{key:"invert",value:function(){var t=i.mat4.create();return i.mat4.invert(t,this.value),new e(t,this.multiplicationType)}},{key:"invertSelf",value:function(){i.mat4.invert(this.value,this.value)}},{key:"decompose",value:function(){return{translate:{x:this.tx,y:this.ty},rotate:{angle:Math.atan2(this.b,this.a)},skew:{angleX:Math.tan(this.c),angleY:Math.tan(this.b)},scale:{x:Math.sqrt(this.a*this.a+this.c*this.c),y:Math.sqrt(this.d*this.d+this.b*this.b)},matrix:this.toJSON()}}},{key:"transformPoint",value:function(e){return Y.fromPoint(e).transform(this)}},{key:"toFloat32Array",value:function(){return this.value}},{key:"toJSON",value:function(){return{a:this.a,b:this.b,c:this.c,d:this.d,tx:this.tx,ty:this.ty}}},{key:"toString",value:function(e){if(e){var t=function(e){return((e<0?"":" ")+e.toPrecision(6)).substring(0,8)};return" Matrix 4x4\n"+"-".repeat(39)+"\n".concat(t(this.m11),", ").concat(t(this.m21),", ").concat(t(this.m31),", ").concat(t(this.m41))+"\n".concat(t(this.m12),", ").concat(t(this.m22),", ").concat(t(this.m32),", ").concat(t(this.m42))+"\n".concat(t(this.m13),", ").concat(t(this.m23),", ").concat(t(this.m33),", ").concat(t(this.m43))+"\n".concat(t(this.m14),", ").concat(t(this.m24),", ").concat(t(this.m34),", ").concat(t(this.m44))}return this.is2D?"matrix(".concat(this.a,", ").concat(this.b,", ").concat(this.c,", ").concat(this.d,", ").concat(this.tx,", ").concat(this.ty,")"):"matrix3d(".concat(this.m11,", ").concat(this.m12,", ").concat(this.m13,", ").concat(this.m14,", ").concat(this.m21,", ").concat(this.m22,", ").concat(this.m23,", ").concat(this.m24,", ").concat(this.m31,", ").concat(this.m32,", ").concat(this.m33,", ").concat(this.m34,", ").concat(this.m41,", ").concat(this.m42,", ").concat(this.m43,", ").concat(this.m44,")")}}],[{key:"fromString",value:function(t,r){var n=i.mat4.create();if("none"!=t){var o=t.substring(0,t.indexOf("("));t=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(/,\s*/g),"matrix3d"==o?(n[0]=parseFloat(t[0]),n[1]=parseFloat(t[1]),n[2]=parseFloat(t[2]),n[3]=parseFloat(t[3]),n[4]=parseFloat(t[4]),n[5]=parseFloat(t[5]),n[6]=parseFloat(t[6]),n[7]=parseFloat(t[7]),n[8]=parseFloat(t[8]),n[9]=parseFloat(t[9]),n[10]=parseFloat(t[10]),n[11]=parseFloat(t[11]),n[12]=parseFloat(t[12]),n[13]=parseFloat(t[13]),n[14]=parseFloat(t[14]),n[15]=parseFloat(t[15])):(n[q]=parseFloat(t[0]),n[Z]=parseFloat(t[1]),n[W]=parseFloat(t[2]),n[K]=parseFloat(t[3]),n[J]=parseFloat(t[4]),n[Q]=parseFloat(t[5]))}return new e(n,r)}},{key:"fromMatrix",value:function(t,r){if(!t)throw new Error("data not found, Matrix instance creation failed");if("function"==typeof t)throw new Error("data type function is not allowed");if(t instanceof e)return t;if(Array.isArray(t)&&(t=new Float32Array(t)),t instanceof Float32Array)return new e(t,r);if("string"==typeof t)return e.fromString(t,r);var n=i.mat4.create(),o=Object.assign({},t);return isFinite(t.a)&&(o.m11=t.a),isFinite(t.b)&&(o.m12=t.b),isFinite(t.c)&&(o.m21=t.c),isFinite(t.d)&&(o.m22=t.d),isFinite(t.tx)?o.m41=t.tx:isFinite(t.e)?o.m41=t.e:isFinite(t.dx)&&(o.m41=t.dx),isFinite(t.ty)?o.m42=t.ty:isFinite(t.f)?o.m42=t.f:isFinite(t.dy)&&(o.m42=t.dy),isFinite(o.m11)&&(n[0]=o.m11),isFinite(o.m12)&&(n[1]=o.m12),isFinite(o.m13)&&(n[2]=o.m13),isFinite(o.m14)&&(n[3]=o.m14),isFinite(o.m21)&&(n[4]=o.m21),isFinite(o.m22)&&(n[5]=o.m22),isFinite(o.m23)&&(n[6]=o.m23),isFinite(o.m24)&&(n[7]=o.m24),isFinite(o.m31)&&(n[8]=o.m31),isFinite(o.m32)&&(n[9]=o.m32),isFinite(o.m33)&&(n[10]=o.m33),isFinite(o.m34)&&(n[11]=o.m34),isFinite(o.m41)&&(n[12]=o.m41),isFinite(o.m42)&&(n[13]=o.m42),isFinite(o.m43)&&(n[14]=o.m43),isFinite(o.m44)&&(n[15]=o.m44),new e(n,r||t.multiplicationType)}},{key:"fromTranslate",value:function(t){var r=isFinite(t)?{tx:t,ty:t}:{tx:t.x,ty:t.y};return e.fromMatrix(r)}},{key:"fromRotate",value:function(t,r){var n=Math.sin(t),i=Math.cos(t),o={a:i,b:n,c:-n,d:i};return r&&(o.tx=r.x-r.x*i+r.y*n,o.ty=r.y-r.x*n-r.y*i),e.fromMatrix(o)}},{key:"fromScale",value:function(t,r){isFinite(t)&&(t={x:t,y:t});var n={a:t.x,d:t.y};return r&&(n.tx=r.x-r.x*t.x,n.ty=r.y-r.y*t.y),e.fromMatrix(n)}},{key:"fromPoints",value:function(t,r){if(!Array.isArray(t)||!Array.isArray(r))throw new Error("Expected input type Array requirement not satisfied");if(3!=t.length||3!=r.length)throw new Error("Expected input size 3 requirement not satisfied");var n=e.fromMatrix({m11:t[0].x,m21:t[1].x,m31:t[2].x,m12:t[0].y,m22:t[1].y,m32:t[2].y,m13:1,m23:1,m33:1}),i=e.fromMatrix({m11:r[0].x,m21:r[1].x,m31:r[2].x,m12:r[0].y,m22:r[1].y,m32:r[2].y,m13:1,m23:1,m33:1}),o=n.invert().preMultiply(i);return e.fromMatrix({a:o.m11,b:o.m12,c:o.m21,d:o.m22,tx:o.m31,ty:o.m32})}},{key:"multiply",value:function(t,r){var n=i.mat4.create();return i.mat4.multiply(n,t.value,r.value),new e(n)}}]),e}();function ee(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}$.MultiplicationType=Object.freeze({PRE:"PRE",POST:"POST"});var te=function(e){g(r,e);var t=ee(r);function r(e,n,i){var o;return h(this,r),(o=t.call(this,e,n,i)).red,o.green,o.blue,o.alpha,o.size,o.rotation,o.scaleX,o.scaleY,o.scaleZ,o.offsetX,o.offsetY,o.offsetZ,o.dX,o.dY,o}return d(r,[{key:"fill",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=n*e.length;e.forEach((function(e,n){return r.setProperty(e,t[i+n])}))}},{key:"getProperty",value:function(e){switch(e){case r.Property.X:return this.x;case r.Property.Y:return this.y;case r.Property.Z:return this.z;case r.Property.RED:return this.red;case r.Property.GREEN:return this.green;case r.Property.BLUE:return this.blue;case r.Property.ALPHA:return this.alpha;case r.Property.SIZE:return this.size;case r.Property.ROTATION:return this.rotation;case r.Property.SCALE_X:return this.scaleX;case r.Property.SCALE_Y:return this.scaleY;case r.Property.SCALE_Z:return this.scaleZ;case r.Property.OFFSET_X:return this.offsetX;case r.Property.OFFSET_Y:return this.offsetY;case r.Property.OFFSET_Z:return this.offsetZ;case r.Property.D_X:return this.dX;case r.Property.D_Y:return this.dY;default:throw console.warn(e),new Error("Invalid property found")}}},{key:"setProperty",value:function(e,t){r.setProperty(this,e,t)}},{key:"transform",value:function(e){if(!(e instanceof $))throw new Error("matrix is instance of ".concat(e.constructor.name," - it should be instance of Matrix. Use Matrix.fromMatrix method to convert."));var t=e.scaleX,n=e.rotation,i=V(E(r.prototype),"transform",this).call(this,e);this.x=i.x,this.y=i.y,this.z=i.z||0,this.size*=t,this.rotation+=n,this.scaleX*=t,this.scaleY*=t,this.scaleZ*=t,this.offsetX*=t,this.offsetY*=t,this.offsetZ*=t}},{key:"toArray",value:function(e){var t=this;return e.map((function(e){var r=t.getProperty(e);if(null==r||isNaN(r))throw new Error("Property ".concat(e.name," has invalid value ").concat(r));return r}))}},{key:"toJSON",value:function(){var e=this,t={};return r.Property.values.forEach((function(r){var n=e.getProperty(r);null!=n&&isFinite(n)&&(t[r.name]=e.getProperty(r))})),t}}],[{key:"createInstance",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=Object.clone(i),a=n*e.length;e.forEach((function(e,n){return r.setProperty(o,e,t[a+n])}));var s=new r(o.x,o.y,o.z);return s.red=o.red,s.green=o.green,s.blue=o.blue,s.alpha=o.alpha,s.size=o.size,s.rotation=o.rotation||0,s.scaleX=o.scaleX||1,s.scaleY=o.scaleY||1,s.scaleZ=o.scaleZ||1,s.offsetX=o.offsetX||0,s.offsetY=o.offsetY||0,s.offsetZ=o.offsetZ||0,s.dX=o.dX,s.dY=o.dY,s}},{key:"setProperty",value:function(e,t,n){switch(t){case r.Property.X:e.x=n;break;case r.Property.Y:e.y=n;break;case r.Property.Z:e.z=n;break;case r.Property.RED:e.red=n;break;case r.Property.GREEN:e.green=n;break;case r.Property.BLUE:e.blue=n;break;case r.Property.ALPHA:e.alpha=n;break;case r.Property.SIZE:e.size=n;break;case r.Property.ROTATION:e.rotation=n;break;case r.Property.SCALE_X:e.scaleX=n;break;case r.Property.SCALE_Y:e.scaleY=n;break;case r.Property.SCALE_Z:e.scaleZ=n;break;case r.Property.OFFSET_X:e.offsetX=n;break;case r.Property.OFFSET_Y:e.offsetY=n;break;case r.Property.OFFSET_Z:e.offsetZ=n;break;case r.Property.D_X:e.dX=n;break;case r.Property.D_Y:e.dY=n;break;default:throw console.warn(t),new Error("Invalid property found")}}}]),r}(Y);Object.defineEnum(te,"Property",["X","Y","Z","RED","GREEN","BLUE","ALPHA","SIZE","ROTATION","SCALE_X","SCALE_Y","SCALE_Z","OFFSET_X","OFFSET_Y","OFFSET_Z","D_X","D_Y"]);var re=function(){function e(t,r,n,i){h(this,e);var o=t,a=r,s=t+n,u=r+i;Object.defineProperties(this,{left:{value:o,enumerable:!0},x:{value:t,enumerable:!0},bottom:{value:a,enumerable:!0},y:{value:r,enumerable:!0},right:{value:s,enumerable:!0},top:{value:u,enumerable:!0},width:{value:n,enumerable:!0},height:{value:i,enumerable:!0}})}return d(e,[{key:"union",value:function(t){if(t&&!(t instanceof e))throw new TypeError("rect must be instance of RectGL");return t?e.ofEdges(Math.min(this.left,t.left),Math.min(this.bottom,t.bottom),Math.max(this.right,t.right),Math.max(this.top,t.top)):this}},{key:"intersect",value:function(t){if(t&&!(t instanceof e))throw new TypeError("rect must be instance of RectGL");if(!t)return null;var r=e.ofEdges(Math.max(this.left,t.left),Math.max(this.bottom,t.bottom),Math.min(this.right,t.right),Math.min(this.top,t.top));return r.width>0&&r.height>0?r:null}},{key:"ceil",value:function(){return e.ofEdges(Math.floor(this.left),Math.floor(this.bottom),Math.ceil(this.right),Math.ceil(this.top))}},{key:"floor",value:function(){return e.ofEdges(Math.ceil(this.left),Math.ceil(this.bottom),Math.floor(this.right),Math.floor(this.top))}},{key:"toQuad",value:function(e){var t;if(e){var r=Y.fromPoint({x:this.left,y:this.bottom}).transform(e),n=Y.fromPoint({x:this.right,y:this.bottom}).transform(e),o=Y.fromPoint({x:this.left,y:this.top}).transform(e),a=Y.fromPoint({x:this.right,y:this.top}).transform(e);t=i.quat2.fromValues(r.x,r.y,n.x,n.y,o.x,o.y,a.x,a.y)}else t=i.quat2.fromValues(this.left,this.bottom,this.right,this.bottom,this.left,this.top,this.right,this.top);return t}},{key:"toString",value:function(){return"gl-rect(".concat(this.x,", ").concat(this.y,", ").concat(this.width,", ").concat(this.height,")")}}],[{key:"ofEdges",value:function(t,r,n,i){return new e(t,r,n-t,i-r)}},{key:"calculateBrushGLSegmentBounds",value:function(t){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,o=[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}],a=.5*t.size,s=Math.abs(n*a);if(i){var u=new Y(t.x,t.y,t.x,t.z);r=u.transform(i)}else r=t;var l=r.x,c=r.y,h=t.scaleX*a,f=t.scaleY*a,d=t.offsetX,p=-t.offsetY,y=Math.cos(t.rotation),v=Math.sin(t.rotation),g=Number.MAX_SAFE_INTEGER,m=Number.MIN_SAFE_INTEGER,b=Number.MAX_SAFE_INTEGER,E=Number.MIN_SAFE_INTEGER;return o.forEach((function(e){e.x=e.x*h+d,e.y=e.y*f+p;var t=y*e.x+v*e.y+l,r=-v*e.x+y*e.y+c,n=t-s;g=Math.min(g,n),m=Math.max(m,n),n=t+s,g=Math.min(g,n),m=Math.max(m,n);var i=r-s;b=Math.min(b,i),E=Math.max(E,i),i=r+s,b=Math.min(b,i),E=Math.max(E,i)})),e.ofEdges(g,b,m,E)}}]),e}();Object.defineProperty(re,"SQURE",{value:Object.freeze([Object.freeze({x:-1,y:-1}),Object.freeze({x:1,y:-1}),Object.freeze({x:-1,y:1}),Object.freeze({x:1,y:1})]),enumerable:!0});var ne=function(){function e(t,r,n,i){h(this,e);var o=t,a=r,s=t+n,u=r+i,l={x:(o+s)/2,y:(a+u)/2};Object.defineProperties(this,{left:{value:o,enumerable:!0},top:{value:a,enumerable:!0},right:{value:s,enumerable:!0},bottom:{value:u,enumerable:!0},x:{value:t,enumerable:!0},y:{value:r,enumerable:!0},width:{value:n,enumerable:!0},height:{value:i,enumerable:!0},center:{value:l,enumerable:!0},size:{value:{width:n,height:i},enumerable:!0}})}return d(e,[{key:"union",value:function(t){return t?e.ofEdges(Math.min(this.left,t.left),Math.min(this.top,t.top),Math.max(this.right,t.right),Math.max(this.bottom,t.bottom)):this}},{key:"intersect",value:function(t){if(!t)return null;var r=e.ofEdges(Math.max(this.left,t.left),Math.max(this.top,t.top),Math.min(this.right,t.right),Math.min(this.bottom,t.bottom));return r.width>0&&r.height>0?r:null}},{key:"ceil",value:function(t){var r=Math.floor(this.left),n=Math.floor(this.top),i=Math.ceil(this.right),o=Math.ceil(this.bottom);if(t){var a=i-r,s=o-n;i=r+(a+=a%2),o=n+(s+=s%2)}return e.ofEdges(r,n,i,o)}},{key:"floor",value:function(t){var r=Math.ceil(this.left),n=Math.ceil(this.top),i=Math.floor(this.right),o=Math.floor(this.bottom);if(t){var a=i-r,s=o-n;i=r+(a-=a%2),o=n+(s-=s%2)}return e.ofEdges(r,n,i,o)}},{key:"contains",value:function(e){return this.left<=e.x&&this.right>=e.x&&this.top<=e.y&&this.bottom>=e.y}},{key:"transform",value:function(t){if(!t)return this;var r=Y.fromPoint({x:this.left,y:this.top}).transform(t),n=Y.fromPoint({x:this.right,y:this.top}).transform(t),i=Y.fromPoint({x:this.left,y:this.bottom}).transform(t),o=Y.fromPoint({x:this.right,y:this.bottom}).transform(t),a=Math.min(r.x,n.x,i.x,o.x),s=Math.min(r.y,n.y,i.y,o.y),u=Math.max(r.x,n.x,i.x,o.x),l=Math.max(r.y,n.y,i.y,o.y);return e.ofEdges(a,s,u,l)}},{key:"toPath",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:z.BLACK,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return{layout:[te.Property.X,te.Property.Y],size:t,color:e,ts:0,tf:1,points:[this.left,this.top,this.left,this.top,this.right,this.top,this.right,this.bottom,this.left,this.bottom,this.left,this.top,this.left,this.top]}}},{key:"toGLRect",value:function(){return new re(this.x,this.y,this.width,this.height)}},{key:"toString",value:function(){return"rect(".concat(this.x,", ").concat(this.y,", ").concat(this.width,", ").concat(this.height,")")}},{key:"toJSON",value:function(){return{x:this.left,y:this.top,width:this.width,height:this.height}}}],[{key:"fromGLRect",value:function(t){if(!t)return null;if(!(t instanceof re))throw new TypeError("rect must be instance of RectGL");return new e(t.left,t.bottom,t.width,t.height)}},{key:"isRect",value:function(e){return e&&isFinite(e.left)&&isFinite(e.top)&&isFinite(e.width)&&isFinite(e.height)}},{key:"fromRect",value:function(t){return new e(t.x,t.y,t.width,t.height)}},{key:"ofPolygon",value:function(t){return e.ofPolygons([t])}},{key:"ofPolygons",value:function(t){if(!t.length)return null;var r=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;return t.forEach((function(e){for(var t=0;t<e.length;t+=2){var a=e[t],s=e[t+1];r=Math.min(r,a),n=Math.min(n,s),i=Math.max(i,a),o=Math.max(o,s)}})),e.ofEdges(r,n,i,o)}},{key:"ofSpline",value:function(t,r){for(var n,i=0;i<t.length;i++)n=re.calculateBrushGLSegmentBounds(t.getPoint(i),r).union(n);return e.fromGLRect(n)}},{key:"ofEdges",value:function(t,r,n,i){return new e(t,r,n-t,i-r)}},{key:"union",value:function(e,t){return e?t?e.union(t):e:t}},{key:"intersect",value:function(e,t){return e&&t?e.intersect(t):null}}]),e}(),ie=function(){function e(t){var r=this;h(this,e),this.header=[],this.table=[],t.forEach((function(e){"string"==typeof e&&(e={name:e,title:e}),e.size=e.title.length,r.header.push(e)})),Object.defineProperty(this,"length",{get:function(){return r.table.length},enumerable:!0})}return d(e,[{key:"insert",value:function(e){this.table.push(e),this.header.forEach((function(t){var r=e[t.name];null!=r&&(t.size=Math.max(t.size,r.toString().length))}))}},{key:"build",value:function(){var e=this,t=[],r=this.header.length+1,n=[];return this.header.forEach((function(t){r+=t.size+2;var i=t.size-t.title.length,o=Math.floor(i/2),a=Math.ceil(i/2);n.push(e.getRepetedValue(o)+t.title+e.getRepetedValue(a))})),this.table.forEach((function(r){var n=[];e.header.forEach((function(t){var i=null==r[t.name]?"":r[t.name],o=t.size-i.toString().length;n.push(i+e.getRepetedValue(o))})),t.push(n)})),{delimiterLength:r,headerRow:n,content:t}}},{key:"getFormattedRow",value:function(e){var t="| ";return e.forEach((function(e){t+=e,t+=" | "})),t.trim()}},{key:"getRepetedValue",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:" ";return new Array(e+1).join(t)}},{key:"clear",value:function(){this.table.clear()}},{key:"toString",value:function(){var e=this,t="",r=this.build(),n=r.delimiterLength,i=r.headerRow,o=r.content;return t+=this.getRepetedValue(n,"="),t+="\n",t+=this.getFormattedRow(i),t+="\n",t+=this.getRepetedValue(n,"="),t+="\n",o.forEach((function(r){t+=e.getFormattedRow(r),t+="\n"})),t}}]),e}();function oe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}if("object"===("undefined"==typeof window?"undefined":c(window))&&"undefined"==typeof TouchEvent){var ae=function(e){g(r,e);var t=oe(r);function r(){return h(this,r),t.apply(this,arguments)}return r}(w(Event));window.TouchEvent=ae}var se={pointers:{mouse:["down","move","up"],touch:["start","move","end"]},inactive:[],open:function(e){if(!(e instanceof p))throw new Error("Argument doesn't implement InkController interface");this.inkController=e,this.canvas=e.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("touchcancel",this.abort,{passive:!0}),this.attachResize(),this.start()},reset:function(e){for(var t in this.pointers){var r=t==se.PointerType.TOUCH?{passive:!0}:void 0,n=t+this.pointers[t][0];this.canvas.removeEventListener(n,this.begin),e.canvas.surface.addEventListener(n,this.begin,r)}this.dettachResize(),this.inkController=e,this.canvas=e.canvas.surface,this.attachResize()},close:function(){this.stop(),this.dettachResize(),removeEventListener("touchcancel",this.abort),delete this.canvas,delete this.inkController},start:function(e){var t=e?y({},e,this.pointers[e]):this.pointers;for(e in e&&this.inactive.remove(e),this.inactive.forEach((function(e){return delete t[e]})),t)for(var r=e==se.PointerType.TOUCH?{passive:!0}:void 0,n=0;n<t[e].length;n++){var i=e+t[e][n];0==n?this.canvas.addEventListener(i,this.begin,r):addEventListener(i,2==n?this.end:this.move,r)}},stop:function(e){var t=e?y({},e,this.pointers[e]):this.pointers;for(e in e&&!this.inactive.includes(e)&&this.inactive.push(e),this.inactive.forEach((function(e){return delete t[e]})),e&&e!=se.PointerType.MOUSE||clearTimeout(this.timeoutID),t)for(var r=0;r<t[e].length;r++){var n=e+t[e][r];0==r?this.canvas.removeEventListener(n,this.begin):removeEventListener(n,2==r?this.end:this.move)}},attachResize:function(){var e,t,r;this.inkController.resize!=p.prototype.resize&&(this.resize=(e=this.inkController.resize.bind(this.inkController),t=200,r=null,function(){var n=this,i=arguments;clearTimeout(r),r=setTimeout((function(){e.apply(n,i)}),t)}),addEventListener("resize",this.resize))},dettachResize:function(){this.inkController.resize!=p.prototype.resize&&removeEventListener("resize",this.resize)},isInputAllowed:function(e){var t=this.provider;return(!e.type.endsWith("down")&&!e.type.endsWith("start")||(t||(t=this.getInputProvider(e)),!this.inactive.includes(t)))&&t==this.getInputProvider(e)},isInputExpected:function(e){var t=!1,r=e.changedTouches?Array.from(e.changedTouches).map((function(e){return e.identifier})):[],n=this.inkController.getInkBuilder(r);return n&&(t=e.type.endsWith("down")||e.type.endsWith("start")?!n.phase:!!n.phase),t},getSensorPoint:function(e){var t=void 0,r=e.changedTouches?Array.from(e.changedTouches).map((function(e){return e.identifier})):[],n=this.inkController.getInkBuilder(r);return n&&(t=this.createSensorPoint(e,n.pointerID)),t},createSensorPoint:function(e,t){var r=this.getOffset(e),n={x:r.x,y:r.y,z:void 0,timestamp:Math.floor(e.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,rotation:void 0},i={id:void 0,type:void 0,button:void 0,buttons:void 0};if(Object.defineProperty(n,"phase",{value:G.Phase[e.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),Object.defineProperty(n,"pointer",{value:i,enumerable:!0}),Object.defineProperty(n.pointer,"provider",{get:function(){return M.Type[this.type.toUpperCase()]},enumerable:!0}),e instanceof MouseEvent)i.type=se.PointerType.MOUSE,i.button=e.button,i.buttons=e.buttons;else{if(!(e instanceof TouchEvent))throw new Error("Unexpected event detected: ".concat(e.constructor.name,". Expected event should be instance of MouseEvent or TouchEvent."));if(isNaN(t))throw new Error("pointerID is required for touch event");if(!(e=Array.from(e.changedTouches).filter((function(e){return e.identifier==t})).first))return null;isNaN(n.x)&&(n.x=e.offsetX||e.clientX),isNaN(n.y)&&(n.y=e.offsetY||e.clientY),i.id=e.identifier,i.type=se.PointerType.TOUCH,n.pressure=e.force,n.radiusX=e.radiusX,n.radiusY=e.radiusY,n.rotation=Math.toRadians(e.rotationAngle)}return n},getOffset:function(e){if(e.changedTouches){var t=Array.from(e.changedTouches).map((function(e){return e.identifier})),r=this.inkController.getInkBuilder(t);e=r.pointerID!=e.changedTouches.item(0).identifier?Array.from(e.changedTouches).filter((function(e){return e.identifier==r.pointerID})).first:e.changedTouches.item(0)}var n=this.canvas.offsetParent;if(!n)return{x:0,y:0};"flex"==n.getStyle("display")&&(n=this.canvas);var i=this.inkController.transform,o=this.canvas.getStyle("transform");"none"==o?o=n.getStyle("transform"):n=this.canvas,o="none"==o?null:$.fromMatrix(o);var a=Y.fromPoint({x:e.clientX,y:e.clientY}),s=n.getBoundingClientRect();if(o){var u=o.invert();a=a.transform(u),s=ne.fromRect(s).transform(u)}var l={x:a.x-s.x,y:a.y-s.y};return i&&(l=Y.fromPoint(l).transform(i.invert())),l},getInputProvider:function(e){return e.type.replace(/down|start|move|up|end/g,"")},begin:function(e){if(this.logSampleInput(e),!(e instanceof MouseEvent&&0!=e.button)&&this.isInputAllowed(e)){if(e instanceof TouchEvent){var t=Array.from(e.changedTouches).map((function(e){return e.identifier}));this.inkController.registerInputProvider(t)}if(this.isInputExpected(e)){this.provider||(this.provider=this.getInputProvider(e));var r=this.getSensorPoint(e);r&&this.inkController.begin(r)}}},move:function(e){if(this.isInputAllowed(e)&&this.isInputExpected(e)){this.logSampleInput(e);var t=this.getSensorPoint(e);t&&this.inkController.move(t)}},end:function(e){var t=this;if(this.isInputAllowed(e)&&this.isInputExpected(e)){this.logSampleInput(e);var r=this.getSensorPoint(e);r&&(this.inkController.end(r),e instanceof MouseEvent||this.inactive.includes(se.PointerType.MOUSE)||(this.stop(se.PointerType.MOUSE),this.timeoutID=setTimeout((function(){return t.start(se.PointerType.MOUSE)}),500))),e.touches&&0!=e.touches.length||delete this.provider}},abort:function(e){if(delete this.provider,this.inkController.abort)if(e instanceof TouchEvent){var t=Array.from(e.changedTouches).map((function(e){return e.identifier}));this.inkController.abort(t)}else this.inkController.abort()},logSampleInput:function(e){if(this.debug){var t=e.type.endsWith("move"),r="mouseup"==e.type||"touchend"==e.type;t&&!this.debug.move||r&&!this.debug.end||(r&&this.table.length>0&&(console.log(this.table.toString()),this.table.clear()),this.table||(this.table=new ie(["type","id","pointerType","x","y","pressure","radius","rotation","timestamp"])),this.table.insert({type:e.type,id:e.changedTouches?e.changedTouches[0].identifier:void 0,pointerType:this.getInputProvider(e),x:e.changedTouches?e.changedTouches[0].clientX.toFixed(2):e.clientX,y:e.changedTouches?e.changedTouches[0].clientY.toFixed(2):e.clientY,pressure:e.changedTouches?e.changedTouches[0].force.toFixed(2):void 0,radius:e.changedTouches?e.changedTouches[0].radiusX.toFixed(2)+" / "+e.changedTouches[0].radiusY.toFixed(2):void 0,rotation:e.changedTouches?e.changedTouches[0].rotationAngle:e.twist,timestamp:e.timeStamp.toFixed(8)}),t||(console.log(this.table.toString()),this.table.clear()))}},PointerType:{MOUSE:"mouse",TOUCH:"touch"}},ue={longToByteArray:function(e){for(var t=[0,0,0,0,0,0,0,0],r=0;r<t.length;r++){var n=255&e;t[r]=n,e=(e-n)/256}return t},byteArrayToLong:function(e){for(var t=0,r=e.length-1;r>=0;r--)t=256*t+e[r];return t},crc32:function(){for(var e=new Uint32Array(256),t=256;t--;){for(var r=t,n=8;n--;)r=1&r?3988292384^r>>>1:r>>>1;e[t]=r}return function(t){for(var r=-1,n=0,i=t.length;n<i;n++)r=r>>>8^e[255&r^t[n]];return(-1^r)>>>0}}(),mapTo:function(e,t,r){return r.min+(ue.clamp(e,t)-t.min)/(t.max-t.min)*(r.max-r.min)},clamp:function(e,t){return Math.min(Math.max(e,t.min),t.max)},debounce:function(e,t){var r=null;return function(){var n=this,i=arguments;clearTimeout(r),r=setTimeout((function(){e.apply(n,i)}),t)}},comparator:function(){var e=Array.prototype.slice.call(arguments),t=function(e,t,r){var n="asc"===r?1:-1;return e>t?1*n:e<t?-1*n:0},r=function(e,t,r){return t.replace("[",".").replace("]","").split(".").forEach((function(t){return e=e[t]})),r?e.toLowerCase():e};return function(n,i){return e.map((function(e){return t(r(n,e.sortBy,e.ignoreCase),r(i,e.sortBy,e.ignoreCase),e.sortOrder)})).reduceRight((function(e,t){return t||e}))}},getPropName:function(e,t){var r=e.split("_"),n=r.first.toLowerCase();t&&(n=n.substring(0,1).toUpperCase()+n.substring(1));for(var i=1;i<r.length;i++)n+=r[i].substring(0,1),n+=r[i].substring(1).toLowerCase();return n},getEnumValueName:function(e){for(var t="",r=0;r<e.length;r++)r>0&&e[r]!=e[r].toLowerCase()&&(t+="_"),t+=e[r];return t.toUpperCase()}},le={inactive:[],open:function(e){if(!(e instanceof p))throw new Error("Argument doesn't implement InkController interface");this.inkController=e,this.canvas=e.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("pointercancel",this.abort),this.attachResize(),this.start()},reset:function(e){this.canvas.removeEventListener("pointerdown",this.begin),e.canvas.surface.addEventListener("pointerdown",this.begin),this.dettachResize(),this.inkController=e,this.canvas=e.canvas.surface,this.attachResize()},close:function(){this.stop(),this.dettachResize(),removeEventListener("pointercancel",this.abort),delete this.canvas,delete this.inkController},start:function(e){e?this.inactive.remove(e):(this.canvas.addEventListener("pointerdown",this.begin),addEventListener("pointermove",this.move),addEventListener("pointerup",this.end))},stop:function(e){e?this.inactive.includes(e)||this.inactive.push(e):(this.canvas.removeEventListener("pointerdown",this.begin),removeEventListener("pointermove",this.move),removeEventListener("pointerup",this.end))},attachResize:function(){this.inkController.resize!=p.prototype.resize&&(this.resize=ue.debounce(this.inkController.resize.bind(this.inkController),200),addEventListener("resize",this.resize))},dettachResize:function(){this.inkController.resize!=p.prototype.resize&&removeEventListener("resize",this.resize)},isInputAllowed:function(e){var t=this.provider;if("pointerdown"==e.type){if(t||(t=this.getInputProvider(e)),this.inactive.includes(t))return!1;if(t==le.PointerType.MOUSE){if(0!=e.button)return!1}else if(t==le.PointerType.PEN&&0==e.pressure)return!1}return!0},isInputExpected:function(e){var t=!1,r=this.inkController.getInkBuilder(e.pointerId);return r&&(t="pointerdown"==e.type?!r.phase:!!r.phase),t},getSensorPoint:function(e){var t=void 0,r=this.inkController.getInkBuilder(e.pointerId);if(r){if(e.pointerId!=r.pointerID)throw new Error("Create sensor point failed, expected pointer with id: ".concat(r.pointerID,", found: ").concat(e.pointerId));if("pointerdown"==e.type){var n=this.getInputProvider(e);e.pointerType!=n?r.pointerType=n:delete r.pointerType}t=this.createSensorPoint(e,r.pointerType)}return t},createSensorPoint:function(e,t,r){var n=this;if(!(e instanceof PointerEvent))throw new Error("Unexpected event detected: ".concat(e.constructor.name,". Expected event should be instance of PointerEvent."));var i,o=this.getOffset(e),a={x:o.x,y:o.y,z:void 0,timestamp:Math.floor(e.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,tiltX:void 0,tiltY:void 0,rotation:void 0};if(r?(Object.defineProperty(a,"phase",{value:r.phase,enumerable:!0}),i=r.pointer):(Object.defineProperty(a,"phase",{value:G.Phase[e.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),i={id:e.pointerId,type:t||e.pointerType,button:void 0,buttons:void 0},Object.defineProperty(i,"provider",{get:function(){return M.Type[this.type.toUpperCase()]},enumerable:!0}),"pen"!=i.type&&"mouse"!=i.type||(i.button=e.button,i.buttons=e.buttons)),Object.defineProperty(a,"pointer",{value:i,enumerable:!0}),"pen"!=i.type&&"touch"!=i.type||(a.pressure=e.pressure,a.rotation=Math.toRadians(e.twist)),"pen"==i.type?(a.tiltX=e.tiltX,a.tiltY=e.tiltY):"touch"==i.type&&(a.radiusX=e.width/2,a.radiusY=e.height/2),!r){if(e.getPredictedEvents){var s,u=e.getPredictedEvents();Object.defineProperty(a,"predicted",{get:function(){return s||(s=u.map((function(e){return n.createSensorPoint(e,t,a)}))),s},enumerable:!0})}if(e.getCoalescedEvents){var l,c=e.getCoalescedEvents();Object.defineProperty(a,"coalesced",{get:function(){return l||(l=c.map((function(e){return n.createSensorPoint(e,t,a)}))),l},enumerable:!0})}}return a},getOffset:function(e){var t=this.canvas.offsetParent;if(!t)return{x:0,y:0};"flex"==t.getStyle("display")&&(t=this.canvas);var r=this.inkController.transform,n=this.canvas.getStyle("transform");"none"==n?n=t.getStyle("transform"):t=this.canvas,n="none"==n?null:$.fromMatrix(n);var i=Y.fromPoint({x:e.clientX,y:e.clientY}),o=t.getBoundingClientRect();if(n){var a=n.invert();i=i.transform(a),o=ne.fromRect(o).transform(a)}var s={x:i.x-o.x,y:i.y-o.y};return r&&(s=Y.fromPoint(s).transform(r.invert())),s},getInputProvider:function(e){return e.pointerType==le.PointerType.MOUSE&&e.pressure>0&&.5!==e.pressure?le.PointerType.PEN:e.pointerType},begin:function(e){if(this.logSampleInput(e),this.isInputAllowed(e)&&(this.inkController.registerInputProvider(e.pointerId,e.isPrimary),this.isInputExpected(e))){this.provider||(this.provider=this.getInputProvider(e));var t=this.getSensorPoint(e);t&&this.inkController.begin(t)}},move:function(e){if(this.isInputAllowed(e)&&this.isInputExpected(e)){this.logSampleInput(e);var t=this.getSensorPoint(e);t&&this.inkController.move(t)}},end:function(e){if(this.isInputAllowed(e)&&this.isInputExpected(e)){this.logSampleInput(e);var t=this.getSensorPoint(e);t&&this.inkController.end(t),delete this.provider}},abort:function(e){delete this.provider,this.inkController.abort&&this.inkController.abort(e.pointerId)},logSampleInput:function(e){this.debug&&("pointermove"!=e.type||this.debug.move)&&("pointerup"!=e.type||this.debug.end)&&(e.pointerType!=this.getInputProvider(e)&&(e.pen=!0),"pointerup"==e.type&&this.table.length>0&&(console.log(this.table.toString()),this.table.clear()),this.table||(this.table=new ie(["type","id","pointerType","x","y","pressure","radius","tilt","rotation","timestamp"])),this.table.insert({type:e.type,id:e.pointerId,pointerType:e.pen?"".concat(e.pointerType," / pen"):e.pointerType,x:e.clientX.toFixed(2),y:e.clientY.toFixed(2),pressure:e.pressure.toFixed(2),radius:(e.width/2).toFixed(2)+" / "+(e.height/2).toFixed(2),rotation:e.twist,tilt:isFinite(e.tiltX)?e.tiltX+" / "+e.tiltY:"",timestamp:e.timeStamp.toFixed(8)}),"pointermove"!=e.type&&(console.log(this.table.toString()),this.table.clear()))},PointerType:{PEN:"pen",MOUSE:"mouse",TOUCH:"touch"}};"object"===("undefined"==typeof window?"undefined":c(window))&&"undefined"==typeof PointerEvent&&(le=se);var ce=le,he=l((function(e){var t=function(e){var t,r=Object.prototype,n=r.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var i=t&&t.prototype instanceof v?t:v,o=Object.create(i.prototype),a=new T(n||[]);return o._invoke=function(e,t,r){var n=h;return function(i,o){if(n===d)throw new Error("Generator is already running");if(n===p){if("throw"===i)throw o;return O()}for(r.method=i,r.arg=o;;){var a=r.delegate;if(a){var s=R(a,r);if(s){if(s===y)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===h)throw n=p,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=d;var u=c(e,t,r);if("normal"===u.type){if(n=r.done?p:f,u.arg===y)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n=p,r.method="throw",r.arg=u.arg)}}}(e,r,a),o}function c(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var h="suspendedStart",f="suspendedYield",d="executing",p="completed",y={};function v(){}function g(){}function m(){}var b={};b[o]=function(){return this};var E=Object.getPrototypeOf,x=E&&E(E(A([])));x&&x!==r&&n.call(x,o)&&(b=x);var P=m.prototype=v.prototype=Object.create(b);function k(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){function r(i,o,a,s){var u=c(e[i],e,o);if("throw"!==u.type){var l=u.arg,h=l.value;return h&&"object"==typeof h&&n.call(h,"__await")?t.resolve(h.__await).then((function(e){r("next",e,a,s)}),(function(e){r("throw",e,a,s)})):t.resolve(h).then((function(e){l.value=e,a(l)}),(function(e){return r("throw",e,a,s)}))}s(u.arg)}var i;this._invoke=function(e,n){function o(){return new t((function(t,i){r(e,n,t,i)}))}return i=i?i.then(o,o):o()}}function R(e,r){var n=e.iterator[r.method];if(n===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,R(e,r),"throw"===r.method))return y;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return y}var i=c(n,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var o=i.arg;return o?o.done?(r[e.resultName]=o.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function A(e){if(e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,a=function r(){for(;++i<e.length;)if(n.call(e,i))return r.value=e[i],r.done=!1,r;return r.value=t,r.done=!0,r};return a.next=a}}return{next:O}}function O(){return{value:t,done:!0}}return g.prototype=P.constructor=m,m.constructor=g,g.displayName=u(m,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,s,"GeneratorFunction")),e.prototype=Object.create(P),e},e.awrap=function(e){return{__await:e}},k(w.prototype),w.prototype[a]=function(){return this},e.AsyncIterator=w,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var a=new w(l(t,r,n,i),o);return e.isGeneratorFunction(r)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},k(P),u(P,s,"Generator"),P[o]=function(){return this},P.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=A,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(S),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function i(n,i){return s.type="throw",s.arg=e,r.next=n,i&&(r.method="next",r.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var u=n.call(a,"catchLoc"),l=n.call(a,"finallyLoc");if(u&&l){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,y):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),S(r),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;S(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:A(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}));function fe(e,t,r,n,i,o,a){try{var s=e[o](a),u=s.value}catch(e){return void r(e)}s.done?t(u):Promise.resolve(u).then(n,i)}var de=function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function a(e){fe(o,n,i,a,s,"next",e)}function s(e){fe(o,n,i,a,s,"throw",e)}a(void 0)}))}},pe=void 0;I.commonJS&&(pe=require("systeminformation"));var ye=pe;function ve(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var ge=function(e){g(n,e);var t,r=ve(n);function n(){var e;return h(this,n),(e=r.call(this)).props={},e}return d(n,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. Environment do not belongs to any InputContext yet");return["Environment",D.getMD5Tokens(this.props)]}}],[{key:"createInstance",value:(t=de(he.mark((function e(){var t,r,i,o=arguments;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=o.length>0&&void 0!==o[0]?o[0]:{},(r=new n).props["env.name"]=I.type.name,void 0!==ye){e.next=7;break}r.props["user.agent"]=navigator.userAgent,e.next=15;break;case 7:return e.next=9,ye.osInfo();case 9:i=e.sent,r.props["os.id"]=i.serial.toLowerCase(),r.props["os.name"]=i.codename,r.props["os.version"]=i.release,r.props["os.build"]=i.build,r.props["os.platform"]="".concat(i.distro," (").concat(i.platform," ").concat(i.arch,")");case 15:return Object.keys(t).forEach((function(e){return r.props[e]=t[e]})),e.abrupt("return",r);case 17:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})}]),n}(D),me=96/("undefined"==typeof window?1:window.devicePixelRatio),be={METER:{METER:1,CENTIMETER:100,MILLIMETER:1e3,MICROMETER:1e6,INCH:39.3700787402,POINT:2834.6456692913,PICA:236.2204724409,DIP:39.3700787402*me},CENTIMETER:{METER:.01,CENTIMETER:1,MILLIMETER:10,MICROMETER:1e4,INCH:.3937007874,POINT:28.3464566929,PICA:2.3622047244,DIP:.3937007874*me},MILLIMETER:{METER:.001,CENTIMETER:.1,MILLIMETER:1,MICROMETER:1e3,INCH:.0393700787,POINT:2.8346456693,PICA:.2362204724,DIP:.0393700787*me},MICROMETER:{METER:1e-6,CENTIMETER:1e-4,MILLIMETER:.001,MICROMETER:1,INCH:393701e-10,POINT:.0028346457,PICA:.0002362205,DIP:393701e-10*me},INCH:{METER:.0254,CENTIMETER:2.54,MILLIMETER:25.4,MICROMETER:25400,INCH:1,POINT:72,PICA:6,DIP:1*me},POINT:{METER:.0003527778,CENTIMETER:.0352777778,MILLIMETER:.3527777778,MICROMETER:352.7777777778,INCH:.0138888889,POINT:1,PICA:.0833333333,DIP:.0138888889*me},PICA:{METER:.0042333333,CENTIMETER:.4233333333,MILLIMETER:4.2333333333,MICROMETER:4233.3333333333,INCH:.1666666667,POINT:12,PICA:1,DIP:.1666666667*me},DIP:{METER:.0254/me,CENTIMETER:2.54/me,MILLIMETER:25.4/me,MICROMETER:25400/me,INCH:1/me,POINT:72/me,PICA:6/me,DIP:1},SECOND:{SECOND:1,MILLISECOND:1e3,MICROSECOND:1e6,NANOSECOND:1e9},MILLISECOND:{SECOND:.001,MILLISECOND:1,MICROSECOND:1e3,NANOSECOND:1e6},MICROSECOND:{SECOND:1e-6,MILLISECOND:.001,MICROSECOND:1,NANOSECOND:1e3},NANOSECOND:{SECOND:1e-9,MILLISECOND:1e-6,MICROSECOND:.001,NANOSECOND:1},RADIAN:{RADIAN:1,DEGREE:57.2957795},DEGREE:{RADIAN:.0174532925,DEGREE:1},NEWTON:{NEWTON:1}};Object.defineEnum(be,"Unit",["METER","CENTIMETER","MILLIMETER","MICROMETER","INCH","POINT","PICA","DIP","SECOND","MILLISECOND","MICROSECOND","NANOSECOND","RADIAN","DEGREE","NEWTON","NORMALIZED","LOGICAL"]),Object.defineEnum(be,"Metric",["LENGTH","TIME","FORCE","ANGLE","NORMALIZED","LOGICAL","DIMENSIONLESS"]);var Ee=Object.freeze({LENGTH:be.Unit.METER,TIME:be.Unit.SECOND,FORCE:be.Unit.NEWTON,ANGLE:be.Unit.RADIAN,NORMALIZED:be.Unit.NORMALIZED,LOGICAL:be.Unit.LOGICAL});function xe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}be.getChannelResolution=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=1,n=be.getUnitMetric(e);return n!=be.Metric.NORMALIZED&&n!=be.Metric.LOGICAL&&(r=be[Ee[n.name].name][e.name]/t),r},be.convert=function(e,t,r,n){return t?r*be[Ee[e.name].name][n.name]/t:r},be.convertAny=function(e,t,r,n){return e*be[t.name][r.name]/n},be.getUnitMetric=function(e){switch(e){case be.Unit.METER:case be.Unit.CENTIMETER:case be.Unit.MILLIMETER:case be.Unit.MICROMETER:case be.Unit.INCH:case be.Unit.POINT:case be.Unit.PICA:case be.Unit.DIP:return be.Metric.LENGTH;case be.Unit.SECOND:case be.Unit.MILLISECOND:case be.Unit.MICROSECOND:case be.Unit.NANOSECOND:return be.Metric.TIME;case be.Unit.RADIAN:case be.Unit.DEGREE:return be.Metric.ANGLE;case be.Unit.NEWTON:return be.Metric.FORCE;case be.Unit.NORMALIZED:return be.Metric.NORMALIZED;case be.Unit.LOGICAL:return be.Metric.LOGICAL;default:throw console.warn(e),new Error("Invalid unit found")}},be.getUnit=function(e){return Ee[e.name]},be.convertValue=function(e,t,r){return e*be[t.name][r.name]},Object.freeze(be);var Pe=function(e){g(r,e);var t=xe(r);function r(e,n,i,o,a){var s;if(h(this,r),s=t.call(this),n==r.Metric.DIMENSIONLESS)i=1;else if(isNaN(i)){var u=be.getUnit(n);i=be.getChannelResolution(u)}return s.type=e,s.metric=n,s.resolution=i,s.min=o,s.max=a,e==r.Type.TIMESTAMP?s.precision=0:s.precision=2,Object.defineProperty(m(s),"name",{get:function(){return ue.getEnumValueName(this.type.substring(this.type.lastIndexOf("/")+1))}}),s}return d(r,[{key:"getMD5Message",value:function(){if(!this.context)throw new Error("ID generation failed. This channel do not belongs to SensorChannelsContext yet");if(!Object.isFrozen(this.context)&&!Object.isFrozen(this))throw new Error("ID generation failed. Underlying SensorChannelsContext do not belongs to any SensorContext yet");var e=[];return e.push("SensorChannel"),e.push(this.context.inkProvider?this.context.inkProvider.id:""),e.push(this.context.device.id),e.push(this.type),e.push(this.metric.name),e.push(this.resolution.toFixed(4)),e.push((this.min||0).toFixed(4)),e.push((this.max||0).toFixed(4)),e.push(this.precision.toString()),e}}],[{key:"createCustomChannel",value:function(e,t,n,i,o,a){var s=new r(e,n,i,o,a);return s.precision=t,s}},{key:"createDefaultInstance",value:function(e,t){var n,i,o;switch(e){case r.Type.X:case r.Type.Y:case r.Type.Z:case r.Type.RADIUS_X:case r.Type.RADIUS_Y:n=be.Unit.DIP;break;case r.Type.TIMESTAMP:n=be.Unit.MILLISECOND;break;case r.Type.PRESSURE:n=be.Unit.NORMALIZED,i=0,o=1;break;case r.Type.ALTITUDE:case r.Type.AZIMUTH:case r.Type.ROTATION:n=be.Unit.RADIAN,i=0,o=2*Math.PI;break;default:console.error("SensorChannel: createDefaultInstance fails with ".concat(e," type"))}var a=be.getChannelResolution(n),s=new r(e,be.getUnitMetric(n),a,i,o);return s.unit=n,e!=r.Type.X&&e!=r.Type.Y||t.type!=M.Type.MOUSE||(s.precision=0),s}}]),r}(D);function ke(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}Pe.defaults=Object.freeze({PEN:["X","Y","TIMESTAMP","PRESSURE","ALTITUDE","AZIMUTH","ROTATION"],TOUCH:["X","Y","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ROTATION"],MOUSE:["X","Y","TIMESTAMP"]}),Pe.Type={X:"will://input/3.0/channel/X",Y:"will://input/3.0/channel/Y",Z:"will://input/3.0/channel/Z",TIMESTAMP:"will://input/3.0/channel/Timestamp",PRESSURE:"will://input/3.0/channel/Pressure",RADIUS_X:"will://input/3.0/channel/RadiusX",RADIUS_Y:"will://input/3.0/channel/RadiusY",ALTITUDE:"will://input/3.0/channel/Altitude",AZIMUTH:"will://input/3.0/channel/Azimuth",ROTATION:"will://input/3.0/channel/Rotation"},Pe.Metric=be.Metric;var we=function(e){g(r,e);var t=ke(r);function r(e,n){var i;h(this,r),(i=t.call(this)).device=e.freeze(),i.inkProvider=Object.freeze(n);var o,a,s=[];return Object.defineProperty(m(i),"channels",{get:function(){return s},set:function(e){var t=this;this.invalidateID(),s=[],e.forEach((function(e){return t.add(e)}))},enumerable:!0}),Object.defineProperty(m(i),"layout",{get:function(){return s.map((function(e){return e.name}))},set:function(e){this.invalidateID(),s=s.filter((function(t){return e.includes(t.name)}))},enumerable:!0}),Object.defineProperty(m(i),"samplingRate",{get:function(){return o},set:function(e){this.invalidateID(),o=e},enumerable:!0}),Object.defineProperty(m(i),"latency",{get:function(){return a},set:function(e){this.invalidateID(),a=e},enumerable:!0}),i}return d(r,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorChannelsContext do not belongs to any SensorContext yet");var e=["SensorChannelsContext"].concat(j(this.channels.map((function(e){return e.id}))));return e.push(this.samplingRate||""),e.push(this.latency||""),e.push(this.inkProvider?this.inkProvider.id:""),e.push(this.device.id),e}},{key:"add",value:function(e){if((e.type==Pe.Type.X||e.type==Pe.Type.Y)&&!this.inkProvider)throw new Error("inkProvider is not found. Required for ink group.");e.context=this,Object.freeze(e),this.channels.push(e)}},{key:"get",value:function(e){return this.channels.filter((function(t){return t.id==e})).first}}],[{key:"createDefaultInstance",value:function(e,t){var n=new r(e,t);return n.channels=Pe.defaults[t.type.name].map((function(e){return Pe.createDefaultInstance(Pe.Type[e],t)})),n}}]),r}(D);function Re(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Ie=function(e){g(r,e);var t=Re(r);function r(){var e;h(this,r),e=t.call(this);var n=[];return Object.defineProperty(m(e),"channelsContexts",{get:function(){return n},set:function(e){this.invalidateID(),n=e},enumerable:!0}),e}return d(r,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorContext do not belongs to any InputContext yet");return["SensorContext"].concat(j(this.channelsContexts.map((function(e){return e.id}))))}},{key:"addContext",value:function(e){if(!this.channelsContexts.includes(e)){if(this.channelsContexts.filter((function(t){return t.device==e.device})).length>0)throw new Error("Already exists channelsContext with device ".concat(e.device.id,". Device should be unique in scope of SensorContext."));e.inkProvider&&(this.inkChannelsContext=e),Object.freeze(e),this.channelsContexts.push(e)}}},{key:"getContext",value:function(e){return this.channelsContexts.filter((function(t){return t.id==e})).first}},{key:"getContextByChannelID",value:function(e){return this.channelsContexts.filter((function(t){return t.get(e)})).first}}],[{key:"createDefaultInstance",value:function(e,t){var n=new r;return n.addContext(we.createDefaultInstance(e,t)),n}}]),r}(D);function Se(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Te=function(e){g(r,e);var t=Se(r);function r(e,n){var i;return h(this,r),(i=t.call(this)).environment=Object.freeze(e),i.sensorContext=Object.freeze(n),i}return d(r,[{key:"getMD5Message",value:function(){return["InputContext",this.environment.id,this.sensorContext.id]}},{key:"addChannelsContext",value:function(e){this.sensorContext.addContext(e)}}],[{key:"createDefaultInstance",value:function(e,t,n){return new r(e,Ie.createDefaultInstance(t,n))}}]),r}(D);function Ae(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Oe=function(e){g(r,e);var t=Ae(r);function r(e){var n;return h(this,r),(n=t.call(this)).created=Date.now(),n.inkState=r.InkState.PLANE,n.context=e,n.streams=[],n}return d(r,[{key:"add",value:function(e){if(!this.context.sensorContext.getContextByChannelID(e.channels.first.id))throw new Error("SensorContext do not contains information about SensorChannelsContext corresponding with this stream");e.ink&&(this.inkStream=e),this.streams.push(e)}}]),r}(D);Object.defineEnum(Oe,"InkState",["PLANE","HOVERING","IN_VOLUME","VOLUME_HOVERING"]);var Ce=function(){function e(t){h(this,e),this.channels=t,this.data=[],this.ignoredIndex=[],Object.defineProperty(this,"layout",{value:t.map((function(e){return e.name})),enumerable:!0}),Object.defineProperty(this,"stride",{value:this.layout.length,enumerable:!0}),Object.defineProperty(this,"length",{get:function(){return this.data.length/this.stride},enumerable:!0}),this.ink=this.layout.includes("X")&&this.layout.includes("Y")}return d(e,[{key:"add",value:function(e,t){var r=this;t&&this.ignoredIndex.push(this.length),this.channels.forEach((function(t){var n=ue.getPropName(t.name),i=e[n];if(t.type==Pe.Type.ALTITUDE&&!("altitude"in e))throw new Error("SensorStream input data do not provides altitude");if(t.type==Pe.Type.AZIMUTH&&!("azimuth"in e))throw new Error("SensorStream input data do not provides azimuth");r.data.push(i)}))}},{key:"get",value:function(e){if(e>=this.length||e<0)throw new Error("Index ".concat(e," out of range - (0, ").concat(this.length-1,")"));for(var t={},r=0;r<this.stride;r++){var n=this.channels[r],i=ue.getPropName(n.name),o=e*this.stride;t[i]=this.data[o+r]}return t}},{key:"getPipelineMapping",value:function(){var e=[];if(this.ignoredIndex.length>0)for(var t=0;t<this.length;t++)this.ignoredIndex.includes(t)||e.push(t);return e}}]),e}();function De(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Ne,Me=function(e){g(n,e);var t,r=De(n);function n(){var e;return h(this,n),(e=r.call(this)).props={},e.devices=[],e}return d(n,[{key:"freeze",value:function(){return Object.freeze(this.props),this}},{key:"getMD5Message",value:function(){if(!Object.isFrozen(this.props)&&!Object.isFrozen(this))throw new Error("ID generation failed. InputDevice do not belongs to any SensorChannelsContext yet");return["InputDevice",D.getMD5Tokens(this.props)]}},{key:"link",value:function(e){this.devices.push(e)}},{key:"getInkInputProvider",value:function(e){return new M(e)}},{key:"getInkSensorContext",value:function(e){var t=this.getInkInputProvider(e);return Ie.createDefaultInstance(this,t)}},{key:"openStream",value:function(e){var t=this;if(!this.environment)throw new Error("Environment is not configured for current InputDevice instance");var r=M.Type[e.pointer.type.toUpperCase()],i=this.getInkSensorContext(r),o=new Te(this.environment,i);i.inkChannelsContext.layout=n.getLayout(e),this.sensorData=new Oe(o),this.sensorData.add(new Ce(i.inkChannelsContext.channels)),this.sampleTimestamp=e.timestamp,this.devices.forEach((function(e){return e.openStream(t.sensorData)}))}},{key:"add",value:function(e,t){if(!this.sensorData)throw new Error("Open ink stream not found");e.timestamp-=this.sampleTimestamp,this.sensorData.inkStream.add(e,t)}},{key:"closeStream",value:function(e){var t=this.sensorData;return this.devices.forEach((function(t){return t.closeStream(e)})),this.sensorData=null,this.sampleTimestamp=0,e?null:t}}],[{key:"getLayout",value:function(e){var t=[];return Object.keys(Pe.Type).forEach((function(r){var i,o=Pe.Type[r];i=o==Pe.Type.ALTITUDE?"tiltX":o==Pe.Type.AZIMUTH?"tiltY":ue.getPropName(r),n.isValidInput(i,e)&&t.push(r)})),t}},{key:"isValidInput",value:function(e,t){var r=!1;return isFinite(t[e])&&(r=!0,"pressure"==e?(r=t.pressure>0)&&t.pointer&&("mouse"==t.pointer.type?r=!1:"touch"==t.pointer.type&&(r=.5!==t.pressure&&1!==t.pressure)):"tiltX"==e||"tiltY"==e?r=0!=t.tiltX||0!=t.tiltY:"radiusX"==e||"radiusY"==e?r=t.radiusX!=t.radiusY||parseInt(t.radiusX)!=t.radiusX:"rotation"==e&&(r=0!=t.rotation)),r}},{key:"createInstance",value:(t=de(he.mark((function e(t){var r,n,i,o,a,s,u=arguments;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=k(this,j(Array.from(u).slice(1))),void 0!==ye){e.next=5;break}r.props["dev.graphics.resolution"]="".concat(screen.width,"x").concat(screen.height),e.next=22;break;case 5:return e.next=7,ye.system();case 7:return n=e.sent,e.next=10,ye.cpu();case 10:return i=e.sent,e.next=13,ye.graphics();case 13:o=e.sent,a=o.displays.filter((function(e){return e.main}))[0],s=o.controllers[0],r.props["dev.id"]=n.uuid.toLowerCase(),r.props["dev.manufacturer"]=n.manufacturer,r.props["dev.model"]=n.model,r.props["dev.cpu"]="".concat(i.manufacturer," ").concat(i.brand," ").concat(i.speed," - ").concat(i.cores," core(s)"),r.props["dev.graphics.display"]="".concat(a.model," ").concat(a.currentResX,"x").concat(a.currentResY," (").concat(a.pixeldepth," bit)"),r.props["dev.graphics.adapter"]="".concat(s.model," ").concat(s.vram," GB");case 22:return e.next=24,ge.createInstance(t);case 24:return r.environment=e.sent,e.abrupt("return",r);case 26:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),n}(D),Le=function(){function e(){h(this,e)}return d(e,null,[{key:"createCircle",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0};return e.createEllipse(t,r,r,n)}},{key:"createEllipse",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{x:0,y:0},i=[],o=2*Math.PI/e,a=0;a<e;a++){var s=a*o,u=t*Math.cos(s),l=r*Math.sin(s);i.push(n.x+u,n.y+l)}return i.toFloat32Array()}},{key:"createStar",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=[],n=1,i=2*Math.PI/e,o=0;o<e;o++){var a=o*i,s=n*Math.cos(a),u=n*Math.sin(a),l=t*Math.cos(a+i/2),c=t*Math.sin(a+i/2);r.push(s,u,l,c)}return r.toFloat32Array()}}]),e}(),_e=function(){function e(){if(h(this,e),Ne)throw new Error("URIResolver instance already available");Ne=this,this.init()}return d(e,[{key:"init",value:function(){throw new Error("URIResolver: init should be implemented")}},{key:"get",value:function(e){return this[e]}},{key:"register",value:function(e,t){this[e]=t}},{key:"resolve",value:function(e){var t;if(e.includes("?")){var r=this[e.split("?")[0]];if(r){var n=e.split("?")[1],i=[];n.split("&").forEach((function(e){var t=e.split("=")[1],r=parseFloat(t);isFinite(r)?t=r:"true"==t?t=!0:"false"==t&&(t=!1),i.push(t)})),t=function(){return r.apply(void 0,j(Array.from(arguments).concat(i)))}}}else t=this[e];if(!t)throw new Error("Failed to resolve ".concat(e));return t}}]),e}();Object.defineProperty(_e,"instance",{get:function(){return Ne},enumerable:!0});var Fe=function(){function e(){h(this,e)}return d(e,null,[{key:"encode",value:function(t){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.Encoding.AUTO;if(n==e.Encoding.AUTO&&(n="undefined"==typeof Buffer?e.Encoding.ARRAY:e.Encoding.BUFFER),n==e.Encoding.NONE)r=t;else if(n==e.Encoding.ARRAY)r=t.toArray();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to serialize. Please provide Buffer in global scope.");var i=Buffer.from(t.buffer);switch(n){case e.Encoding.BUFFER:r=i.toJSON();break;case e.Encoding.BASE64:r=i.toString("base64");break;default:throw new Error("Invalid encoding provided: ".concat(n.name))}}return{encoding:n.name,type:t.constructor.name,points:r}}},{key:"decode",value:function(t){var r,n=e.Encoding[t.encoding];if(n==e.Encoding.NONE)r=t.points;else if(n==e.Encoding.ARRAY)r=t.points.toFloat32Array();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to deserialize. Please provide Buffer in global scope.");var i;switch(n){case e.Encoding.BUFFER:i=Buffer.from(t.points);break;case e.Encoding.BASE64:i=Buffer.from(t.points,"base64");break;default:throw new Error("Invalid encoding provided: ".concat(n.name))}var o=new Uint8Array(i);r=new globalThis[t.type](o.buffer)}return r}},{key:"isTypedArrayData",value:function(e){return e&&e.encoding&&e.type&&e.type.endsWith("Array")}}]),e}();Object.defineEnum(Fe,"Encoding",["AUTO","NONE","ARRAY","BUFFER","BASE64"]);var Be=function(){function e(t,r){h(this,e),this.name=t,Object.defineProperty(this,"value",{get:function(){if(!r){if(!this.name)throw new Error("Resource descriptor identifier not found. Cannot resolve resource content.");if("function"==typeof this.resolve&&(r=this.resolve(this.name)),!r){if(!_e.instance)throw new Error("Resource URI ".concat(this.name," cannot be resolved. URIResolver not implemented yet. Please implement and instantiate."));r=_e.instance.resolve(this.name)}if(!r)throw new Error("Resource URI ".concat(this.name," cannot be resolved. Please provide resource definition in URIResolver init implementation."))}return r},set:function(e){r=e},enumerable:!0})}return d(e,[{key:"toJSON",value:function(){var e=this.value;return ArrayBuffer.isTypedArray(e)?e=Fe.encode(e,this.encoding):"function"==typeof e&&(e=e()),{name:this.name,value:e}}}],[{key:"fromJSON",value:function(t){var r=t.value;return Fe.isTypedArrayData(r)&&(r=Fe.decode(r)),new e(t.name,r)}},{key:"getInstance",value:function(t,r){return new e(r,t)}}]),e}(),Ue=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;h(this,e),this.size=r,Object.defineProperty(this,"descriptor",{value:{shape:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){return t||("function"==typeof(t=this.descriptor.shape.value)&&(t=t()),e.fitShape(t)),t},set:function(r){var n=this;if(!r)throw new Error("BrushPrototype: shape not found");Array.isArray(r)&&(r=r.toFloat32Array()),"string"==typeof r?r=new Be(r):r instanceof Float32Array?r=Be.getInstance(r):r instanceof Be||(r=new Be(r.name,r.value)),t=null,this.descriptor.shape=r,this.descriptor.shape.resolve=e.resolve,Object.defineProperty(this.descriptor.shape,"encoding",{get:function(){return n.encoding},enumerable:!0})},enumerable:!0}),this.shape=t}return d(e,[{key:"toJSON",value:function(){return{shape:this.descriptor.shape.toJSON(),size:this.size}}}],[{key:"fromJSON",value:function(t){return new e(Be.fromJSON(t.shape),t.size)}},{key:"create",value:function(t){for(var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=t,o=arguments.length,a=new Array(o>2?o-2:0),s=2;s<o;s++)a[s-2]=arguments[s];switch(t){case e.Type.CIRCLE:r=Le.createCircle.apply(Le,a),i+="?precision=".concat(a[0]||"","&radius=").concat(a[1]||"");break;case e.Type.ELLIPSE:r=Le.createEllipse.apply(Le,a),i+="?precision=".concat(a[0]||"","&radiusX=").concat(a[1]||"","&radiusY=").concat(a[2]||"");break;case e.Type.STAR:r=Le.createStar.apply(Le,a),i+="?points=".concat(a[0]||"","&internalRadius=").concat(a[1]||"");break;default:console.error("Brush2D: createShape fails with ".concat(t," type"))}return new e({name:i,shape:r},n)}},{key:"resolve",value:function(t){var r,n=t.split("?"),i=n.first;if(Object.values(e.Type).includes(i)){var o=n.last.split("&"),a={};switch(o.forEach((function(e){a[e.substring(0,e.indexOf("="))]=e.substring(e.indexOf("=")+1)})),i){case e.Type.CIRCLE:var s=a.precision?parseInt(a.precision):void 0;r=Le.createCircle(s);break;case e.Type.ELLIPSE:var u=a.precision?parseInt(a.precision):void 0,l=a.radiusX?parseFloat(a.radiusX):void 0,c=a.radiusY?parseFloat(a.radiusY):void 0;r=Le.createEllipse(u,l,c);break;case e.Type.STAR:var h=a.points?parseInt(a.points):void 0,f=a.internalRadius?parseFloat(a.internalRadius):void 0;r=Le.createStar(h,f);break;default:console.error("Brush2D: createShape fails with ".concat(i," type"))}}return r}},{key:"fitShape",value:function(t){e.centerShape(t);for(var r=ne.ofEdges(-1,-1,1,1),n=ne.ofPolygon(t),i=r.width/n.width,o=r.height/n.height,a=i>0&&o>0?Math.min(i,o):Math.max(i,o),s=0;s<t.length;s+=2)t[s]*=a,t[s+1]*=a}},{key:"centerShape",value:function(e){for(var t=ne.ofPolygon(e),r=0;r<e.length;r+=2)e[r]-=t.center.x,e[r+1]-=t.center.y}}]),e}();function je(e){return Ge.apply(this,arguments)}function Ge(){return(Ge=de(he.mark((function e(t){var r,n,i,o,a,s,u=arguments;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>1&&void 0!==u[1]?u[1]:"binary",n=u.length>2&&void 0!==u[2]?u[2]:{},!(t instanceof Uint8Array)){e.next=4;break}return e.abrupt("return",t);case 4:return e.next=6,fetch(t,Object.assign({mode:"no-cors"},n));case 6:if(o=e.sent,"json"!=r){e.next=13;break}return e.next=10,o.json();case 10:i=e.sent,e.next=36;break;case 13:if("text"!=r){e.next=19;break}return e.next=16,o.text();case 16:i=e.sent,e.next=36;break;case 19:if("binary"!=r){e.next=26;break}return e.next=22,o.arrayBuffer();case 22:a=e.sent,i=new Uint8Array(a),e.next=36;break;case 26:return e.next=28,o.blob();case 28:if(s=e.sent,"base64"!=r){e.next=35;break}return e.next=32,Ye(s);case 32:i=e.sent,e.next=36;break;case 35:i=s;case 36:return e.abrupt("return",i);case 37:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ye(e){return new Promise((function(t,r){var n=new FileReader;n.readAsDataURL(e),n.onloadend=function(){return t(n.result)},n.onerror=r}))}function ze(e){return new Promise((function(t,r){var n,i=new Image;i.crossOrigin="anonymous",i.onload=function(){if(I.type2D==I.Type2D.OFFSCREEN){var e=new OffscreenCanvas(i.width,i.height);e.getContext("2d").drawImage(i,0,0),t(e)}else n&&URL.revokeObjectURL(n),t(i)},i.onerror=r,"string"==typeof e?i.src=e:I.type2D==I.Type2D.OFFSCREEN?e instanceof Uint8Array?i.src=Buffer.from(e):e instanceof OffscreenCanvas?t(e):i.src=e:(e instanceof Uint8Array&&(e.byteLength!=e.buffer.byteLength&&(e=e.slice()),e=e.buffer),e instanceof ArrayBuffer&&(e=new Blob([e],{type:"image/png"})),n=URL.createObjectURL(e),i.src=n)}))}function Xe(e){return Ve.apply(this,arguments)}function Ve(){return(Ve=de(he.mark((function e(t){var r;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"!=typeof t&&"undefined"!=typeof createImageBitmap){e.next=6;break}return e.next=3,ze(t);case 3:r=e.sent,e.next=15;break;case 6:if(!(t instanceof ArrayBuffer||t instanceof Uint8Array)){e.next=12;break}return e.next=9,createImageBitmap(new Blob([t],{type:"image/png"}));case 9:r=e.sent,e.next=15;break;case 12:return e.next=14,createImageBitmap(t);case 14:r=e.sent;case 15:return e.abrupt("return",r);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}Ue.Type={ELLIPSE:"will://brush/3.0/shape/Ellipse",CIRCLE:"will://brush/3.0/shape/Circle",STAR:"will://brush/3.0/shape/Star"};var He=Object.freeze({__proto__:null,loadFile:je,loadImage:Xe,saveAs:function(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"application/octet-stream";if(e instanceof Blob)r=URL.createObjectURL(e);else{var i;e instanceof ArrayBuffer?i=[e]:e.buffer?(e.byteLength<e.buffer.byteLength&&(e=new Uint8Array(e)),i=[e.buffer]):e instanceof Array&&(i=e);var o=new Blob(i,{type:n});r=URL.createObjectURL(o)}var a=document.createElement("a");a.href=r,a.download=t,a.appendChild(document.createTextNode(t)),a.style.display="none",document.body.appendChild(a),a.click(),setTimeout((function(){URL.revokeObjectURL(r),a.remove()}),911)}});function qe(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Ze(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Ze(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Ze(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var We=function(){function e(t,r,n){var i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;h(this,e),isFinite(n)&&(o=n,n=void 0),o<=0&&(console.warn("Invalid spacing found ".concat(o,". It should be positive number.")),o=1),this.name=t,Object.defineProperty(this,"shape",{get:function(){return r},set:function(e){if(e instanceof Float32Array&&(e=new Ue(e)),!this.validate(e))throw console.warn(e),new Error("Brush2D: Invalid shape found");Array.isArray(e)&&(1==e.length?e=e.first:e.sort(ue.comparator({sortBy:"size",sortOrder:"asc"}))),r=e},enumerable:!0}),this.shape=r,this.fill=n,this.spacing=o,Object.defineProperty(this,"encoding",{get:function(){return i},set:function(e){if(Array.isArray(this.shape)){var t,r=qe(this.shape);try{for(r.s();!(t=r.n()).done;){t.value.encoding=e}}catch(e){r.e(e)}finally{r.f()}}else this.shape.encoding=e},enumerable:!0})}var t;return d(e,[{key:"validate",value:function(e){var t=!1;if(Array.isArray(e)){var r,n=qe(e);try{for(n.s();!(r=n.n()).done;){if(!(t=r.value instanceof Ue))break}}catch(e){n.e(e)}finally{n.f()}}else t=e instanceof Ue;return t}},{key:"configure",value:(t=de(he.mark((function e(t){var r;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.pattern&&this.fill){e.next=2;break}return e.abrupt("return");case 2:if(t instanceof CanvasRenderingContext2D||t instanceof OffscreenCanvasRenderingContext2D){e.next=4;break}throw new Error("ctx is not instance of CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D");case 4:return e.next=6,Xe(this.fill);case 6:r=e.sent,this.pattern=t.createPattern(r,"repeat");case 8:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"selectShape",value:function(e){var t;if(Array.isArray(this.shape)){for(var r=1;r<this.shape.length;r++)if(this.shape[r].size>e){t=this.shape[r-1];break}t||(t=this.shape.last)}else t=this.shape;return t.shape}},{key:"toJSON",value:function(){var e=Array.isArray(this.shape)?this.shape:[this.shape];return{type:"Brush2D",name:this.name,spacing:this.spacing,shape:e.map((function(e){return e.toJSON()}))}}}],[{key:"fromJSON",value:function(t){var r=1==t.shape.length?Ue.fromJSON(t.shape[0]):t.shape.map((function(e){return Ue.fromJSON(e)}));return new e(t.name,r,t.spacing)}}]),e}(),Ke=function(){function e(){h(this,e),this.state={}}return d(e,null,[{key:"excludedProps",get:function(){return[te.Property.D_X,te.Property.D_Y]}},{key:"posProps",get:function(){return[te.Property.X,te.Property.Y,te.Property.Z]}},{key:"colorProps",get:function(){return[te.Property.RED,te.Property.GREEN,te.Property.BLUE,te.Property.ALPHA]}},{key:"transformProps",get:function(){return[te.Property.ROTATION,te.Property.SCALE_X,te.Property.SCALE_Y,te.Property.SCALE_Z,te.Property.OFFSET_X,te.Property.OFFSET_Y,te.Property.OFFSET_Z]}}]),d(e,[{key:"isLayoutPart",value:function(t){if(e.posProps.includes(t))return this.inputLayout.includes(t.name);if(this.brush instanceof We&&e.colorProps.includes(t))return!1;if(e.excludedProps.includes(t))return!1;if(e.transformProps.includes(t))return!1;var r=!1,n=ue.getPropName(t.name),i=this.dynamics[n];if(i&&!i.disabled)if(i.dependencies&&i.dependencies.length>0){var o=this.inputLayout.map((function(e){return Pe.Type[e]}));r=i.dependencies.filter((function(e){return o.includes(e)})).length>0}else r=!0;return r}},{key:"calculate",value:function(t,r,n){var i=this;for(var o in this.point=r.createPathPoint(),this.statics)this.point[o]=this.statics[o];return this.calculateProperty(te.Property.SIZE,t,r,n),e.colorProps.forEach((function(e){return i.calculateProperty(e,t,r,n)})),e.transformProps.forEach((function(e){return i.calculateTransform(e,t,r,n)})),this.point}},{key:"calculateProperty",value:function(t,r,n,i){if(this.layout.includes(t)){var o,a=ue.getPropName(t.name),s=this.dynamics[a],u=this.state[a];if("function"==typeof u.resolve)o=u.resolve(r,n,i);else if(this.inputLayout.includes("PRESSURE")){var l=n.pressure||r.pressure/2;o=e.mapTo(l,u.pressure,s.value)}else{var c=n.speed(r,i);o=e.mapTo(c,u.velocity,s.value)}this.point[ue.getPropName(t.name)]=o}}},{key:"calculateTransform",value:function(t,r,n,i){if(this.layout.includes(t)){var o,a=ue.getPropName(t.name),s=this.dynamics[a],u=this.state[a];if("function"==typeof u.resolve)o=u.resolve(r,n,i);else{var l=s.dependencies||[];if(t==te.Property.ROTATION)if(l.includes(Pe.Type.ROTATION)&&this.inputLayout.includes("ROTATION"))o=n.rotation;else{if(!l.includes(Pe.Type.AZIMUTH)||!this.inputLayout.includes("AZIMUTH"))throw new Error("Property ".concat(t.name," is not configured properly. Dependencies are expected or resolve handler."));o=n.computeNearestAzimuthAngle(r)}else if(l.includes(Pe.Type.ALTITUDE)&&this.inputLayout.includes("ALTITUDE")){n.cosAltitude||(n.cosAltitude=Math.cos(n.altitude));var c=n.cosAltitude;o=e.mapTo(c,u.altitude,s.value)}else{if(t!=te.Property.SCALE_X&&t!=te.Property.SCALE_Y||!l.includes(Pe.Type.RADIUS_X)&&!l.includes(Pe.Type.RADIUS_Y)||!this.inputLayout.includes("RADIUS_X")||!this.inputLayout.includes("RADIUS_Y"))throw new Error("Property ".concat(t.name," is not configured properly. Dependencies are expected or resolve handler."));var h=t==te.Property.SCALE_X?"radiusX":"radiusY",f=n[h];o=e.mapTo(f,u[h],s.value)}}if(isNaN(o))throw new Error("Property ".concat(t.name," has no value"));this.point[ue.getPropName(t.name)]=o}}},{key:"reset",value:function(t,r,n){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(this.brush=r,this.dynamics=o,this.statics={},this.color=new z(0,0,0),this.inputLayout=Me.getLayout(t),this.layout=te.Property.values.filter((function(e){return i.isLayoutPart(e)})),this.debug&&console.log(t.pointer.type,this.inputLayout,this.layout.map((function(e){return e.name})),t),"size"in a){if(this.isLayoutPart(te.Property.SIZE))throw new Error("Size should exist only in dynamics or statics");this.statics.size=a.size}else{if(!this.isLayoutPart(te.Property.SIZE))throw new Error("Size not found. Should be set through dynamics or statics.");if(0==t.pressure&&"pen"==t.pointer.type)throw new Error("Hover point detected. Should be handeled manually.")}e.colorProps.forEach((function(e){var t=ue.getPropName(e.name);i.isLayoutPart(e)?i.color[t]=n[t]:(i.statics[t]=isFinite(a[t])?a[t]:n[t],i.color[t]=i.statics[t])})),e.transformProps.forEach((function(e){if(!i.isLayoutPart(e)){var t=ue.getPropName(e.name);isFinite(a[t])&&(i.statics[t]=a[t])}})),this.resetState(t)}},{key:"resetState",value:function(t){var r=this;this.state={},[te.Property.SIZE].concat(e.colorProps).forEach((function(t){if(r.layout.includes(t)){var n=ue.getPropName(t.name),i=r.dynamics[n],o={};if(i.resolve)o.resolve=e.resolveAction(i.resolve);else{if(!i.value)throw new Error("PathPointContext: dynamics ".concat(n," value property not found"));if(i.value.min>i.value.max)throw new Error("PathPointContext: dynamics ".concat(n," invalid value range found: ").concat(i.value.min," - ").concat(i.value.max));var a=r.clonePropertySettings(i.velocity,0,4e3);a.remap=e.resolveAction(a.remap||i.value.remap);var s=r.clonePropertySettings(i.pressure,0,1);s.remap=e.resolveAction(s.remap||i.value.remap),o.velocity=e.validateRange(n,a,{min:0,max:3e4}),o.pressure=e.validateRange(n,s,{min:0,max:1})}r.state[n]=o}})),e.transformProps.forEach((function(n){if(r.layout.includes(n)){var i=ue.getPropName(n.name),o=r.dynamics[i],a={};if(o.resolve)a.resolve=e.resolveAction(o.resolve);else if(o.dependencies){if(o.dependencies.includes(Pe.Type.ALTITUDE)){if(!o.value)throw new Error("PathPointContext: dynamics ".concat(i," value property not found"));if(o.value.min>o.value.max)throw new Error("PathPointContext: dynamics ".concat(i," invalid value range found: ").concat(o.value.min," - ").concat(o.value.max));var s=r.clonePropertySettings(o.altitude,0,Math.PI/2);s.remap=e.resolveAction(s.remap||o.value.remap),a.altitude=e.validateRange(i,s,{min:0,max:Math.PI/2})}if(n==te.Property.SCALE_X&&o.dependencies.includes(Pe.Type.RADIUS_X)||n==te.Property.SCALE_Y&&o.dependencies.includes(Pe.Type.RADIUS_Y)){if(!o.value)throw new Error("PathPointContext: dynamics ".concat(i," value property not found"));var u=n==te.Property.SCALE_X?"radiusX":"radiusY",l=t[u]<=1?0:1,c=t[u]<=1?1:50,h=t[u]<=1?{min:0,max:1,remap:o[u].remap}:o[u],f=r.clonePropertySettings(h,l,c);f.remap=e.resolveAction(f.remap||o.value.remap),a[u]=e.validateRange(i,f,{min:l,max:c})}}r.state[i]=a}}))}},{key:"clonePropertySettings",value:function(e,t,r){var n;return e?("min"in(n=Object.clone(e))||(n.min=t),"max"in n||(n.max=r)):n={min:t,max:r},n}}],[{key:"resolveAction",value:function(e){if(e)return"string"==typeof e?e=new Be(e):"function"==typeof e?e=Be.getInstance(e):e instanceof Be||(e=new Be(e.name,e.value)),e.value}},{key:"validateRange",value:function(e,t,r){if(t.min<r.min||t.max>r.max)throw new Error("".concat(e," config is out of range - (").concat(t.min,", ").concat(t.max,"), expected values interval - (").concat(r.min,", ").concat(r.max,")"));if(t.min>t.max)throw new Error("".concat(e," min ").concat(t.min," exceeds max ").concat(t.max));return t}},{key:"mapTo",value:function(e,t,r){var n=(ue.clamp(e,t)-t.min)/(t.max-t.min);return t.remap&&(n=t.remap(n)),r.min+n*(r.max-r.min)}}]),e}(),Je=function(){function e(){h(this,e),this.path=[],this.firstSegment=!1,this.lastSegment=!0;var t=!1;Object.defineProperty(this,"keepAllData",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),e.OutputType.ALL_DATA)},enumerable:!0})}return d(e,[{key:"add",value:function(t,r,n,i){var o;if(t&&!this.lastSegment)throw new Error("Cannot start new segment before the previous is ended");this.debug&&console.log(this.constructor.name,t,r),this.firstSegment=t,this.lastSegment=r;var a=this.addImpl(n,i);return this.keepAllData&&(o=this.path).push.apply(o,j(a.added)),{added:this.getOutput(a.added,e.OutputType.ADDITION),predicted:this.getOutput(a.predicted,e.OutputType.PREDICTION)}}},{key:"get",value:function(t){this.reset(),this.firstSegment=!0,this.lastSegment=!0;var r=this.getImpl(t,e.OutputType.PROCESSOR);return this.getOutput(r,e.OutputType.PROCESSOR)}},{key:"addImpl",value:function(e,t){throw new Error("Abstract method addImpl of DataSequenceProcessor should be implemented")}},{key:"getImpl",value:function(e){throw new Error("Abstract method getImpl of DataSequenceProcessor should be implemented")}},{key:"getOutput",value:function(e,t){return e}},{key:"reset",value:function(){this.path.clear(),this.firstSegment=!1,this.lastSegment=!0}}]),e}();Object.defineEnum(Je,"OutputType",["ADDITION","PREDICTION","ALL_DATA","PROCESSOR"]);var Qe=I.commonJS?require("clipper-lib"):globalThis.ClipperLib,$e=Qe.Clipper,et=Qe.Paths,tt=Qe.Path,rt=Qe.ClipType,nt=Qe.PolyType,it=Qe.PolyFillType,ot=65534,at=function(){function e(t){h(this,e);var r=new et;"number"==typeof t[0]&&(t=[t]);var n=ne.ofPolygons(t),i=ot/(n.width+1e-16),o=ot/(n.height+1e-16),a=Math.floor(Math.min(i,o)),s=n.left+32767/a,u=n.top+32767/a;t.forEach((function(e){for(var t=new tt,n=0;n<e.length;n+=2){var i=(e[n]-s)*a,o=(e[n+1]-u)*a,l=i<0?Math.ceil(i):Math.floor(i),c=o<0?Math.ceil(o):Math.floor(o);t.push({X:l,Y:c})}r.push(t)})),this.subject=r,this.solution=new et,this.bounds=n,this.transform={scale:a,offsetX:s,offsetY:u},this.filter=new Set}return d(e,[{key:"toPath2D",value:function(e){var t=this,r=[];return this.lastPoint={},this.lastSize=0,this.solution.forEach((function(n){var i=t.flatPath(n,e);i.length>0&&r.push(i)})),this.filter.clear(),r}},{key:"flatPath",value:function(e,t){var r=this,n=[];return e.forEach((function(e,i){t?(r.filter.add("".concat(e.X,"-").concat(e.Y)),r.filter.size>r.lastSize?(n.push(e.X/r.transform.scale+r.transform.offsetX,e.Y/r.transform.scale+r.transform.offsetY),r.lastSize++):r.debug&&console.warn("Duplicate point detected: {".concat(e.X,", ").concat(e.Y,"}"))):r.lastPoint.X!=e.X||r.lastPoint.Y!=e.Y?(n.push(e.X/r.transform.scale+r.transform.offsetX,e.Y/r.transform.scale+r.transform.offsetY),r.lastPoint=e):r.debug&&console.warn("Duplicate point detected: {".concat(e.X,", ").concat(e.Y,"}"))})),n.length<6&&(this.debug&&console.warn("Invalid contour found: [".concat(n.join(", "),"]")),n.clear()),n}},{key:"apply",value:function(e){var t=this,r=new et;return"number"==typeof e[0]&&(e=[e]),e.forEach((function(e){for(var n=new tt,i=0;i<e.length;i+=2){var o=(e[i]-t.transform.offsetX)*t.transform.scale,a=(e[i+1]-t.transform.offsetY)*t.transform.scale,s=o<0?Math.ceil(o):Math.floor(o),u=a<0?Math.ceil(a):Math.floor(a);n.push({X:s,Y:u})}r.push(n)})),r}}]),e}(),st=function(){function e(){h(this,e)}return d(e,null,[{key:"union",value:function(e,t){var r=new at(e),n=new $e;return n.StrictlySimple=!0,n.AddPaths(r.subject,nt.ptSubject,!0),n.Execute(rt.ctUnion,r.solution,it.pftNonZero,it.pftNonZero),r.toPath2D(t)}},{key:"intersection",value:function(e,t){e instanceof at||(e=new at(e)),e.clip=e.apply(t);var r=new $e;return r.StrictlySimple=!0,r.AddPaths(e.subject,nt.ptSubject,!0),r.AddPaths(e.clip,nt.ptClip,!0),r.Execute(rt.ctIntersection,e.solution,it.pftNonZero,it.pftNonZero),e.solution.length>0?e:null}},{key:"createClipperPath",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32,r=new tt;r.scale=t;for(var n=0;n<e.length;n++){var i=n*e.stride;r.push({X:Math.round(e.points[i]*t),Y:Math.round(e.points[i+1]*t)})}return r}},{key:"containsPoint",value:function(e,t){var r={X:Math.round(t.x*e.scale),Y:Math.round(t.y*e.scale)};return 1==$e.PointInPolygon(r,e)}}]),e}(),ut=new z(255,165,0),lt=new z(255,255,0),ct=new z(64,224,208),ht=new z(255,0,255),ft=new z(139,0,139),dt=new z(128,0,128),pt=new z(255,192,203),yt=new z(128,128,128),vt=function(){function e(t){h(this,e),this.canvas=t,this.ctx=t.getContext("2d"),this.operations=[];var r=this.refresh.bind(this);this.refresh=ue.debounce(r,100)}return d(e,[{key:"addOperation",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.operations.push({name:e,args:r})}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"refresh",value:function(){var t=this,r=[];e.allocateSegments(r,this.data,0),this.clear();for(var n=function(e){var n=r[e];n.hulls?n.hulls.forEach((function(e){return t.drawShape(e,n.color)})):t.drawRect(n.bounds,n.color)},i=r.length-1;i>=0;i--)n(i);this.operations.forEach((function(e){return t[e.name].apply(t,j(e.args))})),this.operations.clear()}},{key:"drawRect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:yt.toRGBA(.3);this.ctx.strokeStyle="rgba(".concat(t.red,", ").concat(t.green,", ").concat(t.blue,", ").concat(t.alpha,")"),this.ctx.strokeRect(e.left,e.top,e.width,e.height)}},{key:"fillRect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:yt.toRGBA(.3);this.ctx.fillStyle="rgba(".concat(t.red,", ").concat(t.green,", ").concat(t.blue,", ").concat(t.alpha,")"),this.ctx.fillRect(e.left,e.top,e.width,e.height)}},{key:"fillPoint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:z.BLACK;this.ctx.fillStyle="rgba(".concat(r.red,", ").concat(r.green,", ").concat(r.blue,", ").concat(r.alpha,")"),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill()}},{key:"drawShape",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ft.toRGBA(.5);this.ctx.strokeStyle="rgba(".concat(t.red,", ").concat(t.green,", ").concat(t.blue,", ").concat(t.alpha,")"),this.drawPath(e),this.ctx.stroke()}},{key:"fillShape",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ut.toRGBA(.6);this.ctx.fillStyle="rgba(".concat(t.red,", ").concat(t.green,", ").concat(t.blue,", ").concat(t.alpha,")"),this.drawPath(e),this.ctx.fill()}},{key:"drawPath",value:function(e){var t=this;"number"==typeof e[0]&&(e=[e]),this.ctx.beginPath(),e.forEach((function(e){t.ctx.moveTo(e[0],e[1]);for(var r=2;r<e.length;r+=2)t.ctx.lineTo(e[r],e[r+1]);t.ctx.closePath()}))}},{key:"drawRange",value:function(e){var t=this;e.forEach((function(e){return t.drawRect(e.bounds,dt)}))}},{key:"drawIntersection",value:function(e,t){var r=this;this.drawShape(e,pt),t.forEach((function(t){r.fillShape(t.shape,lt);var n=st.intersection(t.shape,e);if(n){var i=n.toPath2D();r.fillShape(i,z.BLACK)}}))}},{key:"drawSelection",value:function(e,t,r){this.fillRect(e),this.fillShape(t,ft.toRGBA(.5)),this.fillShape(r)}}],[{key:"allocateSegments",value:function(t,r,n){if(r){if(r.bounds){var i=r;0==r.depth?i.color=z.RED:1==r.depth?i.color=ct:2==r.depth?i.color=z.BLUE:3==r.depth?i.color=ht:4==r.depth&&(i.color=z.GREEN),t.push(i)}if(r.children)if(10!==n)for(var o=0;o<r.children.length;o++)e.allocateSegments(t,r.children[o],n+1);else console.warn("depth 10")}}},{key:"getInstance",value:function(t,r){if(t){var n=new e(t);return Object.defineProperty(n,"data",{get:function(){return r.data},enumerable:!0}),n}}}]),e}();function gt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var mt=function(e){g(r,e);var t=gt(r);function r(){var e,n;h(this,r);for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return e=t.call.apply(t,[this].concat(o)),"undefined"!=typeof document&&("loading"==document.readyState?addEventListener("DOMContentLoaded",(function(t){return n=vt.getInstance(document.getElementById("rbush"),m(e))})):n=vt.getInstance(document.getElementById("rbush"),m(e))),Object.defineProperty(m(e),"canvas",{get:function(){return e.debug?n:null},enumerable:!0}),e}return d(r,[{key:"toBBox",value:function(e){return{minX:e.bounds.left,minY:e.bounds.top,maxX:e.bounds.right,maxY:e.bounds.bottom}}},{key:"compareMinX",value:function(e,t){return e.bounds.x-t.bounds.x}},{key:"compareMinY",value:function(e,t){return e.bounds.y-t.bounds.y}},{key:"search",value:function(e){return V(E(r.prototype),"search",this).call(this,{minX:e.left,minY:e.top,maxX:e.right,maxY:e.bottom})}},{key:"find",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.data,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];if(t){if(t.stroke){var i=!0;Object.keys(e).forEach((function(r){i=i&&t[r]==e[r]})),i&&n.push(t)}if(t.children){if(6!==r){for(var o=0;o<t.children.length;o++)this.find(e,t.children[o]||null,r+1,n);return n}console.warn("depth 6")}}}}]),r}(u.default),bt=function(){function e(t,r){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;h(this,e),Array.isArray(r)&&(r=e.allocateBuffer(r)),Object.defineProperty(this,"layout",{value:t,enumerable:!0}),Object.defineProperty(this,"points",{get:function(){return r},enumerable:!0}),Object.defineProperty(this,"stride",{value:t.length,enumerable:!0}),Object.defineProperty(this,"length",{value:r.length/t.length,enumerable:!0}),Object.defineProperty(this,"segmentsCount",{value:this.length-3,configurable:!0,enumerable:!0});var s={},u={},l={},c=function(e){var t=l[e];return"visibility"==e?"boolean"!=typeof t&&(t=!0):"color"==e&&z.isColor(l)&&(t=z.fromColor(l)),t},f=function(e){var t=c(e);if(null==t)if("color"==e){var r={red:isFinite(l.red)?l.red:i.red,green:isFinite(l.green)?l.green:i.green,blue:isFinite(l.blue)?l.blue:i.blue,alpha:isFinite(l.alpha)?l.alpha:i.alpha};z.isColor(r)&&(t=z.fromColor(r))}else t=i[e];return t},d=function(e,r,n){var i;if(r&&t.includes(te.Property[ue.getEnumValueName(e)])){if(!n)throw new Error("Property ".concat(e," value ").concat(r," is not applicable. This is a dynamic property and is part of the layout."));console.warn("Property ".concat(e," value ").concat(r," is not applicable. This is a dynamic property and is part of the layout.")),r=void 0}if("color"==e)!r||r instanceof z||(i="Property ".concat(e," is not an instance of Color"));else if("blendMode"==e)""==r&&(r=void 0);else if("number"==typeof r)if("size"==e)r<0?i="Property ".concat(e," with value ").concat(r," is not allowed. Value should be a positive number."):0==r&&(r=void 0);else if("red"==e||"green"==e||"blue"==e||"alpha"==e){var o="alpha"==e?{min:0,max:1}:{min:0,max:255};r>=o.min&&r<=o.max||(i="Property ".concat(e," with value ").concat(r," is out of range. Allowd range: [").concat(o.min,", ").concat(o.max,"]."))}else"rotation"==e?0==r&&(r=void 0):"scattering"==e&&r<0&&(r=void 0);if(i)throw new Error(i);return r},p=function(e,t){if(null==t&&(t=void 0),d(e,t),"color"==e&&t)return this.red=t.red,this.green=t.green,this.blue=t.blue,void(this.alpha=t.alpha);l[e]=t};if(Object.defineProperties(s,{size:{get:c.bind(s,"size"),set:p.bind(s,"size"),enumerable:!0},red:{get:c.bind(s,"red"),set:p.bind(s,"red"),enumerable:!0},green:{get:c.bind(s,"green"),set:p.bind(s,"green"),enumerable:!0},blue:{get:c.bind(s,"blue"),set:p.bind(s,"blue"),enumerable:!0},alpha:{get:c.bind(s,"alpha"),set:p.bind(s,"alpha"),enumerable:!0},rotation:{get:c.bind(s,"rotation"),set:p.bind(s,"rotation"),enumerable:!0},scaleX:{get:c.bind(s,"scaleX"),set:p.bind(s,"scaleX"),enumerable:!0},scaleY:{get:c.bind(s,"scaleY"),set:p.bind(s,"scaleY"),enumerable:!0},scaleZ:{get:c.bind(s,"scaleZ"),set:p.bind(s,"scaleZ"),enumerable:!0},offsetX:{get:c.bind(s,"offsetX"),set:p.bind(s,"offsetX"),enumerable:!0},offsetY:{get:c.bind(s,"offsetY"),set:p.bind(s,"offsetY"),enumerable:!0},offsetZ:{get:c.bind(s,"offsetZ"),set:p.bind(s,"offsetZ"),enumerable:!0},color:{get:c.bind(s,"color"),set:p.bind(s,"color"),enumerable:!0},blendMode:{get:c.bind(s,"blendMode"),set:p.bind(s,"blendMode"),enumerable:!0},visibility:{get:c.bind(s,"visibility"),set:p.bind(s,"visibility"),enumerable:!0}}),Object.defineProperties(u,{size:{get:f.bind(u,"size"),set:p.bind(s,"size"),enumerable:!0},red:{get:f.bind(u,"red"),set:p.bind(s,"red"),enumerable:!0},green:{get:f.bind(u,"green"),set:p.bind(s,"green"),enumerable:!0},blue:{get:f.bind(u,"blue"),set:p.bind(s,"blue"),enumerable:!0},alpha:{get:f.bind(u,"alpha"),set:p.bind(s,"alpha"),enumerable:!0},rotation:{get:f.bind(u,"rotation"),set:p.bind(s,"rotation"),enumerable:!0},scaleX:{get:f.bind(u,"scaleX"),set:p.bind(s,"scaleX"),enumerable:!0},scaleY:{get:f.bind(u,"scaleY"),set:p.bind(s,"scaleY"),enumerable:!0},scaleZ:{get:f.bind(u,"scaleZ"),set:p.bind(s,"scaleZ"),enumerable:!0},offsetX:{get:f.bind(u,"offsetX"),set:p.bind(s,"offsetX"),enumerable:!0},offsetY:{get:f.bind(u,"offsetY"),set:p.bind(s,"offsetY"),enumerable:!0},offsetZ:{get:f.bind(u,"offsetZ"),set:p.bind(s,"offsetZ"),enumerable:!0},color:{get:f.bind(u,"color"),set:p.bind(s,"color"),enumerable:!0},blendMode:{get:f.bind(u,"blendMode"),set:p.bind(s,"blendMode"),enumerable:!0},visibility:{get:f.bind(u,"visibility"),set:p.bind(s,"visibility"),enumerable:!0}}),!Object.isSealed(i))for(var y in i)void 0!==i[y]&&(i[y]=d(y,i[y],!0));t.includes(te.Property.ROTATION)||"rotation"in i||(i.rotation=void 0),Object.defineProperty(this,"pointProps",{value:Object.seal(i),enumerable:!0}),Object.defineProperty(this,"style",{value:Object.freeze(u),enumerable:!0}),this.clearStyle=function(){for(var e in l)l[e]=void 0},this.ts=o,this.tf=a,Object.defineProperty(this,"bounds",{get:function(){return ne.ofSpline(n,n.pointProps.scattering).ceil()},enumerable:!0}),this.restoreBuffer=function(e){if("undefined"!=typeof SharedArrayBuffer&&n.points.buffer instanceof SharedArrayBuffer)throw new Error("Underlying buffer is SharedArrayBuffer and cannot be restored");if(r.buffer.byteLength>0)throw new Error("Cannot restore buffer when underlying buffer is not empty");r=new Float32Array(e)},Object.defineProperty(this,"color",{get:function(){return f("color")},set:function(e){if(!e)throw new Error("Spline color cannot be removed");"red"in this.pointProps&&(this.pointProps.red=e.red),"green"in this.pointProps&&(this.pointProps.green=e.green),"blue"in this.pointProps&&(this.pointProps.blue=e.blue),"alpha"in this.pointProps&&(this.pointProps.alpha=e.alpha)},enumerable:!0}),this.validate()}return d(e,[{key:"validate",value:function(){if(!this.layout.includes(te.Property.X))throw new Error("Layout doesn't contains required properties X");if(!this.layout.includes(te.Property.Y))throw new Error("Layout doesn't contains required properties Y");if(!this.layout.includes(te.Property.SIZE)&&isNaN(this.pointProps.size))throw new Error("Size information is required. Please provide via layout or through pointProps property.");if(0==this.points.length)throw new Error("Empty spline is not allowed");if(this.points.length%this.stride!=0)throw new Error("Path length doesn't match the stride provided via the layout");this.validateSegmentsCount()}},{key:"validateSegmentsCount",value:function(){if(this.segmentsCount<1)throw new Error("Incompleted spline found. Spline is defined with at least 4 control points.")}},{key:"clone",value:function(){return new e(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.ts,this.tf)}},{key:"getPoint",value:function(e){if(e>=this.length||e<0)throw new Error("Index ".concat(e," out of range - (0, ").concat(this.length-1,")"));var t=te.createInstance(this.layout,this.points,e,this.style);return this.matrix&&t.transform(this.matrix),t}},{key:"setPoint",value:function(e,t){var r=this,n=e*this.stride;this.layout.forEach((function(e,i){return r.points[n+i]=t.getProperty(e)}))}},{key:"getPath",value:function(){for(var e=[],t=this.layout.indexOf(te.Property.X),r=this.layout.indexOf(te.Property.Y),n=0;n<this.length;n++)e.push(this.points[n*this.stride+t],this.points[n*this.stride+r]);return e}},{key:"slice",value:function(t,r,n,i){if(t<0||t>this.length-4)throw new Error("Invalid fromIndex ".concat(t," found. Ensure that fromIndex range is {0, ").concat(this.length-4,"}."));if(r<1||r+1>this.length)throw new Error("Invalid toIndex ".concat(r," found. Ensure that fromIndex range is {1, ").concat(this.length,"}."));if(r+1-t<4)throw new Error("Invalid range {".concat(t,", ").concat(r,"} found. At least 4 points are needed to define spline."));var o;if("undefined"!=typeof SharedArrayBuffer&&this.points.buffer instanceof SharedArrayBuffer){var a=this.points.subarray(t*this.stride,(r+1)*this.stride),s=new SharedArrayBuffer(a.length*Float32Array.BYTES_PER_ELEMENT);(o=new Float32Array(s)).set(a)}else o=this.points.slice(t*this.stride,(r+1)*this.stride);var u=new e(this.layout.slice(),o,Object.clone(this.pointProps),n,i);return u.randomSeed=this.randomSeed,u}},{key:"setTransform",value:function(e){this.matrix=e}},{key:"transform",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.matrix,t=0,r=0;r<this.length;r++){var n=this.getPoint(r);n.transform(e),this.setPoint(r,n),t=n.rotation}this.layout.includes(te.Property.ROTATION)||(this.pointProps.rotation=0==t?void 0:t)}},{key:"toJSON",value:function(){return{type:"Spline",layout:this.layout.map((function(e){return e.name})),points:Fe.encode(this.points,this.encoding),pointProps:this.pointProps,ts:this.ts,tf:this.tf,randomSeed:this.randomSeed}}}],[{key:"allocateBuffer",value:function(e){if("undefined"==typeof SharedArrayBuffer)return e.toFloat32Array();var t=new SharedArrayBuffer(e.length*Float32Array.BYTES_PER_ELEMENT),r=new Float32Array(t);return r.set(e),r}},{key:"fromJSON",value:function(t){var r=Fe.decode(t.points),n=new e(t.layout.map((function(e){return te.Property[e]})),r,t.pointProps,t.ts,t.tf);return n.randomSeed=t.randomSeed,n}},{key:"createRect",value:function(t,r,n){var i=t.toPath(r,n);return new e(i.layout,i.points,{size:i.size,red:r.red,green:r.green,blue:r.blue,alpha:r.alpha})}}]),e}();function Et(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var xt=function(e){g(r,e);var t=Et(r);function r(e,n,i){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return h(this,r),o=t.call(this,e,n,i),Object.defineProperty(m(o),"tValues",{value:Object.freeze(a),enumerable:!0}),Object.defineProperty(m(o),"ts",{get:function(){return a.first},enumerable:!0}),Object.defineProperty(m(o),"tf",{get:function(){return a.last},enumerable:!0}),delete o.segmentsCount,o}return d(r,[{key:"slice",get:function(){}}]),d(r,[{key:"validateSegmentsCount",value:function(){}},{key:"clone",value:function(){return new r(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.tValues.slice())}},{key:"getPointT",value:function(e){return this.tValues[e]}},{key:"toJSON",value:function(){return{type:"InterpolatedSpline",layout:this.layout.map((function(e){return e.name})),points:Fe.encode(this.points,this.encoding),pointProps:this.pointProps,tValues:this.tValues}}}],[{key:"fromJSON",value:function(e){var t=Fe.decode(e.points);return new r(e.layout.map((function(e){return te.Property[e]})),t,e.pointProps,e.tValues)}}]),r}(bt);function Pt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var kt=i.mat4.fromValues(0,-.5,1,-.5,1,0,-2.5,1.5,0,.5,2,-1.5,0,0,-.5,.5),wt=function(e){g(r,e);var t=Pt(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return h(this,r),(e=t.call(this)).calculateDerivates=n,e.keepTValues=i,e.state={lastPointPosition:void 0,lastPointSize:0},e}return d(r,[{key:"initState",value:function(e){var t=this;this.state.layout={},e.layout.forEach((function(e,r){t.state.layout[e.name]={index:r,polynomials:i.vec4.create()}})),this.keepTValues&&(this.state.tValues=[]),this.splineLayout=e.layout,this.pathPointProps=Object.clone(e.pointProps),this.scattering&&(this.pathPointProps.scattering=this.scattering),this.layout=this.calculateDerivates?e.layout.concat([te.Property.D_X,te.Property.D_Y]):e.layout,this.state.ready=!0}},{key:"addImpl",value:function(e,t){return{added:this.getImpl(e,r.OutputType.ADDITION),predicted:this.getImpl(t,r.OutputType.PREDICTION)}}},{key:"getImpl",value:function(e,t){if(!e)return[];var n;if(this.state.ready||this.initState(e),t==r.OutputType.PREDICTION){var i=Object.clone(this.state);delete this.state.tValues,this.resetState(),n=this.discretize(e),this.state=i}else n=this.discretize(e);return n}},{key:"getOutput",value:function(e,t){if(0!=e.length){var n=t==r.OutputType.PREDICTION?void 0:this.state.tValues;return n&&(n=n.slice()),new xt(this.layout,e,this.pathPointProps,n)}}},{key:"discretize",value:function(e){throw new Error("This method is abstract and should be implemented")}},{key:"storeLastPoint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.state.lastPointPosition=new Y(this.getPropValue(te.Property.X,e,t),this.getPropValue(te.Property.Y,e,t),this.getPropValue(te.Property.Z,e,t)),this.state.lastPointSize=this.getPropValue(te.Property.SIZE,e,t)}},{key:"getPropValue",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.state.layout[e.name]?t[r+this.state.layout[e.name].index]:void 0}},{key:"calculatePolynomials",value:function(e,t){var r=this,n=this.splineLayout.length*(t+0),o=this.splineLayout.length*(t+1),a=this.splineLayout.length*(t+2),s=this.splineLayout.length*(t+3);this.splineLayout.forEach((function(t,u){var l=i.vec4.fromValues(e[n+u],e[o+u],e[a+u],e[s+u]);i.vec4.transformMat4(r.state.layout[t.name].polynomials,l,kt)}))}},{key:"samplePoint",value:function(e){var t=this,r=[],n=i.vec4.fromValues(1,e,e*e,e*e*e);return this.splineLayout.forEach((function(e){var o=i.vec4.dot(t.state.layout[e.name].polynomials,n);r.push(o)})),this.calculateDerivates&&(r.push(this.getDerivativeOf(this.state.layout.X.polynomials,n)),r.push(this.getDerivativeOf(this.state.layout.Y.polynomials,n))),r}},{key:"getDerivativeOf",value:function(e,t){var r=i.vec4.fromValues(e[1],2*e[2],3*e[3],0);return i.vec4.dot(r,t)}},{key:"addT",value:function(e){this.state.tValues&&this.state.tValues.push(e)}},{key:"resetState",value:function(){}},{key:"reset",value:function(){V(E(r.prototype),"reset",this).call(this),this.state.ready=!1,this.state.lastPointPosition=void 0,this.state.lastPointSize=0,delete this.state.tValues}}]),r}(Je);function Rt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var It,St=function(e){g(r,e);var t=Rt(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1,i=arguments.length>1?arguments[1]:void 0,o=arguments.length>2?arguments[2]:void 0;return h(this,r),(e=t.call(this,i,o)).spacing=n,e}return d(r,[{key:"split",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,r=this.spacing;this.spacing=1,this.splitCount=t;var n=this.get(e);return this.spacing=r,delete this.splitCount,n}},{key:"discretize",value:function(e){for(var t=[],r=this.splitCount,n=Math.max(1,10*(this.spacing>1?1:this.spacing)),o=0;o<e.segmentsCount;o++){if(this.calculatePolynomials(e.points,o),isNaN(this.splitCount)){var a=e.getPoint(o+1),s=e.getPoint(o+2),u=i.vec2.distance(a.value,s.value),l=this.pathPointProps.size;this.state.layout.SIZE&&(l=Math.min(a.size,s.size)),r=Math.floor(n*(u/l)/this.spacing)+1}for(var c=1/r,h=0;h<=r;h++){var f=!this.state.lastPointPosition,d=h/r;if(0==o&&d<e.ts){if(!(d+c>=e.ts))continue;d=e.ts,f=this.spacing<=1}if(o==e.segmentsCount-1&&d>=e.tf){if(!(d<e.tf+c))continue;d=e.tf,f=this.lastSegment&&this.spacing<=1}if(!(o>0&&0==d)){var p=this.samplePoint(d);if(!f&&this.state.lastPointPosition){var y=new Y(this.getPropValue(te.Property.X,p),this.getPropValue(te.Property.Y,p),this.getPropValue(te.Property.Z,p)),v=this.state.lastPointPosition.vec.squaredDistance(this.state.lastPointPosition.value,y.value),g=(this.state.layout.SIZE?(this.state.lastPointSize+p[this.state.layout.SIZE.index])/2:this.pathPointProps.size)*this.spacing;f=v>=g*g}f&&(t.push.apply(t,j(p)),this.storeLastPoint(p),this.addT(d))}}}return this.state.tValues&&(0!=t.length&&this.state.tValues.first==e.ts||(t.unshift.apply(t,j(this.samplePoint(e.ts))),this.state.tValues.unshift(e.ts)),this.state.tValues.last!=e.tf&&(t.push.apply(t,j(this.samplePoint(e.tf))),this.state.tValues.push(e.tf))),t}}]),r}(wt),Tt=function(){function e(){h(this,e),this.interpolator=new St(.1,!1,!0)}return d(e,[{key:"build",value:function(e,t,r){var n=this;return this.context=e,this.pathContext=new at(r),this.result={},this.holes=[],this.debug&&(t=t.unique()),t.sort(ue.comparator({sortBy:"strokeID",sortOrder:"asc"},{sortBy:"segmentIndex",sortOrder:"asc"},{sortBy:"splineIndex",sortOrder:"asc"},{sortBy:"pointIndex",sortOrder:"asc"})),this.debug&&(this.table=new ie([{name:"strokeID",title:"Stroke ID"},{name:"segmentIndex",title:"Segment Index"},{name:"splineIndex",title:"Spline Index"},{name:"pointIndex",title:"Point Index"},{name:"prevT",title:"Prev T"},{name:"t",title:"T Value"},{name:"nextT",title:"Next T"},{name:"ts",title:"Start T"},{name:"tf",title:"End T"},{name:"size",title:"Size"},{name:"shapeSize",title:"Shape Size"},{name:"hole",title:"HolePart"},{name:"nodeIndex",title:"Node Index"}])),t.forEach((function(e){n.isHolePart(e)?n.update(e):n.add(e),n.debug&&n.table.insert({strokeID:e.strokeID,segmentIndex:e.segmentIndex,splineIndex:e.splineIndex,pointIndex:e.pointIndex,prevT:e.prevT.toFixed(4),t:e.t.toFixed(4),nextT:e.nextT.toFixed(4),ts:e.spline.ts.toFixed(4),tf:e.spline.tf.toFixed(4),size:"".concat(e.bounds.width.toFixed(2)," / ").concat(e.bounds.height.toFixed(2)),shapeSize:"".concat(e.shapeBounds.width.toFixed(2)," / ").concat(e.shapeBounds.height.toFixed(2)),hole:e.hole,nodeIndex:e.nodeIndex})})),this.debug&&this.table.length>0&&console.log(this.table.toString()),this.narrow(),this.result}},{key:"add",value:function(e){this.holes=this.result[e.strokeID],this.holes||(this.holes=[],this.result[e.strokeID]=this.holes);var t=e.segmentIndex,r=e.segmentIndex,n=this.context.getNodes(e.strokeID).indexOf(e);this.holes.push({fromIndex:t,toIndex:r,fromTValue:e.prevT,toTValue:e.nextT,fromNodeIndex:n,toNodeIndex:n,strokeID:e.strokeID}),this.debug&&(e.hole=!1,e.nodeIndex=n)}},{key:"update",value:function(e){var t=this.holes.last;t.toIndex=e.segmentIndex,t.toTValue=e.nextT,t.toNodeIndex=this.context.getNodes(e.strokeID).indexOf(e),this.debug&&(e.hole=!0,e.nodeIndex=t.toNodeIndex)}},{key:"isHolePart",value:function(e){var t=this.holes.last;return!(!t||t.strokeID!=e.strokeID)&&(e.segmentIndex==t.toIndex&&e.prevT<=t.toTValue||e.segmentIndex==t.toIndex+1&&1==t.toTValue&&0==e.prevT)}},{key:"narrow",value:function(){var e=this;this.holes.forEach((function(t){var r,n=e.context.getNodes(t.strokeID),i=n[t.fromNodeIndex],o=n[t.toNodeIndex];r=t.toNodeIndex+1-t.fromNodeIndex<=2?e.extractT(i,"sf",i.prevT,o.nextT):{s:e.extractT(i,"s",i.prevT,i.nextT).s,f:e.extractT(o,"f",o.prevT,o.nextT).f},i.ts=r.s,o.tf=r.f,t.fromTValue=r.s,t.toTValue=r.f}))}},{key:"extractT",value:function(e,t,r,n){if(r==n)return{};for(var i,o={},a=t.startsWith("s"),s=new bt(e.spline.layout,e.spline.points,e.spline.pointProps,r,n),u=this.interpolator.get(s),l=0;l<u.length;l++){var c=u.getPoint(l),h=this.context.getBrushApplier(e.strokeID).applyBrush(c);if(st.intersection(this.pathContext,h)){if(a){if(o.s=i,t.endsWith("f")){i=u.getPointT(l),a=!1;continue}break}i=u.getPointT(l)}else if(a&&(i=u.getPointT(l)),!a&&(o.f=i,i))break}if(isNaN(o.s)&&(o.s=r),isNaN(o.f)&&(o.f=n),o.s==o.f){var f=u.tValues.indexOf(o.s);0==f?o.f=u.tValues[f+1]:o.s=u.tValues[f-1]}return o}}]),e}();Object.defineProperty(globalThis,"DIGITAL_INK_DEBUG",{get:function(){return It},set:function(e){It=e||{},ce.debug=It.InputListener,G.prototype.debug=It.Pipeline,Je.prototype.debug=It.Pipeline,Ke.prototype.debug=It.PathPointContext,at.prototype.debug=It.ClipperContext,mt.prototype.debug=It.RTree,Tt.prototype.debug=It.HolesBuilder},enumerable:!0,configurable:!0});var At=Object.freeze({__proto__:null,vector:function(e,t){var r,n={};return Object.defineProperty(n,"x",{value:t.x-e.x,enumerable:!0}),Object.defineProperty(n,"y",{value:t.y-e.y,enumerable:!0}),Object.defineProperty(n,"length",{get:function(){return isNaN(r)&&(r=Math.sqrt(n.x*n.x+n.y*n.y)),r},enumerable:!0}),n},angle:function(e,t){var r=e.x*t.x+e.y*t.y,n=e.x*t.y-e.y*t.x;return Math.atan2(n,r)}}),Ot=function(){function e(t){var r=this;h(this,e),this.phase=t.phase;var n=isNaN(t.altitude)||isNaN(t.azimuth)?void 0:{altitude:t.altitude,azimuth:t.azimuth};Object.defineProperty(this,"x",{value:t.x,enumerable:!0}),Object.defineProperty(this,"y",{value:t.y,enumerable:!0}),Object.defineProperty(this,"z",{value:t.z,enumerable:!0}),Object.defineProperty(this,"timestamp",{value:t.timestamp,enumerable:!0,writable:!0}),Object.defineProperty(this,"force",{value:t.pressure,enumerable:!0}),Object.defineProperty(this,"pressure",{value:t.pressure,enumerable:!0}),Object.defineProperty(this,"rotation",{value:t.rotation,enumerable:!0}),Object.defineProperty(this,"radiusX",{value:t.radiusX,enumerable:!0}),Object.defineProperty(this,"radiusY",{value:t.radiusY,enumerable:!0}),Object.defineProperty(this,"altitude",{get:function(){return n||(n=r.computeTilt(t)||{}),n.altitude},enumerable:!0}),Object.defineProperty(this,"azimuth",{get:function(){return n||(n=r.computeTilt(t)||{}),n.azimuth},enumerable:!0}),t.pointer&&Object.defineProperty(this,"pointer",{value:t.pointer,enumerable:!0}),this.computedAzimuth=void 0}return d(e,[{key:"createPathPoint",value:function(){return new te(this.x,this.y,this.z)}},{key:"computeTilt",value:function(e){if(!isNaN(e.tiltX)&&!isNaN(e.tiltY)){var t=e.tiltX,r=e.tiltY,n=Math.tan(Math.toRadians(t)),i=Math.tan(Math.toRadians(r)),o=Math.sqrt(n*n+i*i);return{altitude:Math.atan2(1,o),azimuth:Math.atan2(i,n)}}}},{key:"speed",value:function(t,r){var n={x:0,y:0,time:0};if((n=t&&!r?this.minus(t):r&&!t?r.minus(this):r.minus(t)).time>0)return e.getMagnitude(n.x,n.y)/(n.time/1e3);if(0==n.time)return 0;throw new Error("Speed out of range: ".concat(n.time))}},{key:"computeNearestAzimuthAngle",value:function(e){var t;if(isNaN(this.azimuth))return 0;if(e){if(isNaN(e.azimuth))return 0;var r=2*Math.PI,n=e.computedAzimuth||e.azimuth,i=parseInt(n/r),o=(t=this.azimuth+i*r)-n;o>=Math.PI?t-=r:o<-Math.PI&&(t+=r)}else t=this.azimuth;return this.computedAzimuth=t,t}},{key:"minus",value:function(e){return{x:this.x-e.x,y:this.y-e.y,time:this.timestamp-e.timestamp}}}],[{key:"getMagnitude",value:function(e,t){return Math.sqrt(e*e+t*t)}}]),e}();Object.defineEnum(Ot,"Property",["X","Y","Z","PHASE","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ALTITUDE","AZIMUTH","ROTATION"]);var Ct=function(){function e(){h(this,e),this.reset()}return d(e,[{key:"add",value:function(e,t,r){var n;e==G.Phase.BEGIN?this.reset(!0):e==G.Phase.END&&(this.last=!0),t&&(n=this.accumulatedAddition).push.apply(n,j(t)),r&&(this.lastPrediction=r)}},{key:"reset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.first=e,this.last=!1,this.accumulatedAddition=[],this.lastPrediction=[]}}]),e}();function Dt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Nt=function(e){g(r,e);var t=Dt(r);function r(){var e,n;h(this,r);for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return e=t.call.apply(t,[this].concat(o)),Object.defineProperty(m(e),"bounds",{get:function(){return n||(n=ne.ofPolygons(m(e)).ceil()),n},enumerable:!0}),Object.defineProperty(m(e),"verticesCount",{get:function(){if(!e.shapesList)return e.map((function(e){return e.length})).reduce((function(e,t){return e+t}),0)/2},enumerable:!0}),e.resetBounds=function(){return n=null},e.shapesList=!1,e.holesClockwise=!1,e}return d(r,[{key:"clone",value:function(){return this.map((function(e){return e.slice()}))}},{key:"setTransform",value:function(e){this.matrix=e}},{key:"transform",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.matrix;this.forEach((function(t){for(var r=0;r<t.length;r+=2){var n=new Y(t[r],t[r+1]);n.transformSelf(e),t[r]=n.x,t[r+1]=n.y}})),this.resetBounds()}},{key:"toArray",value:function(){return Array.from(this)}},{key:"toJSON",value:function(){return{type:"InkPath2D",contours:this.toArray(),shapesList:this.shapesList,holesClockwise:this.holesClockwise}}}],[{key:"fromJSON",value:function(e){if("InkPath2D"!=e.type)throw new Error("Invalid data found");var t=k(r,j(e.contours));return t.shapesList=e.shapesList,t.holesClockwise=e.holesClockwise,t}},{key:"fromArray",value:function(e){return k(r,j(e.slice(0)))}}]),r}(w(Array)),Mt={stride:2,sort:function(e,t){return this.sortArrayPart(e,0,e.length-this.stride,t),e},partition:function(e,t,r,n){for(var i=e[r],o=e[r+1],a=t-this.stride,s=t;s<r;s+=2)n?n(i,o,e[s],e[s+1])&&(a+=this.stride,this.swap(e,a,s)):(i>e[s]||i==e[s]&&o>e[s+1])&&(a+=this.stride,this.swap(e,a,s));return this.swap(e,a+this.stride,r),a+this.stride},swap:function(e,t,r){var n=e[t],i=e[t+1];return e[t]=e[r],e[t+1]=e[r+1],e[r]=n,e[r+1]=i,e},sortArrayPart:function(e,t,r,n){if(t<r){var i=this.partition(e,t,r,n);this.sortArrayPart(e,t,i-this.stride,n),this.sortArrayPart(e,i+this.stride,r,n)}}},Lt={monotoneChain:function(e){var t=Lt.ARRAY_TYPE;if(t||(t=Array),e.length<=0)return new t;Mt.sort(e);for(var r=new t(e.length),n=0,i=0;i<e.length;i+=2){for(;n>=4&&this.cross(r[n-4],r[n-3],r[n-2],r[n-1],e[i],e[i+1])<=0;)n-=2;r[n]=e[i],r[n+1]=e[i+1],n+=2}r=r.slice(0,n);var o,a=new t(e.length);n=0;for(var s=e.length-2;s>=0;s-=2){for(;n>=4&&this.cross(a[n-4],a[n-3],a[n-2],a[n-1],e[s],e[s+1])<=0;)n-=2;a[n]=e[s],a[n+1]=e[s+1],n+=2}return a=a.slice(0,n-2),t==Float32Array?((o=new Float32Array(a.length+r.length)).set(a),o.set(r,a.length)):o=a.concat(r),o},cross:function(e,t,r,n,i,o){return(r-e)*(o-t)-(n-t)*(i-e)}};function _t(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Ft=function(e){g(r,e);var t=_t(r);function r(e,n){var i;return h(this,r),(i=t.call(this)).inputBuffer=[],i.hasPrediction=!0,Object.defineProperty(m(i),"layout",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(m(i),"pathPointCalculator",{get:function(){return n},set:function(e){n=e,this.reset()},enumerable:!0}),i}return d(r,[{key:"togglePrediction",value:function(e){this.hasPrediction=e}},{key:"addImpl",value:function(e,t){if(e.phase!=this.phase)throw new Error("The phase of the addition (".concat(e.phase.name,") doesn't match the phase of the PathProducer (").concat(this.phase.name,")"));var r=[],n=[];e&&this.inputBuffer.push(e);var i=this.inputBuffer.length>=3?this.inputBuffer[this.inputBuffer.length-3]:null,o=this.inputBuffer.length>=2?this.inputBuffer[this.inputBuffer.length-2]:null,a=this.inputBuffer.length>=1?this.inputBuffer[this.inputBuffer.length-1]:null,s=this.calculate(i,o,a);return e&&s&&r.push.apply(r,j(s.toArray(this.layout))),this.phase==G.Phase.END?(s=this.calculate(o,a,null))&&r.push.apply(r,j(s.toArray(this.layout))):!this.hasPrediction||this.phase!=G.Phase.UPDATE&&null==t||(s=this.calculate(o,a,t))&&(n.push.apply(n,j(s.toArray(this.layout))),(s=this.calculate(a,t,null))&&n.push.apply(n,j(s.toArray(this.layout)))),{added:r,predicted:n}}},{key:"calculate",value:function(e,t,r){return t?this.pathPointCalculator(e,t,r):null}},{key:"reset",value:function(){V(E(r.prototype),"reset",this).call(this),this.inputBuffer.clear()}}]),r}(G);function Bt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Ut=[-6e-6,-139e-6,-185e-6,414e-6,.002357,.003357,-.003135,-.023928,-.042909,-.017858,.096525,.254692,.347072,.26881,.114933],jt=function(e){g(r,e);var t=Bt(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15;return h(this,r),(n=t.call(this)).buffer=[],n.pointsCount=0,n.filter=Ut.slice(),Object.defineProperty(m(n),"dimsCount",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(m(n),"movingAverageWindowSize",{get:function(){return i},set:function(e){i=e,this.filter.length!=e&&(this.filter=r.resample(Ut,e)),this.predictionPointsCount=4*e/15,this.windowSize=this.filter.length,this.reset()},enumerable:!0}),n.movingAverageWindowSize=i,n}return d(r,[{key:"addImpl",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return{added:this.lastSegment?this.project(e):this.addSequence(e),predicted:this.project(t)}}},{key:"getImpl",value:function(e){return this.project(e)}},{key:"project",value:function(e){if(e.length%this.dimsCount!=0)throw new Error("Points size ('".concat(e.length,"') must be multiple of the dimensions count ('").concat(this.dimsCount,"')."));if(0==e.length)return[];var t=[],r=this.buffer.slice(),n=e.slice(0,e.length-this.dimsCount),i=this.addSequence(n);t.push.apply(t,j(i));for(var o=e.slice(e.length-this.dimsCount,e.length),a=this.predictionPointsCount,s=0;s<a;s++){var u=this.addPoint(o);a-s<=this.pointsCount&&t.push.apply(t,j(u))}return this.buffer=r,t}},{key:"addSequence",value:function(e){if(e.length%this.dimsCount!=0)throw new Error("Points size ('".concat(e.length,"') must be multiple of the dimensions count ('").concat(this.dimsCount,"')."));for(var t=[],r=e.length/this.dimsCount,n=0;n<r;n++){var i=this.addPoint(e.slice(n*this.dimsCount,(n+1)*this.dimsCount));t.push.apply(t,j(i))}return this.pointsCount+=r,t}},{key:"addPoint",value:function(e){var t;for((t=this.buffer).push.apply(t,j(e));this.buffer.length<this.windowSize*this.dimsCount;){var r;(r=this.buffer).unshift.apply(r,j(this.buffer.slice(0,this.dimsCount)))}for(;this.buffer.length>this.windowSize*this.dimsCount;)this.buffer=this.buffer.slice(this.dimsCount);return this.filterBuffer()}},{key:"filterBuffer",value:function(){for(var e=[],t=0;t<this.windowSize;t++)for(var r=0;r<this.dimsCount;r++)isNaN(e[r])&&(e[r]=0),e[r]+=this.buffer[t*this.dimsCount+r]*this.filter[t];return e}},{key:"reset",value:function(){V(E(r.prototype),"reset",this).call(this),this.pointsCount=0,this.buffer.clear()}}],[{key:"resample",value:function(e,t){for(var r=new Float32Array(t),n=e.length/t,i=0,o=0;o<t;o++){var a=(e.length-1)*o/(t-1),s=Math.floor(a),u=Math.ceil(a),l=a-s,c=n*(e[s]*(1-l)+e[u]*l);i+=c,r[o]=c}for(var h=1/i,f=0;f<t;f++)r[f]*=h;return r}}]),r}(Je);function Gt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Yt=function(e){g(r,e);var t=Gt(r);function r(e){var n;return h(this,r),(n=t.call(this)).pathPointProps={},n.lastSpline=[],Object.defineProperty(m(n),"layout",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),n}return d(r,[{key:"addImpl",value:function(e,t){0==this.lastSpline.length&&e.length>0&&e.unshift.apply(e,j(e.slice(0,this.layout.length))),this.lastSegment&&(e.length>=this.layout.length?e.push.apply(e,j(e.slice(e.length-this.layout.length,e.length))):e.push.apply(e,j(this.getLastPart())));var r=this.getFirstPart();return this.lastSpline=r.concat(e),{added:e,predicted:this.getPredictedSpline(t)}}},{key:"getImpl",value:function(e){var t=[];return e.length>0&&(t.push.apply(t,j(e.slice(0,this.layout.length))),t.push.apply(t,j(e)),e.length>=this.layout.length&&t.push.apply(t,j(e.slice(e.length-this.layout.length,e.length)))),e}},{key:"getOutput",value:function(e,t){var r=t==Je.OutputType.ADDITION?this.lastSpline.length>=4*this.layout.length?this.lastSpline:[]:e;return 0==r.length?void 0:new bt(this.layout,r,this.pathPointProps,0,1)}},{key:"getFirstPart",value:function(){return this.lastSpline.slice(Math.max(0,this.lastSpline.length-3*this.layout.length),this.lastSpline.length)}},{key:"getLastPart",value:function(){return this.lastSpline.slice(this.lastSpline.length-this.layout.length,this.lastSpline.length)}},{key:"getPredictedSpline",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=[];if(e.length>0){var r=this.getFirstPart();for(t.push.apply(t,j(r)),t.push.apply(t,j(e)),t.push.apply(t,j(t.slice(t.length-this.layout.length,t.length)));t.length<4*this.layout.length;)t.unshift(t.slice(0,this.layout.length))}return t}},{key:"reset",value:function(){V(E(r.prototype),"reset",this).call(this),this.lastSpline.clear()}}]),r}(Je),zt=function(){function e(t){h(this,e),this.key=t,this.height=1}return d(e,[{key:"leftRotate",value:function(){var t=this.right,r=t.left;return t.left=this,this.right=r,this.height=Math.max(e.height(this.left),e.height(this.right))+1,t.height=Math.max(e.height(t.left),e.height(t.right))+1,t}},{key:"rightRotate",value:function(){var t=this.left,r=t.right;return t.right=this,this.left=r,this.height=Math.max(e.height(this.left),e.height(this.right))+1,t.height=Math.max(e.height(t.left),e.height(t.right))+1,t}},{key:"getBalanceFactor",value:function(){return e.height(this.left)-e.height(this.right)}}],[{key:"height",value:function(e){return e?e.height:0}},{key:"minValue",value:function(e){if(e){for(var t=e;t.left;)t=t.left;return t.key}}},{key:"maxValue",value:function(e){if(e){for(var t=e;t.right;)t=t.right;return t.key}}}]),e}(),Xt=function(){function e(){h(this,e),this.count=0,this.hasKey=!1,this.root}return d(e,[{key:"min",value:function(){return zt.minValue(this.root)}},{key:"max",value:function(){return zt.maxValue(this.root)}},{key:"add",value:function(e){return this.hasKey=!1,this.root=this.insertNode(this.root,e),this.hasKey||this.count++,!this.hasKey}},{key:"insertNode",value:function(e,t){if(!e)return new zt(t);if(t<e.key)e.left=this.insertNode(e.left,t);else{if(!(t>e.key))return this.hasKey=!0,e;e.right=this.insertNode(e.right,t)}if(!this.hasKey){e.height=1+Math.max(zt.height(e.left),zt.height(e.right));var r=e.getBalanceFactor();if(r>1){if(t<e.left.key)return e.rightRotate();if(t>e.left.key)return e.left=e.left.leftRotate(),e.rightRotate()}else if(r<-1){if(t>e.right.key)return e.leftRotate();if(t<e.right.key)return e.right=e.right.rightRotate(),e.leftRotate()}}return e}},{key:"contains",value:function(e){return this.containsNode(this.root,e)}},{key:"containsNode",value:function(e,t){return!!e&&(t<e.key?this.containsNode(e.left,t):!(t>e.key)||this.containsNode(e.right,t))}},{key:"printTree",value:function(){if(this.root)for(var e=[this.root],t=this.root.height;e.length>0;){var r=e.shift();t!=r.height&&console.log("-"),console.log("".concat(r.key," with height: ").concat(r.height,", balance: ").concat(r.getBalanceFactor())),t=r.height;var n=r.left,i=r.right;n&&e.push(n),i&&e.push(i)}}},{key:"toArray",value:function(){var t=[];return e.fillArray(t,this.root),t}}],[{key:"fillArray",value:function(e,t){t&&(this.fillArray(e,t.left),e.push(t.key),this.fillArray(e,t.right))}}]),e}(),Vt=function(){function e(){var t=this;h(this,e),this.tree=new Xt,Object.defineProperty(this,"length",{get:function(){return t.tree.count},enumerable:!0})}return d(e,[{key:"clear",value:function(){this.tree=new Xt}},{key:"add",value:function(e){return this.tree.add(e)}},{key:"includes",value:function(e){return this.tree.contains(e)}},{key:"min",value:function(){return this.tree.min()}},{key:"max",value:function(){return this.tree.max()}},{key:"toArray",value:function(){return this.tree.toArray()}}]),e}();function Ht(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var qt=function(e){g(r,e);var t=Ht(r);function r(e,n){var i;return h(this,r),(i=t.call(this,e,n)).state.segmentIndex=-1,i.state.lastSegmentIndex=-1,i.state.lastPointRotation=0,i.state.lastPointT=0,i.state.absAccumulatedErrorPos=0,i.state.absAccumulatedErrorS=0,i.setT=new Vt,Object.defineProperty(m(i),"errorThreshold",{get:function(){return this.error},set:function(e){this.error=e,this.errorDistSq=this.error*this.error,this.error10=10*this.error},enumerable:!0}),i.errorThreshold=.15,i}return d(r,[{key:"discretize",value:function(e){for(var t=[],r=e.segmentsCount,n=r-1,i=0;i<r;i++){this.calculatePolynomials(e.points,i);var o=this.calculateTParams(i==n,e.ts,e.tf);t.push.apply(t,j(this.samplePoints(o))),o.length>0&&(this.resetAccumulatedErrors(),this.storeLastPoint(t))}return t}},{key:"samplePoints",value:function(e){var t=this,r=[];return e.toArray().forEach((function(e){t.addT(e),r.push.apply(r,j(t.samplePoint(e)))})),r}},{key:"storeLastPoint",value:function(e){var t=e.length-this.layout.length;V(E(r.prototype),"storeLastPoint",this).call(this,e,t),this.state.lastPointRotation=this.getPropValue(te.Property.ROTATION,e,t),this.state.lastPointT=this.setT.max(),this.state.lastSegmentIndex=this.state.segmentIndex}},{key:"calculateTParams",value:function(e,t,r){this.state.segmentIndex++;var n=0==this.state.segmentIndex?t:0,i=e?r:1;return this.setT.clear(),this.getTForPos(n,i),this.state.layout.SIZE&&this.getTForCubic(n,i,this.state.layout.SIZE.polynomials,this.error),this.mustAddStartT()&&this.setT.add(n),e&&this.setT.add(i),this.state.layout.ROTATION&&this.getTForRotation(n,i),this.setT}},{key:"mustAddStartT",value:function(){if(this.state.lastSegmentIndex<0)return!0;var e=this.state.lastPointT-(this.state.segmentIndex-this.state.lastSegmentIndex),t=this.setT.length>0?this.setT.min():1,r=this.getPosErrorAtT0(t,this.state.lastPointPosition);if(this.state.absAccumulatedErrorPos+=Math.abs(r),this.state.layout.SIZE){var n=this.getErrorAtT0(this.state.layout.SIZE.polynomials,t,e,this.state.lastPointSize);this.state.absAccumulatedErrorS+=Math.abs(n)}return this.state.absAccumulatedErrorPos>this.errorDistSq||this.state.absAccumulatedErrorS>this.error}},{key:"getPosErrorAtT0",value:function(e,t){var r=this.getTPoint(e),n=this.getTPoint(0);return this.minDistanceSq(t,r,n)}},{key:"getErrorAtT0",value:function(e,t,r,n){var i=r,o=n,a=t,s=this.cubicCalc(e,a),u=this.cubicCalc(e,0),l=o+(0-i)*(s-o)/(a-i);return Math.abs(u-l)}},{key:"getTForPos",value:function(e,t){var r=this.getTPoint(e),n=this.getTPoint(t),i=this.subdividePos(r,n);if(i.split)this.subdivideRecursivePos(r,i),this.setT.add(i.t),this.subdivideRecursivePos(i,n);else{var o=this.subdividePos(r,i),a=this.subdividePos(i,n);o.split&&(this.subdivideRecursivePos(r,o),this.setT.add(o.t),this.subdivideRecursivePos(o,i)),(o.split||a.split)&&this.setT.add(i.t),a.split&&(this.subdivideRecursivePos(i,a),this.setT.add(a.t),this.subdivideRecursivePos(a,n))}}},{key:"subdivideRecursivePos",value:function(e,t){var r=this.subdividePos(e,t);r.split&&(this.subdivideRecursivePos(e,r),this.setT.add(r.t),this.subdivideRecursivePos(r,t))}},{key:"subdividePos",value:function(e,t){var r=.5*(e.t+t.t),n=this.getTPoint(r),i=this.minDistanceSq(e,t,n),o=e.add(t).scaleSelf(.5),a=n.subtract(o).absSelf();return n.split=i>this.errorDistSq||a.x>this.error10||a.y>this.error10,this.state.layout.Z&&(n.split=n.split||a.z>this.error10),n}},{key:"getTForCubic",value:function(e,t,r,n){var i={v:this.cubicCalc(r,e),t:e},o={v:this.cubicCalc(r,t),t:t},a=this.subdivide(i,o,r);if(a.diff>n)this.subdivideRecursive(i,a,r,n),this.setT.add(a.t),this.subdivideRecursive(a,o,r,n);else{var s=this.subdivide(i,a,r),u=this.subdivide(a,o,r);s.diff>n&&(this.subdivideRecursive(i,s,r,n),this.setT.add(s.t),this.subdivideRecursive(s,a,r,n)),(s.diff>n||u.diff>n)&&this.setT.add(a.t),u.diff>n&&(this.subdivideRecursive(a,u,r,n),this.setT.add(u.t),this.subdivideRecursive(u,o,r,n))}}},{key:"subdivideRecursive",value:function(e,t,r,n){var i=this.subdivide(e,t,r);i.diff>n&&(this.subdivideRecursive(e,i,r,n),this.setT.add(i.t),this.subdivideRecursive(i,t,r,n))}},{key:"subdivide",value:function(e,t,r){var n=.5*(e.t+t.t),i=this.cubicCalc(r,n),o=.5*(e.v+t.v);return{v:i,t:n,diff:Math.abs(i-o)}}},{key:"getTForRotation",value:function(e,t){var r=this.state.layout.ROTATION.polynomials,n=this.state.lastPointRotation;this.state.lastSegmentIndex<0&&(n=this.cubicCalc(r,e));for(var i=.25*(t-e),o=0;o<4;o++){var a=e+o*i,s=this.cubicCalc(r,a);Math.abs(s-n)>.06&&(this.setT.add(a),n=s)}}},{key:"minDistanceSq",value:function(e,t,r){var n=r.vec,i=n.squaredDistance(e.value,t.value);if(0==i)return n.squaredDistance(r.value,e.value);var o=Math.max(0,Math.min(1,n.dot(r.subtract(e).value,t.subtract(e).value)/i)),a=t.subtract(e).scale(o).add(e);return n.squaredDistance(r.value,a.value)}},{key:"getTPoint",value:function(e){var t=new Y(this.cubicCalc(this.state.layout.X.polynomials,e),this.cubicCalc(this.state.layout.Y.polynomials,e),this.state.layout.Z?this.cubicCalc(this.state.layout.Z.polynomials,e):void 0);return t.t=e,t}},{key:"cubicCalc",value:function(e,t){return e[0]+e[1]*t+e[2]*t*t+e[3]*t*t*t}},{key:"resetAccumulatedErrors",value:function(){this.state.absAccumulatedErrorPos=0,this.state.absAccumulatedErrorS=0}},{key:"resetState",value:function(){this.state.segmentIndex=-1,this.state.lastSegmentIndex=-1,this.state.lastPointT=0,this.state.lastPointRotation=0,this.resetAccumulatedErrors()}},{key:"reset",value:function(){V(E(r.prototype),"reset",this).call(this),this.resetState()}}]),r}(wt);function Zt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Wt=function(e){g(r,e);var t=Zt(r);function r(e){var n;return h(this,r),n=t.call(this),Object.defineProperty(m(n),"brush",{get:function(){if(!e)throw new Error("brush not found");return e},set:function(t){e=t,this.reset()},enumerable:!0}),n}return d(r,[{key:"addImpl",value:function(e,t){return{added:this.generatePolygons(e),predicted:this.generatePolygons(t)}}},{key:"getImpl",value:function(e){return this.generatePolygons(e)}},{key:"getOutput",value:function(e,t){var r=k(Nt,j(e));return r.shapesList=this.brush.spacing>1,r}},{key:"generatePolygons",value:function(e){if(!e)return[];for(var t=[],r=0;r<e.length;r++){var n=e.getPoint(r),i=this.applyBrush(n);t.push(i)}return t}},{key:"applyBrush",value:function(e){for(var t=[],r=this.createTransform(e),n=this.brush.selectShape(r.maxScale),o=0;o<n.length;o+=2){var a=i.vec4.create(),s=i.vec4.fromValues(n[o],n[o+1],0,1);i.vec4.transformMat4(a,s,r),t.push(a[0]/a[3],a[1]/a[3])}return t}},{key:"createTransform",value:function(e){if(isNaN(e.size))throw new Error("Size information not found.");var t=i.mat4.create(),r=e.size*e.scaleX,n=e.size*e.scaleY,o=e.size*e.scaleZ;return t.maxScale=Math.max(r,n,o),i.mat4.translate(t,t,i.vec3.fromValues(e.x,e.y,e.z||0)),i.mat4.rotateZ(t,t,e.rotation),i.mat4.translate(t,t,i.vec3.fromValues(e.offsetX,e.offsetY,e.offsetZ)),i.mat4.scale(t,t,i.vec3.fromValues(r,n,o)),t}}]),r}(Je);function Kt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Jt=function(e){g(r,e);var t=Kt(r);function r(){var e;return h(this,r),(e=t.call(this)).lastPolygon=[],e}return d(r,[{key:"addImpl",value:function(e,t){return{added:this.getConvexHulls(e,!0),predicted:this.getConvexHulls(t)}}},{key:"getImpl",value:function(e){return this.getConvexHulls(e)}},{key:"getOutput",value:function(e,t){return k(Nt,j(e))}},{key:"getConvexHulls",value:function(e,t){var r=[],n=this.lastPolygon;return e.forEach((function(e){var t;(t=n).push.apply(t,j(e)),r.push(Lt.monotoneChain(n)),n=e})),t&&e.length>0&&(this.lastPolygon=e.last.slice()),r}},{key:"reset",value:function(){V(E(r.prototype),"reset",this).call(this),this.lastPolygon.clear()}}]),r}(Je),Qt=function(){function e(){h(this,e),this.state={},this.nextKey=0,this.workers=[],this.status=e.Status.CLOSED,this.lastPolygon}var t,r;return d(e,[{key:"open",value:(r=de(he.mark((function t(){var r,n,i,o,a,s=this;return he.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.status==e.Status.CLOSED){t.next=2;break}throw new Error("Producer cannot be opened. Current status is ".concat(this.status.name,"."));case 2:for(r=new Blob(['\nlet QuickSort;\nlet ConvexHullProducer;\n\nlet worker = parseInt(self.name.replace(/^\\D+/g, ""));\n\nself.onmessage = function(e) {\n\tlet message = e.data;\n\n\tif (message.imports) {\n\t\tmessage.imports.forEach(url => self.importScripts(url));\n\n\t\tConvexHullProducer.ARRAY_TYPE = Float32Array;\n\n\t\tself.postMessage({worker, ready: true});\n\t\treturn;\n\t}\n\n\tlet result = ConvexHullProducer.monotoneChain(message.data);\n\tself.postMessage({worker, key: message.key, index: message.index, data: result}, [result.buffer]);\n}\n'],{type:"application/javascript"}),n=URL.createObjectURL(r),this.ready=0,this.imports=[{name:"QuickSort",value:Mt},{name:"ConvexHullProducer",value:Lt}].map((function(e){return URL.createObjectURL(new Blob([Object.toSource(e.value,e.name)],{type:"application/javascript"}))})),i=navigator.hardwareConcurrency,o=function(e){var t=new Worker(n,{name:"ConvexHullChainWorker".concat(e)});t.name=e,t.onmessage=function(e){return s.recieve(e.data)},t.onerror=function(t){return s.recieveError(t,e)},s.workers.push(t)},a=0;a<i;a++)o(a);return URL.revokeObjectURL(n),this.status=e.Status.OPEN_IN_PROGRESS,t.abrupt("return",new Promise((function(e,t){s.workers.forEach((function(e){return e.postMessage({imports:s.imports})})),s.resolve=e})));case 12:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"close",value:function(){this.workers.forEach((function(e){return e.terminate()})),this.workers.clear(),this.status=e.Status.CLOSED}},{key:"add",value:(t=de(he.mark((function t(r,n){var i,o,a,s=this,u=arguments;return he.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=u.length>2&&void 0!==u[2]?u[2]:[],this.status==e.Status.OPEN){t.next=3;break}throw new Error("Producer is not opened yet. Current status is ".concat(this.status.name,"."));case 3:return o=this.nextKey++,a=this.lastPolygon,n.length>0&&(this.lastPolygon=n.last),r==G.Phase.END&&(this.lastPolygon=null),this.state[o]={addition:n,prediction:i,data:[].concat(j(n.slice()),j(i.slice())),queue:[].concat(j(n.slice()),j(i.slice())),lastPolygon:a,added:[],predicted:[],expected:n.length+i.length,processed:0},t.abrupt("return",new Promise((function(e,t){s.state[o].resolve=e,s.workers.forEach((function(e){return s.send(e.name,o)}))})));case 9:case"end":return t.stop()}}),t,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"reset",value:function(){this.lastPolygon=null}},{key:"send",value:function(e,t){var r=this.state[t],n=r.queue.shift();if(n){var i=r.data.indexOf(n),o=(0==i?r.lastPolygon:r.data[i-1])||[];o.push.apply(o,j(n)),this.workers[e].postMessage({key:t,index:i,data:o})}}},{key:"recieve",value:function(t){if(t.ready)return this.ready++,void(this.ready==this.workers.length&&(this.imports.forEach((function(e){return URL.revokeObjectURL(e)})),this.resolve(),delete this.ready,delete this.resolve,this.status=e.Status.OPEN));var r,n,i=this.state[t.key];t.index>i.addition.length-1?(r=t.index-i.addition.length,n="predicted"):(r=t.index,n="added"),i[n][r]=t.data,i.processed++,i.processed==i.expected?(delete this.state[t.key],i.resolve({added:i.added,predicted:i.predicted})):this.send(t.worker,t.key)}},{key:"recieveError",value:function(e,t){console.warn("ConvexHullChainProducer Worker ".concat(t)),console.error(e)}}]),e}();function $t(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}Object.defineEnum(Qt,"Status",["OPEN","OPEN_IN_PROGRESS","CLOSED"]);var er=function(e){g(r,e);var t=$t(r);function r(){var e;return h(this,r),(e=t.call(this)).processPrediction=!1,e.filterDuplicates=!1,e}return d(r,[{key:"addImpl",value:function(e,t){return{added:this.merge(e),predicted:this.processPrediction?this.merge(t):t}}},{key:"getImpl",value:function(e){return this.merge(e)}},{key:"getOutput",value:function(e,t){return k(Nt,j(e))}},{key:"merge",value:function(e){return e.length?st.union(e,this.filterDuplicates):[]}}]),r}(Je);function tr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var rr=function(e){g(r,e);var t=tr(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return h(this,r),(e=t.call(this)).epsilon=n,e}return d(r,[{key:"addImpl",value:function(e,t){return{added:this.simplify(e),predicted:t}}},{key:"getImpl",value:function(e){return this.simplify(e)}},{key:"getOutput",value:function(e,t){return k(Nt,j(e))}},{key:"simplify",value:function(e){var t=this;return e.map((function(e){return t.simplifyPolygonDouglasPeucker(e)}))}},{key:"simplifyPolygonDouglasPeucker",value:function(e){if(e.length<6)return e;e instanceof Float32Array&&(e=e.toArray());var t=this.simplifyPolylineDouglasPeucker(e.concat([e[0],e[1]]));return t.length<8?e:t.slice(0,t.length-2)}},{key:"simplifyPolylineDouglasPeucker",value:function(e){if(this.epsilon<=0)return[];if(e.length<4)return e;for(var t,n=0,i=0,o=2;o<e.length-2;o+=2){var a=r.perpendicularDistance(e[o],e[o+1],e[0],e[1],e[e.length-2],e[e.length-1]);a>n&&(i=o,n=a)}if(n>this.epsilon){var s=this.simplifyPolylineDouglasPeucker(e.slice(0,i+2)),u=this.simplifyPolylineDouglasPeucker(e.slice(i,e.length));t=s.concat(u.slice(2,u.length))}else t=[e[0],e[1],e[e.length-2],e[e.length-1]];return t}}],[{key:"perpendicularDistance",value:function(e,t,r,n,i,o){var a=e-r,s=i-r,u=a*(o-n)-s*(t-n);u*=u;var l=(a=i-r)*a+(s=o-n)*s;return l>0?Math.sqrt(u/l):Math.sqrt((r-e)*(r-e)+(n-t)*(n-t))}}]),r}(Je);function nr(){}Object.defineEnum(nr,"Stage",["PATH_PRODUCER","SMOOTHER","SPLINE_PRODUCER","SPLINE_INTERPOLATOR","BRUSH_APPLIER","CONVEX_HULL_CHAIN_PRODUCER","POLYGON_MERGER","POLYGON_SIMPLIFIER"]);var ir=nr.Stage,or=Object.freeze({__proto__:null,Stage:ir,PathProducer:Ft,Smoother:jt,SplineProducer:Yt,DistanceBasedInterpolator:St,CurvatureBasedInterpolator:qt,BrushApplier:Wt,ConvexHullChainProducer:Jt,ConvexHullChainProducerAsync:Qt,PolygonMerger:er,PolygonSimplifier:rr});function ar(){}ar.BlendMode={SOURCE_OVER:"source-over",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",LIGHTER:"lighter",COPY:"copy",MIN:"MIN",MAX:"MAX"};var sr=ar.BlendMode;function ur(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return lr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return lr(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function lr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var cr=function(){function e(t,r){h(this,e),Object.defineProperty(this,"ctx",{value:t,enumerable:!0}),Object.defineProperty(this,"value",{value:r,enumerable:!0}),Object.defineProperty(this,"texture",{value:r,enumerable:!0})}var t;return d(e,[{key:"update",value:(t=de(he.mark((function e(t,r){var n,i,o,a,s,u,l;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(t)){e.next=26;break}n=[],i=ur(t),e.prev=4,i.s();case 6:if((o=i.n()).done){e.next=14;break}return a=o.value,e.next=10,Xe(a);case 10:s=e.sent,n.push(s);case 12:e.next=6;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(4),i.e(e.t0);case 19:return e.prev=19,i.f(),e.finish(19);case 22:this.completeMipMap(n),this.fill(n,r),e.next=31;break;case 26:return u=t,e.next=29,Xe(u);case 29:l=e.sent,this.fill(l);case 31:case"end":return e.stop()}}),e,this,[[4,16,19,22]])}))),function(e,r){return t.apply(this,arguments)})},{key:"completeMipMap",value:function(e){if(e.sort((function(e,t){return t.width-e.width})),1!=e.last.width)for(var t=e.last.width;t>1;){t/=2;var r=new OffscreenCanvas(e.last.width/2,e.last.height/2);r.getContext("2d").drawImage(e.last,0,0,r.width,r.height),e.push(r)}}},{key:"fill",value:function(e,t){var r=this,n=this.ctx,i=this.value;if(n.bindTexture(n.TEXTURE_2D,i),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),Array.isArray(e)){var o=e;this.size=[],o.forEach((function(e,t){n.texImage2D(n.TEXTURE_2D,t,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e),r.size.push({width:e.width,height:e.height}),e.close&&e.close()})),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,t?n.LINEAR_MIPMAP_LINEAR:n.LINEAR_MIPMAP_NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)}else n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e),this.size={width:e.width,height:e.height},e.close&&e.close();n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n.bindTexture(n.TEXTURE_2D,null),this.logError(this.ctx,i.name)}},{key:"readPixels",value:function(){var e=this.ctx,t=this.value,r=function(r,n){var i=new Uint8Array(r.width*r.height*4);return e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,n),e.readPixels(0,0,r.width,r.height,e.RGBA,e.UNSIGNED_BYTE,i),i},n=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,n);var i=Array.isArray(this.size)?this.size.map(r):r(this.size,0);return e.deleteFramebuffer(n),i}},{key:"logError",value:function(){var e=this,t=this.ctx.getError();if(t>0){var r=Object.keys(this.ctx.constructor.prototype).filter((function(r){return e.ctx[r]===t})).join(" | ");console.error("WebGL error - ".concat(this.texture.name,": ").concat(t," - ").concat(r))}}}],[{key:"createInstance",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.CLAMP_TO_EDGE,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.NEAREST,i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,n),t.bindTexture(t.TEXTURE_2D,null),new e(t,i)}}]),e}();function hr(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return fr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return fr(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function fr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var dr=function(){function e(t,r,n){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};h(this,e),this.name=t,this.spacing=o.spacing||.15,this.scattering=o.scattering||0,this.blendMode=o.blendMode||sr.SOURCE_OVER,this.rotationMode=o.rotationMode||e.RotationMode.RANDOM,Object.defineProperty(this,"particleSettings",{get:function(){return{spacing:i.spacing,scattering:i.scattering,blendMode:i.blendMode,rotationMode:i.rotationMode}},enumerable:!0}),Object.defineProperty(this,"fillTextureSettings",{get:function(){return{randomize:i.randomizeFill,size:i.fillTextureSize,offset:i.fillTextureOffset}},enumerable:!0}),Object.defineProperty(this,"descriptor",{value:{shape:{},fill:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){return Array.isArray(i.descriptor.shape)?i.descriptor.shape.map((function(e){return e.value})):i.descriptor.shape.value},enumerable:!0}),Object.defineProperty(this,"fill",{get:function(){return i.descriptor.fill.value},enumerable:!0}),this.updateShape(r),this.updateFill(n,a)}var t,r,n,i,o,a,s;return d(e,[{key:"updateShape",value:(s=de(he.mark((function e(t){return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Array.isArray(t)?t=t.map((function(e){return"string"==typeof e?Be.getInstance(e):e instanceof Be?e:new Be(e.name,e.value)})):"string"==typeof t?t=Be.getInstance(t):t instanceof Be||(t=new Be(t.name,t.value)),this.descriptor.shape=t,!this.ctx){e.next=5;break}return e.next=5,this.configureShape();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"updateFill",value:(a=de(he.mark((function e(t){var r,n=arguments;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.length>1&&void 0!==n[1]?n[1]:{},this.randomizeFill=!("randomize"in r)||r.randomize,this.fillTextureSize=r.size,this.fillTextureOffset=r.offset||{x:0,y:0},!Array.isArray(t)){e.next=6;break}throw new Error("Mipmap is not compatible whith fill texture");case 6:if("string"==typeof t?t=Be.getInstance(t):t instanceof Be||(t=new Be(t.name,t.value)),this.descriptor.fill=t,!this.ctx){e.next=11;break}return e.next=11,this.configureFill();case 11:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"configure",value:(o=de(he.mark((function e(t){return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ctx=t,e.next=3,this.configureShape();case 3:return e.next=5,this.configureFill();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"configureShape",value:(i=de(he.mark((function e(){return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.shapeTexture||(this.shapeTexture=cr.createInstance(this.ctx,this.ctx.CLAMP_TO_EDGE,this.ctx.LINEAR)),e.next=3,this.shapeTexture.update(this.shape,this.spacing<=1);case 3:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"configureFill",value:(n=de(he.mark((function e(){return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.fillTexture||(this.fillTexture=cr.createInstance(this.ctx,this.ctx.REPEAT,this.ctx.NEAREST)),e.next=3,this.fillTexture.update(this.fill);case 3:this.fillTextureSize||(this.fillTextureSize=this.fillTexture.size);case 4:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getShapeBinary",value:(r=de(he.mark((function e(){var t,r,n,i,o,a;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(this.shape)){e.next=24;break}r=[],n=hr(this.shape),e.prev=3,n.s();case 5:if((i=n.n()).done){e.next=13;break}return o=i.value,e.next=9,je(o);case 9:a=e.sent,r.push(a);case 11:e.next=5;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(3),n.e(e.t0);case 18:return e.prev=18,n.f(),e.finish(18);case 21:t=r,e.next=27;break;case 24:return e.next=26,je(this.shape);case 26:t=e.sent;case 27:return e.abrupt("return",t);case 28:case"end":return e.stop()}}),e,this,[[3,15,18,21]])}))),function(){return r.apply(this,arguments)})},{key:"getFillBinary",value:(t=de(he.mark((function e(){return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,je(this.fill);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"toJSON",value:function(){return{type:"BrushGL",name:this.name,shape:Array.isArray(this.descriptor.shape)?this.descriptor.shape.map((function(e){return e.toJSON()})):this.descriptor.shape.toJSON(),fill:this.descriptor.fill.toJSON(),particleSettings:{spacing:this.spacing,scattering:this.scattering,blendMode:this.blendMode.name,rotationMode:this.rotationMode.name},fillTextureSettings:{randomize:this.randomizeFill,size:this.fillTextureSize,offset:this.fillTextureOffset}}}},{key:"equals",value:function(e){return e==this&&e.shapeTexture==this.shapeTexture&&e.fillTexture==this.fillTexture}},{key:"delete",value:function(){this.deleteShape(),this.deleteFill()}},{key:"deleteShape",value:function(){this.shapeTexture&&(this.ctx.deleteTexture(this.shapeTexture),delete this.shapeTexture)}},{key:"deleteFill",value:function(){this.fillTexture&&(this.ctx.deleteTexture(this.fillTexture),delete this.fillTexture)}}],[{key:"fromJSON",value:function(t){t.particleSettings.blendMode=sr[t.particleSettings.blendMode],t.particleSettings.rotationMode=e.RotationMode[t.particleSettings.rotationMode];var r=Array.isArray(t.shape)?t.shape.map((function(e){return Be.fromJSON(e)})):Be.fromJSON(t.shape),n=Be.fromJSON(t.fill);return new e(t.name,r,n,t.particleSettings,t.fillTextureSettings)}}]),e}();Object.defineEnum(dr,"RotationMode",["NONE","RANDOM","TRAJECTORY"]);var pr=[ir.SMOOTHER,ir.POLYGON_MERGER,ir.POLYGON_SIMPLIFIER],yr=[ir.SPLINE_INTERPOLATOR,ir.BRUSH_APPLIER,ir.CONVEX_HULL_CHAIN_PRODUCER,ir.POLYGON_MERGER,ir.POLYGON_SIMPLIFIER],vr=function(){function e(){h(this,e),this.layout=[te.Property.X,te.Property.Y],this.pathSegment=new Ct,this.pathProducer=new Ft(this.layout,(function(e,t,r){return t.createPathPoint()})),this.smoother=new jt(this.layout.length),this.splineProducer=new Yt(this.layout),this.distanceInterpolator=new St,this.curvatureInterpolator=new qt,this.brushApplier=new Wt,this.polygonMerger=new er,this.polygonSimplifier=new rr,this.splineProducer.keepAllData=!0,this.phase=void 0,this.pointerID=void 0,this.lastPipelineStage=void 0,this.excludedPipelineStages=[],this.configured=!1}return d(e,[{key:"configure",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.reset(),e.onBuildComplete)throw new Error("InkBuilderSettings onBuildComplete property is deprecated. Use InkBuilder instance onComplete property to set callback.");if(e.excludedPipelineStages){if(!Array.isArray(e.excludedPipelineStages))throw new Error("Expected type of excludedPipelineStages is Array instance");var t=e.excludedPipelineStages.filter((function(e){return!pr.includes(e)}));t.length>0&&console.warn("excludedPipelineStages property includes steps which cannot be excluded: ".concat(t.map((function(e){return e.name})).join(", "))),this.excludedPipelineStages=e.excludedPipelineStages}if(e.lastPipelineStage){if(!yr.includes(e.lastPipelineStage))throw new Error("lastPipelineStage property expects one of: ".concat(yr.map((function(e){return e.name})).join(", ")));if(this.excludedPipelineStages.includes(e.lastPipelineStage))throw new Error("lastPipelineStage ".concat(e.lastPipelineStage.name," is disabled, check excludedPipelineStages configuration"));if(e.brush instanceof dr&&e.lastPipelineStage!=ir.SPLINE_INTERPOLATOR)throw new Error("lastPipelineStage ".concat(e.lastPipelineStage.name," is not compatible with provided brush"));this.lastPipelineStage=e.lastPipelineStage}if(!e.brush)throw new Error("InkBuilderSettings brush property is required");switch(this.brush=e.brush,this.brush instanceof We&&(this.brushApplier.brush=this.brush),this.lastPipelineStage||(this.brush instanceof We?this.brush.spacing>1?this.lastPipelineStage=ir.BRUSH_APPLIER:this.excludedPipelineStages.includes(ir.POLYGON_SIMPLIFIER)?this.excludedPipelineStages.includes(ir.POLYGON_MERGER)?this.lastPipelineStage=ir.CONVEX_HULL_CHAIN_PRODUCER:this.lastPipelineStage=ir.POLYGON_MERGER:this.lastPipelineStage=ir.POLYGON_SIMPLIFIER:this.lastPipelineStage=ir.SPLINE_INTERPOLATOR),this.lastPipelineStage==ir.SPLINE_INTERPOLATOR||this.lastPipelineStage==ir.BRUSH_APPLIER?(this.splineInterpolator=this.distanceInterpolator,this.splineInterpolator.spacing=this.brush.spacing,this.splineInterpolator.scattering=this.brush.scattering,this.splineInterpolator.calculateDerivates=this.brush instanceof dr):this.splineInterpolator=this.curvatureInterpolator,this.splineInterpolator.keepAllData=!1,this.brushApplier.keepAllData=!1,this.convexHullChainProducer.keepAllData=!1,this.polygonMerger.keepAllData=!1,this.polygonSimplifier.keepAllData=!1,this.lastPipelineStage){case ir.SPLINE_INTERPOLATOR:this.splineInterpolator.keepAllData=!0;break;case ir.BRUSH_APPLIER:this.brushApplier.keepAllData=!0;break;case ir.CONVEX_HULL_CHAIN_PRODUCER:this.convexHullChainProducer.keepAllData=!0;break;case ir.POLYGON_MERGER:this.polygonMerger.keepAllData=!0;break;case ir.POLYGON_SIMPLIFIER:this.polygonSimplifier.keepAllData=!0;break;default:throw console.warn(this.lastPipelineStage),new Error("Invalid lastPipelineStage found")}if(e.pathPointCalculator&&(this.calculator=e.pathPointCalculator,this.pathProducer.pathPointCalculator=e.pathPointCalculator),!e.layout)throw new Error("InkBuilderSettings layout property is required");var r=e.pathPointProps||{};if(this.layout=e.layout,this.brush instanceof We){if(this.layout.includes(te.Property.RED))throw new Error("RED layout channel is not supported for non particles strokes");if(this.layout.includes(te.Property.GREEN))throw new Error("GREEN layout channel is not supported for non particles strokes");if(this.layout.includes(te.Property.BLUE))throw new Error("BLUE layout channel is not supported for non particles strokes");if(this.layout.includes(te.Property.ALPHA))throw new Error("ALPHA layout channel is not supported for non particles strokes")}if(!this.layout.includes(te.Property.RED)&&isNaN(r.red))throw new Error("Stroke color red channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(te.Property.GREEN)&&isNaN(r.green))throw new Error("Stroke color green channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(te.Property.BLUE)&&isNaN(r.blue))throw new Error("Stroke color blue channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(te.Property.ALPHA)&&isNaN(r.alpha))throw new Error("Stroke color alpha channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(te.Property.SIZE)&&isNaN(r.size))throw new Error("Stroke size information is required. Please provide via layout or through configure settings via pathPointProps property.");this.pathProducer.layout=this.layout,this.smoother.dimsCount=this.layout.length,this.splineProducer.layout=this.layout,this.splineProducer.pathPointProps=r,this.smoother.movingAverageWindowSize=e.movingAverageWindowSize||15,this.curvatureInterpolator.errorThreshold=e.errorThreshold||.15,this.polygonMerger.processPrediction=!!e.mergePrediction,this.polygonSimplifier.epsilon=e.epsilon||.1,this.configured=!0}},{key:"add",value:function(e,t){if(!this.configured)throw new Error("InkBuilder instance is not configured yet, use configure method to configure the instance.");if(!this.calculator)throw new Error("InkBuilder instance is not configured properly, pathPointCalculator property is required");if(!e.phase)throw new Error("SensorPoint phase is not found");this.aborted=!1,this.phase=e.phase;var r,n=new Ot(e);t&&(r=new Ot(t)),this.device&&(this.phase==Ft.Phase.BEGIN&&this.device.openStream(e),this.device.add(n),this.phase==Ft.Phase.END&&(this.sensorData=this.device.closeStream()));var i=this.pathProducer.add(this.phase,n,r);this.pathSegment.add(this.phase,i.added,i.predicted)}},{key:"ignore",value:function(e){if(!e.phase)throw new Error("SensorPoint phase is not found");this.device&&e&&e.phase==Ft.Phase.UPDATE&&this.device.add(new Ot(e),!0)}},{key:"build",value:function(){throw new Error("Abstract method build of InkBuilderAbstract should be implemented")}},{key:"processSpline",value:function(e,t,r,n){throw new Error("Abstract method processSpline of InkBuilderAbstract should be implemented")}},{key:"mergeAndSimplify",value:function(e,t,r){return this.excludedPipelineStages.includes(ir.POLYGON_MERGER)||(r=this.polygonMerger.add(e,t,r.added,r.predicted),this.lastPipelineStage!=ir.POLYGON_MERGER)?(this.excludedPipelineStages.includes(ir.POLYGON_SIMPLIFIER)||(r=this.polygonSimplifier.add(e,t,r.added,r.predicted)),r):r}},{key:"getSensorData",value:function(){return this.sensorData}},{key:"getSpline",value:function(){return new bt(this.layout,this.splineProducer.allData.points,this.splineProducer.pathPointProps)}},{key:"getInkPath",value:function(e){var t;switch(this.lastPipelineStage){case ir.SPLINE_INTERPOLATOR:t=this.splineInterpolator.allData;break;case ir.BRUSH_APPLIER:t=this.brushApplier.allData;break;case ir.CONVEX_HULL_CHAIN_PRODUCER:t=this.convexHullChainProducer.allData;break;case ir.POLYGON_MERGER:t=this.polygonMerger.allData;break;case ir.POLYGON_SIMPLIFIER:t=this.polygonSimplifier.allData;break;default:throw console.warn(this.lastPipelineStage),new Error("Invalid lastPipelineStage found")}return e&&(this.lastPipelineStage!=ir.POLYGON_MERGER&&this.lastPipelineStage!=ir.POLYGON_SIMPLIFIER||(t=this.polygonMerger.merge(t)),this.lastPipelineStage==ir.POLYGON_SIMPLIFIER&&(t=this.polygonSimplifier.simplify(t))),t}},{key:"abort",value:function(){this.aborted=!0,this.device&&this.device.closeStream(!0),this.reset(),this.restart()}},{key:"reset",value:function(){this.sensorData=null,this.pathProducer.reset(),this.smoother.reset(),this.splineProducer.reset(),this.distanceInterpolator.reset(),this.curvatureInterpolator.reset(),this.brushApplier.reset(),this.convexHullChainProducer.reset(),this.polygonMerger.reset(),this.polygonSimplifier.reset()}},{key:"restart",value:function(){this.phase=void 0,this.pointerID=void 0,this.lastPipelineStage=null,this.excludedPipelineStages=[],this.configured=!1}}]),e}();function gr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}vr.Phase=Ft.Phase;var mr=function(e){g(r,e);var t=gr(r);function r(){var e;return h(this,r),(e=t.call(this)).convexHullChainProducer=new Jt,e}return d(r,[{key:"build",value:function(){var e=this.buildSegment();return e.phase=this.phase,e.pointerID=this.pointerID,e.predicted&&(e.predicted.predicted=!0),this.onComplete&&this.onComplete(e),this.phase==Ft.Phase.END&&this.restart(),e}},{key:"buildSegment",value:function(){var e={added:this.pathSegment.accumulatedAddition,predicted:this.pathSegment.lastPrediction};return this.excludedPipelineStages.includes(ir.SMOOTHER)||(e=this.smoother.add(this.pathSegment.first,this.pathSegment.last,e.added,e.predicted)),e=this.splineProducer.add(this.pathSegment.first,this.pathSegment.last,e.added,e.predicted),e=this.processSegment(this.pathSegment.first,this.pathSegment.last,e.added,e.predicted),this.pathSegment.reset(),e}},{key:"processSegment",value:function(e,t,r,n){var i=this.splineInterpolator.add(e,t,r,n);if(this.lastPipelineStage==ir.SPLINE_INTERPOLATOR)return i;if(i.added||i.predicted){if(i=this.brushApplier.add(e,t,i.added,i.predicted),this.lastPipelineStage==ir.BRUSH_APPLIER)return i;if(i=this.convexHullChainProducer.add(e,t,i.added,i.predicted),this.lastPipelineStage==ir.CONVEX_HULL_CHAIN_PRODUCER)return i;i=this.mergeAndSimplify(e,t,i)}else i={added:i.added?i.added.points:new Nt,predicted:i.predicted?i.predicted.points:new Nt};return i}},{key:"processSpline",value:function(e,t){var r=this.splineInterpolator.get(e);return this.lastPipelineStage==ir.SPLINE_INTERPOLATOR?r:r?(r=this.brushApplier.get(r),this.lastPipelineStage==ir.BRUSH_APPLIER?r:(r=this.convexHullChainProducer.get(r),this.lastPipelineStage==ir.CONVEX_HULL_CHAIN_PRODUCER?r:(this.brush.spacing>1?this.polygonMerger.filterDuplicates=!1:this.polygonMerger.filterDuplicates=t,r=this.polygonMerger.get(r),this.lastPipelineStage==ir.POLYGON_MERGER?r:r=this.polygonSimplifier.get(r)))):new Nt}}]),r}(vr),br=function(){function e(){h(this,e),this.queue=Promise.resolve(),this.thenables=[]}var t;return d(e,[{key:"then",value:function(e,t,r){var n=this;return this.thenables.push(e),this.queue=this.queue.then((function(){return n.thenables.shift(),e.canceled?Promise.resolve():e.apply(void 0,arguments)})),t&&this.then((function(e){return t(e,r)})),this}},{key:"catch",value:function(e){return this.queue=this.queue.catch(e),this}},{key:"cancel",value:function(){this.thenables.forEach((function(e){return e.canceled=!0}))}},{key:"isEmpty",value:function(){return 0==this.thenables.length}}],[{key:"serial",value:(t=de(he.mark((function t(r,n){var i;return he.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=new e,r.forEach((function(e,t){return i.then(e,n,t)})),t.abrupt("return",i.queue);case 3:case"end":return t.stop()}}),t)}))),function(e,r){return t.apply(this,arguments)})}]),e}();function Er(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var xr,Pr,kr=[],wr=function(e){g(a,e);var t,r,n,i,o=Er(a);function a(){var e;return h(this,a),(e=o.call(this)).convexHullChainProducer=new Qt,e.queue=Promise.resolve(),e.chainQueue=new br,e}return d(a,[{key:"open",value:(i=de(he.mark((function e(){return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.convexHullChainProducer.open();case 2:kr.push(this.convexHullChainProducer);case 3:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"close",value:function(){kr.remove(this.convexHullChainProducer),this.convexHullChainProducer.close()}},{key:"add",value:function(e,t){this.pathProducer.togglePrediction(this.chainQueue.isEmpty()),V(E(a.prototype),"add",this).call(this,e,t)}},{key:"configure",value:function(e){var t=this;this.chainQueue.isEmpty()?V(E(a.prototype),"configure",this).call(this,e):this.chainQueue.then((function(){return V(E(a.prototype),"configure",t).call(t,e)}))}},{key:"build",value:function(){var e=this;if(this.phase){var t=this.phase;this.phase==Ft.Phase.END&&this.restart();var r=function(){return Promise.resolve().then((function(){return e.buildPhase=t,e.buildSegment()})).then((function(r){e.building=!1,e.aborted||(r.phase=t,r.pointerID=e.pointerID,r.predicted.predicted=!0,e.onComplete(r))}))};t==Ft.Phase.END?this.queue=this.queue.then(r):this.building?this.queue=Promise.resolve():(this.building=!0,this.queue=r())}}},{key:"buildChain",value:function(){var e=this;if(this.phase){var t=this.phase,r=this.getLastPathSegment();this.phase==Ft.Phase.END&&this.restart(),this.chainQueue.then((function(){return e.buildPhase=t,e.buildSegment(r)})).then((function(r){r.phase=t,r.pointerID=e.pointerID,r.predicted.predicted=!0,e.onComplete(r)}))}return this.chainQueue}},{key:"getLastPathSegment",value:function(){var e=this.pathSegment;return this.pathSegment=new Ct,e}},{key:"buildSegment",value:(n=de(he.mark((function e(t){var r;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t||(t=this.pathSegment),r={added:t.accumulatedAddition,predicted:t.lastPrediction},this.excludedPipelineStages.includes(ir.SMOOTHER)||(r=this.smoother.add(t.first,t.last,r.added,r.predicted)),r=this.splineProducer.add(t.first,t.last,r.added,r.predicted),e.next=6,this.processSegment(t.first,t.last,r.added,r.predicted);case 6:return r=e.sent,t.reset(),e.abrupt("return",r);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"processSegment",value:(r=de(he.mark((function e(t,r,n,i){var o;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=this.splineInterpolator.add(t,r,n,i),this.lastPipelineStage!=ir.SPLINE_INTERPOLATOR){e.next=3;break}return e.abrupt("return",o);case 3:if(!o.added&&!o.predicted){e.next=16;break}if(o=this.brushApplier.add(t,r,o.added,o.predicted),this.lastPipelineStage!=ir.BRUSH_APPLIER){e.next=7;break}return e.abrupt("return",o);case 7:return e.next=9,this.convexHullChainProducer.add(this.phase,o.added,o.predicted);case 9:if(o=e.sent,this.lastPipelineStage!=ir.CONVEX_HULL_CHAIN_PRODUCER){e.next=12;break}return e.abrupt("return",o);case 12:return o=this.mergeAndSimplify(t,r,o),e.abrupt("return",o);case 16:return e.abrupt("return",{added:o.added?o.added.points:new Nt,predicted:o.predicted?o.predicted.points:new Nt});case 17:case"end":return e.stop()}}),e,this)}))),function(e,t,n,i){return r.apply(this,arguments)})},{key:"onComplete",value:function(e){throw new Error("InkBuilderAsync.onComplete() should be implemented")}},{key:"processSpline",value:(t=de(he.mark((function e(t,r){var n,i;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.splineInterpolator.get(t),this.lastPipelineStage!=ir.SPLINE_INTERPOLATOR){e.next=3;break}return e.abrupt("return",n);case 3:if(n){e.next=5;break}return e.abrupt("return",new Nt);case 5:if(n=this.brushApplier.get(n),this.lastPipelineStage!=ir.BRUSH_APPLIER){e.next=8;break}return e.abrupt("return",n);case 8:return e.next=10,this.convexHullChainProducer.add(Ft.Phase.END,n);case 10:if(i=e.sent,n=i.added,this.lastPipelineStage!=ir.CONVEX_HULL_CHAIN_PRODUCER){e.next=14;break}return e.abrupt("return",n);case 14:if(this.brush.spacing>1?this.polygonMerger.filterDuplicates=!1:this.polygonMerger.filterDuplicates=r,n=this.polygonMerger.get(n),this.lastPipelineStage!=ir.POLYGON_MERGER){e.next=18;break}return e.abrupt("return",n);case 18:return n=this.polygonSimplifier.get(n),e.abrupt("return",n);case 20:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"abort",value:function(){V(E(a.prototype),"abort",this).call(this),this.buildPhase=null,this.chainQueue.cancel()}}],[{key:"closeAll",value:function(){kr.forEach((function(e){return e.close()})),kr.clear()}}]),a}(vr);function Rr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Ir=function(e){g(n,e);var t,r=Rr(n);function n(e,t,i,o){var a,s;h(this,n),a=r.call(this,t.id);var u=!0;return Object.defineProperty(m(a),"layout",{value:t.layout,enumerable:!0}),Object.defineProperty(m(a),"points",{get:function(){return t.points},enumerable:!0}),Object.defineProperty(m(a),"pointProps",{value:t.pointProps,enumerable:!0}),Object.defineProperty(m(a),"style",{value:t.style,enumerable:!0}),Object.defineProperty(m(a),"ts",{value:t.ts,enumerable:!0}),Object.defineProperty(m(a),"tf",{value:t.tf,enumerable:!0}),Object.defineProperty(m(a),"stride",{value:t.stride,enumerable:!0}),Object.defineProperty(m(a),"length",{value:t.length,enumerable:!0}),Object.defineProperty(m(a),"segmentsCount",{value:t.segmentsCount,enumerable:!0}),t.randomSeed&&Object.defineProperty(m(a),"randomSeed",{value:t.randomSeed,enumerable:!0}),Object.defineProperty(m(a),"color",{get:function(){return t.color},set:function(e){t.color=e,i&&(i.color=e)},enumerable:!0}),Object.defineProperty(m(a),"sensorData",{value:o,enumerable:!0}),Object.defineProperty(m(a),"spline",{value:t,enumerable:!0}),Object.defineProperty(m(a),"hasPath",{get:function(){return!!i},enumerable:!0}),Object.defineProperty(m(a),"path",{get:function(){return i||this.buildPath(),i},set:function(e){i=e},enumerable:!0}),Object.defineProperty(m(a),"bounds",{get:function(){return s||(s=this.path.bounds),this.matrix?s.transform(this.matrix).ceil():s},enumerable:!0}),a.reset=function(e,r){e&&(t=e),i=r,a.resetBounds()},a.resetBounds=function(){return s=null},Object.defineProperty(m(a),"descriptor",{value:{brush:{}},enumerable:!0}),Object.defineProperty(m(a),"brush",{get:function(){return e||(e=this.descriptor.brush.value),e},set:function(r){if(u||this.reset(),"string"==typeof r?r=new Be(r):r instanceof We||r instanceof dr?r=new Be(r.name,r):r instanceof Be||(r=new Be(r.name,r.value)),r instanceof dr&&!t.randomSeed)throw new Error("Spline do not provides randomSeed. Raster rendering requires it.");e=null,this.descriptor.brush=r},enumerable:!0}),a.brush=e,a.renderMode=void 0,a.sensorDataOffset=0,a.sensorDataMapping=[],u=!1,a}return d(n,[{key:"clone",value:function(){var e=new n(this.descriptor.brush,this.spline.clone(),void 0,this.sensorData);return e.renderMode=this.renderMode,e.sensorDataOffset=this.sensorDataOffset,e.sensorDataMapping=this.sensorDataMapping.clone(),e}},{key:"init",value:(t=de(he.mark((function e(t){return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.pathProceessInProgress=!0,Pr){e.next=5;break}return Pr=new wr,e.next=5,Pr.open();case 5:return Pr.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),t&&Pr.configure(t),e.next=9,Pr.processSpline(this.spline,this.target==n.Target.GL);case 9:this.path=e.sent,delete this.pathProceessInProgress;case 11:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"buildPath",value:function(e){if(this.pathProceessInProgress)throw new Error("Init process in progress. Await init stroke.");xr||(xr=new mr),xr.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),e&&xr.configure(e),this.path=xr.processSpline(this.spline,this.target==n.Target.GL)}},{key:"getSegment",value:function(e){var t=e,r=e+3,n=0==t?this.ts:0,i=r+1==this.length?this.tf:1;return this.spline.slice(t,r,n,i)}},{key:"getSensorPoint",value:function(e){if(e>=this.length||e<0)throw new Error("Index ".concat(e," out of range - (0, ").concat(this.length-1,")"));var t;if(this.sensorData){var r,n=this.sensorData.inkStream;if(n)this.sensorDataMapping.length>0?r=e>=this.sensorDataMapping.length?this.sensorDataMapping.last:this.sensorDataMapping[e]:(r=this.sensorDataOffset+e)>=n.length&&(r=n.length-1),(t=n.get(r)).index=r,t.timespan=t.timestamp,t.timestamp+=this.sensorData.created}return t}},{key:"getPoint",value:function(e){return this.spline.getPoint(e)}},{key:"setPoint",value:function(e,t){var r=this,n=e*this.stride;this.layout.forEach((function(e,i){return r.points[n+i]=t.getProperty(e)}))}},{key:"pointAt",value:function(e){return this.getPoint(e)}},{key:"getAverageWidth",value:function(){var e=0;if(this.layout.includes(te.Property.SIZE)){for(var t=0,r=0;r<this.length;r++)t+=this.getPoint(r).size;e=t/this.length}else e=this.pointProps.size;return e}},{key:"split",value:function(e){var t=this,r=e.map((function(e){return t.subStroke(e)}));return r.includes(this)||0==r.length?void 0:r}},{key:"subStroke",value:function(e){var t=e.fromIndex,r=e.toIndex,i=e.fromTValue,o=e.toTValue;if(0==t&&r+1==this.length&&i==this.ts&&o==this.tf)return this;var a=this.spline.slice(t,r,i,o),s=new n(this.descriptor.brush,a,void 0,this.sensorData);return s.renderMode=this.renderMode,this.sensorData&&(s.sensorDataOffset=this.sensorDataOffset+t,this.sensorDataMapping.length>0?s.sensorDataMapping=this.sensorDataMapping.slice(t,r+1):s.sensorDataMapping=[]),s}},{key:"transform",value:function(e){e||(e=this.matrix,this.matrix=null),e&&(this.spline.transform(e),this.hasPath&&this.path.transform(e),this.resetBounds())}},{key:"setTransform",value:function(e){this.matrix=e}},{key:"clearStyle",value:function(){this.spline.clearStyle()}}],[{key:"createInstance",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=arguments.length>4?arguments[4]:void 0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,u=i.color;u&&(delete i.color,(i=Object.assign({},i)).red=u.red,i.green=u.green,i.blue=u.blue,i.alpha=u.alpha);var l=new bt(r,t,i,a,s);return l.randomSeed=o,new n(e,l)}},{key:"validatePath",value:function(e){if(!e)return!1;if(0==e.length)return!1;if(e instanceof Nt)return!0;if(Array.isArray(e))throw new Error("path should be instance of InkPath2D");var t=!1,r=0,n=!1,i=e.pointProps,o=i.size,a=i.red,s=i.green,u=i.blue,l=i.alpha;if(!(e instanceof xt)){var c=e.points.length,h=e.layout.length;n=0==c||c<4*h,r=c%h}return 0!=r?console.error("The points array (length: ".concat(e.points.length,") does not refer to provided layout (").concat(e.layout.map((function(e){return e.name})).join(", "),")")):n?console.error("Less than needed minimum of points passed (At least 4 points are needed to define a path)!"):!e.layout.includes(te.Property.SIZE)&&isNaN(o)?console.error("Either the size property must be set or the path layout must include a SIZE property"):!e.layout.includes(te.Property.RED)&&isNaN(a)?console.error("Either the color property must be set or the path layout must include a RED property"):!e.layout.includes(te.Property.GREEN)&&isNaN(s)?console.error("Either the color property must be set or the path layout must include a GREEN property"):!e.layout.includes(te.Property.BLUE)&&isNaN(u)?console.error("Either the color property must be set or the path layout must include a BLUE property"):!e.layout.includes(te.Property.ALPHA)&&isNaN(l)?console.error("Either the color property must be set or the path layout must include a ALPHA property"):t=!0,t}},{key:"decodeInkPath",value:function(e){if("InkPath2D"==e.type)return Nt.fromJSON(e);if("InterpolatedSpline"==e.type)return xt.fromJSON(e);throw new Error("Decode ink path faild. Cannot identify type: ".concat(e.type))}}]),n}(D);if(Ir.RenderMode=Object.assign.apply(Object,[{}].concat(j(Object.keys(sr).map((function(e){return y({},e,"will://rasterization/3.0/blend-mode/".concat(ue.getPropName(e,!0)))}))))),Ir.RenderMode.get=function(e){return Ir.RenderMode[ue.getEnumValueName(e.replace(/-/g,"_"))]},Ir.RenderMode.getBlendMode=function(e){return sr[Object.keys(Ir.RenderMode).filter((function(t){return Ir.RenderMode[t]==e})).first]},Object.defineEnum(Ir,"Target",["2D","GL"]),I.type2D==I.Type2D.OFFSCREEN)if(I.commonJS){var Sr=require("canvas"),Tr=Sr.Canvas,Ar=Sr.ImageData,Or=Sr.Image;global.OffscreenCanvas=Tr,global.ImageData=Ar,global.Image=Or}else console.warn("Current env - ".concat(I.type.name,", do not provides OffscreenCanvas support"));var Cr=function(){function e(){h(this,e)}var t,r;return d(e,[{key:"setTransform",value:function(e){this.transform=e}},{key:"getExportCanvas",value:function(e){throw new Error("Abstract method getExportCanvas of Layer inheritor should be implemented")}},{key:"toBlob",value:(r=de(he.mark((function e(t){var r,n,i,o=arguments;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.length>1&&void 0!==o[1]?o[1]:"image/png",n=o.length>2&&void 0!==o[2]?o[2]:.92,"undefined"!=typeof Blob){e.next=8;break}if("undefined"!=typeof Buffer){e.next=7;break}throw new Error("Current environment do not have neither Blob nor Buffer support.");case 7:throw new Error("This method is not compliant in underlying environment. Use `toBuffer` instead.");case 8:if(!(i=this.getExportCanvas(t)).toBlob){e.next=13;break}return e.abrupt("return",new Promise((function(e,t){return i.toBlob(e,r,n)})));case 13:return e.abrupt("return",i.convertToBlob({type:r,quality:n}));case 14:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"toBuffer",value:(t=de(he.mark((function e(t){var r,n,i,o,a,s=arguments;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=s.length>1&&void 0!==s[1]?s[1]:"image/png",n=s.length>2&&void 0!==s[2]?s[2]:{},"undefined"!=typeof Buffer){e.next=8;break}if("undefined"!=typeof Blob){e.next=7;break}throw new Error("Current environment do not have neither Blob nor Buffer support.");case 7:throw new Error("This method is not compliant in underlying environment. Use `toBlob` instead.");case 8:return i=this.getExportCanvas(t),n.filters&&(o=Array.isArray(n.filters)?n.filters.slice():[n.filters],a=0,o.forEach((function(e){a|=i["PNG_FILTER_".concat(e.name)]})),Object.assign({},n,{filters:a})),e.abrupt("return",new Promise((function(e,t){return i.toBuffer((function(r,n){return r?t(r):e(n)}),r,n)})));case 11:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}],[{key:"getDefaultSize",value:function(e,t){var r={};return"undefined"==typeof screen?(r.width=e,r.height=t):navigator.maxTouchPoints?(r.width=Math.max(screen.width,screen.height),r.height=r.width):(r.width=screen.width,r.height=screen.height),r}}]),e}();function Dr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}Object.defineEnum(Cr,"PNGFilterType",["NO","ALL","NONE","SUB","UP","AVG","PAETH"]);var Nr=function(e){g(r,e);var t=Dr(r);function r(e){var n;return h(this,r),n=t.call(this),Object.defineProperty(m(n),"surface",{value:e.canvas}),Object.defineProperty(m(n),"ctx",{value:e}),Object.defineProperty(m(n),"bounds",{get:function(){return new ne(0,0,n.width,n.height)},enumerable:!0}),n.ctx.getContextAttributes||(n.ctx.getContextAttributes=function(){return{}}),n}return d(r,[{key:"width",get:function(){return this.surface.width}},{key:"height",get:function(){return this.surface.height}}]),d(r,[{key:"clear",value:function(e,t){if(t){if(z.isColor(e))throw new Error("`clear` first argument should be Rectangle")}else z.isColor(e)&&(t=e,e=null);e||(e=this.bounds),this.ctx.clearRect(e.left,e.top,e.width,e.height),t&&(this.ctx.fillStyle=t.toString(),this.ctx.fillRect(e.left,e.top,e.width,e.height))}},{key:"draw",value:function(e){return this.drawStroke(e.brush,e.path,e.color,e.matrix)}},{key:"drawStroke",value:function(e,t,r,n){if(!Ir.validatePath(t))return null;if(!(e instanceof We))throw new Error("Incompatible brush found. It should be Brush2D instance.");n?this.transform&&(n=this.transform.multiply(n)):n=this.transform;var i=t.bounds;if(i&&(n&&(i=i.transform(n)),i=i.ceil()),i=this.bounds.intersect(i)){if(this.ctx.save(),n?this.ctx.setTransform(n.a,n.b,n.c,n.d,n.tx,n.ty):(this.ctx.rect(i.left,i.top,i.width,i.height),this.ctx.clip()),t instanceof Nt)t.holesClockwise=!0,this.drawPath(t,r.toRGB().toString()),e.pattern&&this.drawPath(t,e.pattern);else{if(!(t instanceof xt))throw new Error("drawStroke 'path' instance expected type is unexpected. Expects InkPath2D or InterpolatedSpline.");this.drawSpline(t,r)}this.ctx.restore()}return i}},{key:"drawPath",value:function(e,t){var r=this;this.ctx.beginPath(),e.forEach((function(t,n){if(r.ctx.moveTo(t[0],t[1]),e.holesClockwise||0==n)for(var i=2;i<t.length;i+=2)r.ctx.lineTo(t[i],t[i+1]);else for(var o=t.length-2;o>=0;o-=2)r.ctx.lineTo(t[o],t[o+1]);r.ctx.closePath()})),t&&(this.ctx.fillStyle=t),this.ctx.fill()}},{key:"drawSpline",value:function(e,t){t||(t=e.color),this.ctx.fillStyle="rgb(".concat(t.red,", ").concat(t.green,", ").concat(t.blue,")");for(var r=0;r<e.length;r++){var n=e.getPoint(r),i=n.size/2;this.ctx.beginPath(),this.ctx.arc(n.x,n.y,i,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill()}}},{key:"fill",value:function(e,t){var r;if(ne.isRect(e))r=e;else{if("number"==typeof e[0])e=new Nt(e);else if(!(e instanceof Nt))throw new Error("fill shape type missmatch, expected InkPath2D");r=e.bounds}return(r=this.bounds.intersect(r))&&(r=r.ceil(),this.ctx.fillStyle=t.toString(),ne.isRect(e)?this.ctx.fillRect(e.left,e.top,e.width,e.height):(this.ctx.save(),this.ctx.rect(r.left,r.top,r.width,r.height),this.ctx.clip(),this.drawPath(e),this.ctx.restore())),r}},{key:"blend",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t.mode||(t.mode=sr.SOURCE_OVER),t.transform&&t.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(t.sourceRect&&!t.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(t.destinationRect&&!t.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");t.rect&&(t.sourceRect=t.rect,t.destinationRect=t.rect),this.ctx.save(),t.transform?this.ctx.setTransform(t.transform.a,t.transform.b,t.transform.c,t.transform.d,t.transform.tx,t.transform.ty):t.clipRect&&(this.ctx.rect(t.clipRect.left,t.clipRect.top,t.clipRect.width,t.clipRect.height),this.ctx.clip()),this.ctx.globalCompositeOperation=t.mode,t.sourceRect&&t.destinationRect?this.ctx.drawImage(e.ctx.canvas,t.sourceRect.left,t.sourceRect.top,t.sourceRect.width,t.sourceRect.height,t.destinationRect.left,t.destinationRect.top,t.destinationRect.width,t.destinationRect.height):this.ctx.drawImage(e.ctx.canvas,0,0),this.ctx.restore()}},{key:"createImageData",value:function(e,t,r){return new ImageData(e,t,r)}},{key:"getImageData",value:function(e){e||(e=this.bounds);var t=this.ctx.getImageData(e.x,e.y,e.width,e.height);return t.x=e.x,t.y=e.y,t}},{key:"putImageData",value:function(e,t,r){if(!(e instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");(isNaN(t)||isNaN(r))&&(t=e.x||0,r=e.y||0),this.ctx.putImageData(e,t,r)}},{key:"readPixels",value:function(e){return this.getImageData(e).data}},{key:"writePixels",value:function(e,t){if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");t||(t=this.bounds),e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),this.putImageData(this.createImageData(e,t.width,t.height),t.x,t.y)}},{key:"getExportCanvas",value:function(e){var t=this.surface;return e&&(e=e.intersect(this.bounds).ceil(),(t=new OffscreenCanvas(e.width,e.height)).getContext("2d").putImageData(this.getImageData(e),0,0)),t}},{key:"resize",value:function(e,t){this.surface.width=e,this.surface.height=t}}]),r}(Cr);function Mr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Lr=function(e){g(r,e);var t=Mr(r);function r(e){return h(this,r),t.call(this,e)}return d(r,[{key:"createLayer",value:function(e,t){if(!e||!t){var n=r.getDefaultSize(this.width,this.height);e=n.width,t=n.height}var i=new OffscreenCanvas(e,t);return new Nr(i.getContext("2d",this.ctx.getContextAttributes()))}}],[{key:"createInstance",value:function(e,t,n,i){if(!e||"function"!=typeof e.getContext)throw new Error("CanvasRenderingContext2D context provider is required");if(t>0&&n>0&&(e.width=t,e.height=n),!(e.width>0&&e.width>0))throw new Error("width and height are required and should be positive whole numbers");return new r(e.getContext("2d",i))}}]),r}(Nr),_r=function(){function e(t,r){var n=this;h(this,e),this.canvas=t,this.layer=r||t.createLayer(),this.preliminaryLayer=void 0,this.ownLayer=!r,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=z.TRANSPERENT,this.blendMode=sr.SOURCE_OVER,this.transform=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,Object.defineProperty(this,"settings",{get:function(){return{brush:n.brush,color:n.color,backgroundColor:n.backgroundColor,blendMode:n.blendMode,transform:n.transform}},enumerable:!0})}return d(e,[{key:"configure",value:function(e){e.brush&&(this.brush=e.brush),e.color&&(this.color=e.color),e.backgroundColor&&(this.backgroundColor=e.backgroundColor),e.blendMode&&(this.blendMode=e.blendMode),"transform"in e&&this.setTransform(e.transform),this.restart=!0}},{key:"setTransform",value:function(e){this.transform=e,this.layer.setTransform(e),this.preliminaryLayer&&this.preliminaryLayer.setTransform(e)}},{key:"draw",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof Ir){var r=e,n=sr.SOURCE_OVER;if(!(r.brush instanceof We))throw new Error("Incompatible brush found. It should be Brush2D instance.");if(r.renderMode&&!(n=Ir.RenderMode.getBlendMode(r.renderMode)))return void console.warn("Cannot process ".concat(r.renderMode," render mode. Requres custom processing."));this.color=r.color,this.blendMode=r.style.blendMode||n,this.reset(),r.target=Ir.Target["2D"];var i=this.layer.draw(r);this.strokeBounds=i,this.updatedArea=i,this.restart=!0}else{if(!this.color)throw new Error("StrokeRenderer requires 'color' to be configured");if(this.restart&&this.reset(),this.validate(e)){var o=this.layer.drawStroke(this.brush,e,this.color,e.matrix);o&&(this.incompleteStrokeBounds=o.union(this.incompleteStrokeBounds),this.strokeBounds=o.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,t&&(this.restart=!0)}}},{key:"drawPreliminary",value:function(e){if(this.validate(e)){var t=null;this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(),this.preliminaryLayer.setTransform(this.transform)),t=this.preliminaryLayer):t=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&(this.preliminaryLayer.clear(this.updatedArea),this.preliminaryLayer.blend(this.layer,{mode:sr.SOURCE_OVER,rect:this.updatedArea})),this.preliminaryDirtyArea=t.drawStroke(this.brush,e,this.color,e.matrix),this.updatedArea=ne.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}}},{key:"abort",value:function(){this.restart=!0}},{key:"reset",value:function(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.color.alpha<1&&(this.alphaLayer?this.alphaLayer.resize(this.layer.width,this.layer.height):this.alphaLayer=this.canvas.createLayer(this.layer.width,this.layer.height)),this.restart=!1}},{key:"validate",value:function(e){return e&&e.length>0}},{key:"blendUpdatedArea",value:function(e){if(this.updatedArea){var t=e||this.canvas,r=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,n=t.bounds.intersect(this.updatedArea);if(n){var i=this.color.alpha;i<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=1,this.alphaLayer.blend(t,{rect:n}),this.alphaLayer.ctx.globalAlpha=i,this.alphaLayer.blend(r,{mode:this.blendMode,rect:n}),t.clear(n),t.blend(this.alphaLayer,{rect:n})):t.blend(r,{mode:this.blendMode,rect:n})}this.incompleteStrokeBounds=null,this.updatedArea=null}}},{key:"blendStroke",value:function(e,t,r){if(this.strokeBounds){r||(r=this.blendMode);var n=this.layer,i=e||this.canvas;if(t=i.bounds.intersect(t||this.strokeBounds)){var o=this.color.alpha;o<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=o,this.alphaLayer.blend(n,{rect:t}),i.blend(this.alphaLayer,{mode:r,rect:t})):i.blend(n,{mode:r,rect:t})}}}},{key:"toStroke",value:function(e,t){if(!this.brush)throw new Error("StrokeRenderer brush is not configured");var r=e.getSensorData(),n=e.getSpline(),i=e.getInkPath(t),o=new Ir(this.brush,n,i,r);return r&&(o.sensorDataMapping=r.inkStream.getPipelineMapping()),this.blendMode!=sr.SOURCE_OVER&&(o.renderMode=Ir.RenderMode.get(this.blendMode)),o}},{key:"delete",value:function(){console.warn("Not applicable with 2D API")}}]),e}(),Fr=void 0;I.typeGL==I.TypeGL.STACK&&(I.commonJS?Fr=require("gl"):console.warn("Current env - ".concat(I.type.name,", do not provides WebGL support")));var Br=Fr,Ur=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:150;h(this,e),this.width=t,this.height=r}return d(e,[{key:"getContext",value:function(){var e=arguments.length>1?arguments[1]:void 0;if(!this.context){var t=this.width,r=this.height;this.context=Br(t,r,e),this.context.canvas=this;var n=this.context.getExtension("STACKGL_resize_drawingbuffer");Object.defineProperty(this,"width",{get:function(){return t},set:function(e){t=e,n.resize(t,r)},enumerable:!0}),Object.defineProperty(this,"height",{get:function(){return t},set:function(e){r=e,n.resize(t,r)},enumerable:!0})}return this.context}},{key:"destroy",value:function(){this.context&&(this.context.getExtension("STACKGL_destroy_context").destroy(),delete this.context)}}]),e}(),jr=Br?Ur:void 0;function Gr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Yr=function(e){g(r,e);var t=Gr(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(h(this,r),(n=t.call(this)).inkGLContext=e,n.gl=e.gl,n.scaleFactor=i.scaleFactor||1,n.flipY=!!i.flipY,n.useTextureStorage=!1,i.renderbuffer){if(!i.framebuffer)throw new Error("`framebuffer` is required when `renderbuffer` available");var o=n.initWithGLBuffers(i.framebuffer,i.renderbuffer);n.flipY=!0,n.ownGLResources=!!i.ownGLResources,n.setDimensions(o.width,o.height)}else if(i.framebuffer){var a=n.initWithGLFramebuffer(i.framebuffer);n.flipY=!0,n.ownGLResources=!!i.ownGLResources,n.setDimensions(a.width,a.height)}else if(i.texture){if(!(i.texture instanceof WebGLTexture))throw new Error("`texture` is not instance of WebGLTexture");var s;if(n.texture=i.texture,n.useTextureStorage=!0,i.width>0&&i.height>0)s={width:i.width,height:i.height};else if(n.texture.image)s={width:n.texture.image.width,height:n.texture.image.height};else{if(!n.texture.size)throw new Error("`width` and `height` are required when `texture` is available");s=n.texture.size}n.ownGLResources=!!i.ownGLResources,n.setDimensions(s.width,s.height)}else if(n.setDimensions(i.width,i.height),i.display)n.framebuffer=null,n.renderbuffer=null,n.texture=null;else if(n.useTextureStorage=!i.useBuffersStorage,n.ownGLResources=!0,n.useTextureStorage){var u=n.inkGLContext.generateBuffersExt(n.storageWidth,n.storageHeight,n.gl.LINEAR,n.gl.UNSIGNED_BYTE);n.framebuffer=u.framebuffer,n.texture=u.texture}else{var l=n.inkGLContext.genFrameAndRenders(n.gl.RGBA8||n.gl.RGBA4,n.storageWidth,n.storageHeight);n.framebuffer=l.framebuffer,n.renderbuffer=l.renderbuffer}return n.releaseRenderbuffer=!1,n.deleted=!1,n}return d(r,[{key:"initWithGLFramebuffer",value:function(e){if(!(e instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");var t,r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.gl.getError()==this.gl.INVALID_OPERATION)throw new Error("Invalid framebuffer");if(this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!=this.gl.FRAMEBUFFER_COMPLETE)throw new Error("Incomplete framebuffer");if(this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)!=this.gl.RENDERBUFFER)throw new Error("Renderbuffer attachment not found");return t=this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,r),this.initWithGLBuffers(e,t)}},{key:"initWithGLBuffers",value:function(e,t){if(!(e instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");if(!(t instanceof WebGLRenderbuffer))throw new Error("`renderbuffer` is not instance of WebGLRenderbuffer");var r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,t);var n=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_WIDTH),i=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_HEIGHT);return this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,r),this.framebuffer=e,this.renderbuffer=t,{width:n,height:i}}},{key:"setDimensions",value:function(e,t){var r=Math.ceil(e*this.scaleFactor),n=Math.ceil(t*this.scaleFactor),i=new re(0,0,e,t),o=new re(0,0,r,n);Object.defineProperties(this,{width:{value:e,enumerable:!0,configurable:!0},height:{value:t,enumerable:!0,configurable:!0},graphicsBounds:{value:i,enumerable:!0,configurable:!0},storageWidth:{value:r,enumerable:!0,configurable:!0},storageHeight:{value:n,enumerable:!0,configurable:!0},storageBounds:{value:o,enumerable:!0,configurable:!0}})}},{key:"resize",value:function(e,t){e>0&&t>0&&(this.width!=e||this.height!=t)&&(this.setDimensions(e,t),this.useTextureStorage?(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.storageWidth,this.storageHeight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)):this.renderbuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.renderbuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.RGBA8||this.gl.RGBA4,this.storageWidth,this.storageHeight)))}},{key:"fillTexture",value:function(e){if(!this.texture)throw new Error("Underlying layer is not texture based");new cr(this.gl,this.texture).fill(e)}},{key:"delete",value:function(){this.ownGLResources&&(this.useTextureStorage?this.inkGLContext.deleteBuffers(this.framebuffer,this.texture):this.inkGLContext.deleteFrameAndRender(this.framebuffer,this.renderbuffer)),this.releaseRenderbuffer&&this.renderbuffer&&(this.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null,this.releaseRenderbuffer=!1),this.deleted=!0}},{key:"deleteLater",value:function(){var e=this;setTimeout((function(){return e.delete()}),0)}},{key:"isDeleted",value:function(){return this.deleted}}]),r}(Cr),zr=function(){function e(t){h(this,e),this.randomSeed=t||parseInt(Date.now()/1e3)}return d(e,[{key:"copyTo",value:function(e){e.randomSeed=this.randomSeed}}]),e}();function Xr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Vr=function(e){g(r,e);var t=Xr(r);function r(e,n){var i;return h(this,r),(i=t.call(this,e.inkGLContext,n)).convexHullChainProducer=new Jt,i.polygonSimplifier=new rr,Object.defineProperty(m(i),"inkContext",{value:e,enumerable:!0}),Object.defineProperty(m(i),"bounds",{get:function(){return ne.fromGLRect(i.graphicsBounds)},enumerable:!0}),i}return d(r,[{key:"clear",value:function(e,t){if(t){if(z.isColor(e))throw new Error("`clear` first argument should be Rect")}else z.isColor(e)?(t=e,e=null):t=z.TRANSPERENT;var r;if(ne.isRect(e)){if(!e.intersect(this.bounds))return;r=ne.fromRect(e).toGLRect()}Array.isArray(e)||e instanceof Float32Array?this.fill(e,t,!1):(this.inkContext.setTarget(this,r),this.inkContext.clearColor(t)),r&&this.inkContext.disableTargetClipRect()}},{key:"draw",value:function(e){var t,r=e.brush;return r instanceof dr?isFinite(e.randomSeed)&&(t=new zr(e.randomSeed)):t=e.color,this.drawStroke(r,e.path,t)}},{key:"drawStroke",value:function(e,t,r){if(!Ir.validatePath(t))return null;this.inkContext.setTarget(this);var n=this.inkContext.drawStroke(e,t,r);return n instanceof re&&(n=ne.fromGLRect(n)),n}},{key:"fill",value:function(e,t){var r,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=!1;if(ne.isRect(e))r=e,e=new Nt(e.toPath().points),i=!0;else{if("number"==typeof e[0])e=new Nt(e);else if(!(e instanceof Nt))throw new Error("fill shape type missmatch, expected InkPath2D");r=e.bounds}if(r=this.bounds.intersect(r)){i||(e=this.convexHullChainProducer.get(e)),e=this.polygonSimplifier.get(e);var o=this.inkContext.triangulate(e);o.length>0?(this.inkContext.setTarget(this),this.inkContext.fill(o,t,n)):r=void 0}return r?r.ceil():void 0}},{key:"blend",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t.mode||(t.mode=sr.SOURCE_OVER),t.rect&&!t.transform&&(t.sourceRect=t.rect,t.destinationRect=t.rect),t.transform&&t.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(t.sourceRect&&!t.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(t.destinationRect&&!t.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");if(this.inkContext.setTarget(this,ne.isRect(t.clipRect)?ne.fromRect(t.clipRect).toGLRect():void 0),"boolean"==typeof t.flipY&&(e.flipY=t.flipY),t.transform&&t.rect){var r=ne.fromRect(t.rect).toGLRect().toQuad(),n=ne.fromRect(t.rect).toGLRect().toQuad(t.transform);this.inkContext.drawLayer(e,r,n,t.mode)}else t.transform?this.inkContext.drawLayerWithTransform(e,t.transform,t.mode):t.sourceRect&&t.destinationRect?this.inkContext.drawLayer(e,ne.fromRect(t.sourceRect).toGLRect().toQuad(),ne.fromRect(t.destinationRect).toGLRect().toQuad(),t.mode):this.inkContext.drawLayerWithTransform(e,null,t.mode)}},{key:"createImageData",value:function(e,t,r){return e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),new ImageData(e,t,r)}},{key:"getImageData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e||(e=this.bounds);var r=this.createImageData(this.readPixels(e,t),e.width,e.height);return r.x=e.x,r.y=e.y,r}},{key:"putImageData",value:function(e,t,r){if(!(e instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");(isNaN(t)||isNaN(r))&&(t=e.x||0,r=e.y||0),this.writePixels(e.data,new ne(t,r,e.width,e.height))}},{key:"readPixels",value:function(e,t){e&&(e=ne.fromRect(e).toGLRect()),this.inkContext.setTarget(this);var r=this.inkContext.readPixels(e);if(t)for(var n=0;n<r.length;n+=4){var i=r[n+3];r[n]=parseInt(255*r[n]/i),r[n+1]=parseInt(255*r[n+1]/i),r[n+2]=parseInt(255*r[n+2]/i)}return r}},{key:"writePixels",value:function(e,t){if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");t&&(t=ne.fromRect(t).toGLRect()),this.inkContext.setTarget(this),this.inkContext.writePixels(t,e)}},{key:"getExportCanvas",value:function(e){e=e?e.intersect(this.bounds).ceil():this.bounds;var t=new OffscreenCanvas(e.width,e.height);return t.getContext("2d").putImageData(this.getImageData(e,!0),0,0),t}}]),r}(Yr),Hr=I.commonJS?require("poly2tri"):globalThis.poly2tri,qr=Hr.SweepContext,Zr=Hr.Point,Wr=function(){function e(t){if(h(this,e),!t)throw new Error("GL context is not available in current environment");var r;this.gl=t,this.program=null,this.programs=[],Object.defineProperty(this,"blendMode",{get:function(){return r},set:function(e){if(!e)throw new Error("blendMode is required");r!=e&&(this.activeBlendMode(e),r=e)},enumerable:!0}),Object.defineProperty(e,"VERTEX_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.VERTEX_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(e,"FRAGMENT_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.FRAGMENT_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(e,"VERTEX_BATCH_SIZE",{value:1e3,enumerable:!0})}return d(e,[{key:"init",value:function(e,t){this.gl.disable(this.gl.DITHER),this.gl.disable(this.gl.BLEND),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.blendMinMaxExt=this.gl.getExtension("EXT_blend_minmax"),this.blendMaxFallback=!this.gl.MAX&&!this.blendMinMaxExt,this.blendMode=sr.COPY,this.resize(e,t),this.scatterMethodRandomSeed=parseInt(Date.now()/1e3),this.onChange();for(var r=0;r<this.programs.length;r++)this.programs[r].init()}},{key:"getSupportedFloatPrecision",value:function(e){return this.gl.getShaderPrecisionFormat(e,this.gl.HIGH_FLOAT).precision>0?"highp":this.gl.getShaderPrecisionFormat(e,this.gl.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}},{key:"random",value:function(){return this.scatterMethodRandomSeed=1103515245*this.scatterMethodRandomSeed+12345&2147483647,this.scatterMethodRandomSeed/2147483647}},{key:"setUniforms",value:function(e){var t=i.mat4.create();this._scaleVectorAbs=new Float32Array([this.bounds.width/this.graphicsBox.width,this.bounds.height/this.graphicsBox.height]),e?i.mat4.ortho(t,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.top,this.graphicsBox.bottom,1,-1):i.mat4.ortho(t,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.bottom,this.graphicsBox.top,1,-1),this._graphicsSpaceToFramebufferSpaceT=t,this.onChange()}},{key:"resize",value:function(e,t){this.gl.viewport(e.x,e.y,e.width,e.height),this.bounds=e,this.graphicsBox=t,this._clipRect=this.graphicsBox}},{key:"activeBlendMode",value:function(e){switch(e){case sr.COPY:this.gl.disable(this.gl.BLEND);break;case sr.SOURCE_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA);break;case sr.DESTINATION_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE_MINUS_DST_ALPHA,this.gl.ONE);break;case sr.DESTINATION_IN:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_ALPHA);break;case sr.DESTINATION_OUT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_ALPHA);break;case sr.DESTINATION_IN_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_COLOR);break;case sr.DESTINATION_OUT_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR);break;case sr.LIGHTER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case sr.MIN:this.gl.enable(this.gl.BLEND),this.gl.MIN?this.gl.blendEquation(this.gl.MIN):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MIN_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case sr.MAX:this.gl.enable(this.gl.BLEND),this.gl.MAX?this.gl.blendEquation(this.gl.MAX):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MAX_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case sr.SUBTRACT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case sr.SUBTRACT_REVERSE:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;default:throw new Error("Unsupported blend mode: ".concat(e))}}},{key:"clearColorBuffer",value:function(e){this.gl.clearColor(e.red*e.alpha/255,e.green*e.alpha/255,e.blue*e.alpha/255,e.alpha),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}},{key:"scissors",value:function(e){if(e&&!(e instanceof re))throw new TypeError("rect must be undefined or instanceof RectGL");var t=this.gl.isEnabled(this.gl.SCISSOR_TEST);e?(t||this.gl.enable(this.gl.SCISSOR_TEST),this.gl.scissor(e.x,e.y,e.width,e.height)):t&&this.gl.disable(this.gl.SCISSOR_TEST)}},{key:"isProgramActive",value:function(e){return this.program==e}},{key:"activateProgram",value:function(e){this.isProgramActive(e)?e.contextChanged&&(e.onContextChange(),e.contextChanged=!1):(this.program&&this.program.onDeactivate(),this.gl.useProgram(e.program),this.program=e,e.onActivate(),e.onContextChange(),e.contextChanged=!1)}},{key:"generateBuffersExt",value:function(e,t,r,n){var i=this.gl,o=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,o);var a=i.createTexture();return i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,a),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,n,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,a,0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),{framebuffer:o,texture:a}}},{key:"genFrameAndRenders",value:function(e,t,r){var n=this.gl.createFramebuffer(),i=this.gl.createRenderbuffer();return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,n),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,i),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,e,t,r),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,i),{framebuffer:n,renderbuffer:i}}},{key:"deleteBuffers",value:function(e,t){t&&this.gl.deleteTexture(t),e&&this.gl.deleteFramebuffer(e)}},{key:"deleteFrameAndRender",value:function(e,t){t&&this.gl.deleteRenderbuffer(t),e&&this.gl.deleteFramebuffer(e)}},{key:"onChange",value:function(){for(var e=0;e<this.programs.length;e++)this.programs[e].contextChanged=!0}},{key:"enableStencilBufferForBlending",value:function(e){this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilMask(4294967295),this.gl.clearStencil(0),this.gl.clear(this.gl.STENCIL_BUFFER_BIT),this.isStencilBufferAvailable()||this.attachStencilBufferForBlending(e)}},{key:"isStencilBufferAvailable",value:function(){return this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)==this.gl.RENDERBUFFER}},{key:"attachStencilBufferForBlending",value:function(e){var t=this.gl.getParameter(this.gl.FRAMEBUFFER_BINDING);if(e.framebuffer==t){var r=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,r),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.STENCIL_INDEX8,e.width,e.height),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.RENDERBUFFER,r),e.renderbuffer=r,e.releaseRenderbuffer=!0}}},{key:"drawArrays",value:function(e,t,r){this.blendMode==sr.MAX&&this.blendMaxFallback?this.drawBlendMaxFallback(this.gl.drawArrays.bind(this.gl,e,t,r)):this.gl.drawArrays(e,t,r)}},{key:"drawElements",value:function(e,t,r,n){this.blendMode==sr.MAX&&this.blendMaxFallback?this.drawBlendMaxFallback(this.gl.drawElements.bind(this.gl,e,t,r,n)):this.gl.drawElements(e,t,r,n)}},{key:"drawBlendMaxFallback",value:function(e){this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilFunc(this.gl.NOTEQUAL,1,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),e(),this.gl.stencilFunc(this.gl.NOTEQUAL,2,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_ADD),e(),this.gl.disable(this.gl.STENCIL_TEST)}}],[{key:"random",value:function(e){return(1103515245*e+12345&2147483647)/2147483647}}]),e}(),Kr=function(){function e(t){h(this,e),Object.defineProperties(this,{inkGLContext:{value:t,enumerable:!0},gl:{value:t.gl,enumerable:!0}}),this.program=this.createProgram(this.compileShader(this.constructor.getVertexShader(),this.gl.VERTEX_SHADER),this.compileShader(this.constructor.getFragmentShader(this.gl.getContextAttributes().premultipliedAlpha),this.gl.FRAGMENT_SHADER)),this.contextChanged=!0}return d(e,[{key:"init",value:function(){}},{key:"compileShader",value:function(e,t){var r=this.gl.createShader(t);if(this.gl.shaderSource(r,e),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS))throw new Error("".concat(this.constructor.name," could not compile shader: ").concat(this.gl.getShaderInfoLog(r)));return r}},{key:"createProgram",value:function(e,t){var r=this.gl.createProgram();if(this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),!this.gl.getProgramParameter(r,this.gl.LINK_STATUS))throw new Error("".concat(this.constructor.name," failed to link: ").concat(this.gl.getProgramInfoLog(r)));return r}},{key:"onActivate",value:function(){}},{key:"onDeactivate",value:function(){}},{key:"onContextChange",value:function(){}},{key:"activate",value:function(){this.inkGLContext.activateProgram(this)}}]),e}();function Jr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Qr=function(e){g(r,e);var t=Jr(r);function r(e){var n;return h(this,r),(n=t.call(this,e)).vertsBuffer=n.gl.createBuffer(),n.colorsBuffer=n.gl.createBuffer(),n}return d(r,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix")}},{key:"onContextChange",value:function(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawVertices",value:function(e,t,r){this.activate(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),e.length&&this.inkGLContext.drawArrays(this.gl.TRIANGLES,0,e.length/2)}},{key:"drawPathVerticesPatch",value:function(e,t,r){this.activate(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),e.length&&(this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.drawArrays(this.gl.TRIANGLES,0,e.length/2),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.drawArrays(this.gl.TRIANGLES,0,e.length/2))}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Wr.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute lowp vec4 a_color;\n\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_color = a_color;\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(){return"\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = v_color;\n\t\t\t}\n\t\t"}}]),r}(Kr);function $r(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var en=function(e){g(r,e);var t=$r(r);function r(e){var n;return h(this,r),(n=t.call(this,e)).destBuffer=n.gl.createBuffer(),n.srcBuffer=n.gl.createBuffer(),n}return d(r,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_srcPosition=this.gl.getAttribLocation(this.program,"a_srcPosition"),this.u_texture=this.gl.getUniformLocation(this.program,"u_texture"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_textureMatrix=this.gl.getUniformLocation(this.program,"u_textureMatrix")}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawTexture",value:function(e,t,r,n,i){this.activate(),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(this.u_texture,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.destBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.srcBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_srcPosition),this.gl.vertexAttribPointer(this.a_srcPosition,2,this.gl.FLOAT,!1,0,0),this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,n),this.gl.uniformMatrix4fv(this.u_textureMatrix,!1,i),this.inkGLContext.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Wr.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform mat4 u_textureMatrix;\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute highp vec4 a_srcPosition;\n\t\t\tvarying highp vec2 v_textureCoordinate;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_textureCoordinate = (u_textureMatrix * a_srcPosition).xy;\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(){return"\n\t\t\tprecision ".concat(Wr.FRAGMENT_SHADER_PRECISION," float;\n\n\t\t\tvarying vec2 v_textureCoordinate;\n\t\t\tuniform lowp sampler2D u_texture;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_textureCoordinate);\n\t\t\t}\n\t\t")}}]),r}(Kr);function tn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var rn=function(e){g(r,e);var t=tn(r);function r(e){var n;return h(this,r),(n=t.call(this,e)).buffer=n.gl.createBuffer(),n.indexBuffer=n.gl.createBuffer(),n}return d(r,[{key:"init",value:function(){this.a_coordinates=this.gl.getAttribLocation(this.program,"a_coordinates"),this.a_xys=this.gl.getAttribLocation(this.program,"a_xys"),this.a_spriteRotation=this.gl.getAttribLocation(this.program,"a_spriteRotation"),this.a_spriteScaleAndOffset=this.gl.getAttribLocation(this.program,"a_spriteScaleAndOffset"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.a_velocity=this.gl.getAttribLocation(this.program,"a_velocity"),this.a_transformParams=this.gl.getAttribLocation(this.program,"a_transformParams"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_fillTextureSize=this.gl.getUniformLocation(this.program,"u_fillTextureSize"),this.u_fillTextureOffset=this.gl.getUniformLocation(this.program,"u_fillTextureOffset"),this.u_shapeTexture=this.gl.getUniformLocation(this.program,"u_shapeTexture"),this.u_fillTexture=this.gl.getUniformLocation(this.program,"u_fillTexture")}},{key:"setBrush",value:function(e){this.brush=e,this.brushChanged=!0}},{key:"onActivate",value:function(){this.brushChanged=!0,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var e=19*Float32Array.BYTES_PER_ELEMENT;this.gl.vertexAttribPointer(this.a_coordinates,2,this.gl.FLOAT,!1,e,0*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_xys,3,this.gl.FLOAT,!1,e,2*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_spriteRotation,1,this.gl.FLOAT,!1,e,5*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_spriteScaleAndOffset,4,this.gl.FLOAT,!1,e,6*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,e,10*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_velocity,2,this.gl.FLOAT,!1,e,14*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_transformParams,3,this.gl.FLOAT,!1,e,16*Float32Array.BYTES_PER_ELEMENT),this.gl.enableVertexAttribArray(this.a_coordinates),this.gl.enableVertexAttribArray(this.a_xys),this.gl.enableVertexAttribArray(this.a_spriteRotation),this.gl.enableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.enableVertexAttribArray(this.a_color),this.gl.enableVertexAttribArray(this.a_velocity),this.gl.enableVertexAttribArray(this.a_transformParams)}},{key:"onContextChange",value:function(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}},{key:"onDeactivate",value:function(){this.gl.disableVertexAttribArray(this.a_coordinates),this.gl.disableVertexAttribArray(this.a_xys),this.gl.disableVertexAttribArray(this.a_spriteRotation),this.gl.disableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.disableVertexAttribArray(this.a_color),this.gl.disableVertexAttribArray(this.a_velocity),this.gl.disableVertexAttribArray(this.a_transformParams),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"updateTextures",value:function(){this.brushChanged&&(this.brushChanged=!1,this.gl.uniform2f(this.u_fillTextureOffset,this.brush.fillTextureOffset.x,this.brush.fillTextureOffset.y),this.gl.uniform2f(this.u_fillTextureSize,this.brush.fillTextureSize.width,this.brush.fillTextureSize.height),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.shapeTexture.value),this.gl.uniform1i(this.u_shapeTexture,0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.fillTexture.value),this.gl.uniform1i(this.u_fillTexture,1))}},{key:"drawSpritesBatch",value:function(e,t){var r,n=this;this.activate(),this.updateTextures();var i=t*Wr.VERTEX_BATCH_SIZE,o=i+Wr.VERTEX_BATCH_SIZE;o>e.length&&(o=i+e.length%Wr.VERTEX_BATCH_SIZE);for(var a=o-i,s=new Float32Array(76*a),u=new Uint16Array(6*a),l=this.brush.rotationMode==dr.RotationMode.TRAJECTORY?1:0,c=function(t){var o=e.getPoint(t),a=76*(t-i),u=re.calculateBrushGLSegmentBounds(o,n.brush.scattering);r=u.union(r);var c=o.red/255*o.alpha,h=o.green/255*o.alpha,f=o.blue/255*o.alpha;0==o.dX&&0==o.dY&&(o.dX=2*n.inkGLContext.random()-1,o.dY=2*n.inkGLContext.random()-1);var d=n.brush.rotationMode==dr.RotationMode.RANDOM?2*n.inkGLContext.random()*Math.PI:0,p=(2*n.inkGLContext.random()-1)*n.brush.scattering;re.SQURE.forEach((function(e,t){var r=a+19*t;s[r]=e.x,s[r+1]=e.y,s[r+2]=o.x,s[r+3]=o.y,s[r+4]=o.size,s[r+5]=o.rotation,s[r+6]=o.scaleX,s[r+7]=o.scaleY,s[r+8]=o.offsetX,s[r+9]=o.offsetY,s[r+10]=c,s[r+11]=h,s[r+12]=f,s[r+13]=o.alpha,s[r+14]=o.dX,s[r+15]=o.dY,s[r+16]=l,s[r+17]=d,s[r+18]=p}))},h=i;h<o;h++)c(h);for(var f=0,d=0;d<u.length;d+=6)u[d]=f,u[d+1]=f+1,u[d+2]=f+2,u[d+3]=f+2,u[d+4]=f+1,u[d+5]=f+3,f+=4;return this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,u,this.gl.STATIC_DRAW),this.inkGLContext.drawElements(this.gl.TRIANGLES,u.length,this.gl.UNSIGNED_SHORT,0),r}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Wr.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform vec2 u_fillTextureSize;\n\t\t\tuniform vec2 u_fillTextureOffset;\n\n\t\t\tattribute lowp vec4 a_color;\n\t\t\t/* (x,y) is the center. z is the offset by x, w is the offset by y */\n\t\t\tattribute highp vec2 a_coordinates;\n\t\t\t/* the velocity at that point. It is the derivative of the function */\n\t\t\tattribute vec2 a_velocity;\n\t\t\t/* 1-shape trajectory rotation coficient, 2-shape randrom rotation angle, 3-scattering value */\n\t\t\tattribute vec3 a_transformParams;\n\n\t\t\t/* sprite rotation angle */\n\t\t\tattribute highp float a_spriteRotation;\n\t\t\t/* sprite's: 1-scaleX, 2-scaleY, 3-offsetX, 4-offsetY */\n\t\t\tattribute highp vec4 a_spriteScaleAndOffset;\n\n\t\t\tvarying lowp vec4 v_color;\n\t\t\tattribute vec3 a_xys;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tmat2 trajectoryRotate(vec2 vNormal, float value) {\n\t\t\t\tvec2 base = vec2(1.0, 0.0);\n\n\t\t\t\tvec2 vNormalR = mix(base, vNormal, value);\n\t\t\t\tvNormalR = normalize(vNormalR);\n\n\t\t\t\tfloat cosfi = dot(vNormalR, base);\n\t\t\t\tfloat sinfi = vNormalR.x * base.y - vNormalR.y * base.x;\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 angleRotate2(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 scale2(float sx, float sy) {\n\t\t\t\treturn mat2(sx, 0.0, 0.0, sy);\n\t\t\t}\n\n\t\t\tmat3 rotate2h(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat3(\n\t\t\t\t\tcosfi, -sinfi, 0.0,\n\t\t\t\t\tsinfi, cosfi, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 scale2h(float sx, float sy) {\n\t\t\t\treturn mat3(\n\t\t\t\t\tsx, 0.0, 0.0,\n\t\t\t\t\t0.0, sy, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 translate2h(float tx, float ty) {\n\t\t\t\treturn mat3(\n\t\t\t\t\t1.0, 0.0, 0.0,\n\t\t\t\t\t0.0, 1.0, 0.0,\n\t\t\t\t\ttx, ty, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tvec2 orthoOffset(vec2 vNormal, float value) {\n\t\t\t\tvec2 vno = vec2(vNormal.y * value, vNormal.x * value);\n\t\t\t\treturn vno;\n\t\t\t}\n\n\t\t\tvoid main() {\n\t\t\t\tfloat halfSize = a_xys.z / 2.0;\n\t\t\t\tvec2 vNormal = normalize(a_velocity);\n\n\t\t\t\t// Because this applied to the texture, the y reversed because the texture coordinate system y is increasing downwards.\n\t\t\t\tvNormal.y = -vNormal.y;\n\n\t\t\t\tfloat spriteRotation = a_spriteRotation;\n\t\t\t\tvec4 spriteScaleAndOffset = a_spriteScaleAndOffset;\n\t\t\t\tspriteScaleAndOffset.y = -spriteScaleAndOffset.y;\n\t\t\t\tspriteScaleAndOffset.w = -spriteScaleAndOffset.w;\n\n\t\t\t\tmat2 productRotateMatrix = angleRotate2(a_transformParams.y) * trajectoryRotate(vNormal, a_transformParams.x);\n\t\t\t\tvec2 scatterOffset = orthoOffset(vNormal, a_transformParams.z * halfSize);\n\t\t\t\tvec2 transformedCoordinates = productRotateMatrix * a_coordinates;\n\n\t\t\t\tvec3 coordinatesH = vec3(transformedCoordinates.x, transformedCoordinates.y, 1.0);\n\t\t\t\tcoordinatesH = rotate2h(spriteRotation) * translate2h(spriteScaleAndOffset.z, spriteScaleAndOffset.w) * scale2h(spriteScaleAndOffset.x * halfSize, spriteScaleAndOffset.y * halfSize) * coordinatesH;\n\t\t\t\tvec2 coordinates = coordinatesH.xy;\n\n\t\t\t\tvec2 offset = coordinates + scatterOffset;\n\t\t\t\tvec4 position = vec4(a_xys.x + offset.x, a_xys.y + offset.y, 0.0, 1.0);\n\n\t\t\t\tv_color = a_color;\n\t\t\t\tgl_Position = u_projectionMatrix * position;\n\t\t\t\tv_fillTexturePosition = position.xy / u_fillTextureSize + u_fillTextureOffset;\n\t\t\t\tv_shapeTexturePosition = (a_coordinates + 1.0) * 0.5; /* [-1;1] -> [0;1] */\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(e){return"\n\t\t\tuniform lowp sampler2D u_shapeTexture;\n\t\t\tuniform lowp sampler2D u_fillTexture;\n\n\t\t\t/* lowp seems to lead to an overflow on PowerVR SGX540, so use mediump instead :)*/\n\t\t\tvarying mediump vec4 v_color;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tvoid main() {\n\t\t\t\tlowp vec4 c = v_color * texture2D(u_shapeTexture, v_shapeTexturePosition) * texture2D(u_fillTexture, v_fillTexturePosition);\n\n\t\t\t\tgl_FragColor = ".concat(e?"c":"vec4(c.x / c.w, c.y / c.w, c.z / c.w, c.w * 255.0)",";\n\t\t\t}\n\t\t")}}]),r}(Kr),nn=function(){function e(t,r){h(this,e);var n=t.getContext("webgl2",r)||t.getContext("webgl",r);this.inkGLContext=new Wr(n),this.gl=this.inkGLContext.gl,this.simpleProgram=new Qr(this.inkGLContext),this.textureProgram=new en(this.inkGLContext),this.spriteProgram=new rn(this.inkGLContext),this.inkGLContext.programs=[this.simpleProgram,this.textureProgram,this.spriteProgram],this.currentTarget=null,this.inkGLContext.init(new re(0,0,0,0),new re(0,0,0,0))}return d(e,[{key:"createLayer",value:function(e,t){return new Yr(this.inkGLContext,e,t)}},{key:"drawLayerWithTransform",value:function(e,t,r){if(this.currentTarget){var n=e.graphicsBounds.toQuad(),i=e.graphicsBounds.toQuad(t);this.drawLayer(e,n,i,r)}}},{key:"drawLayer",value:function(e,t,r,n){if(this.currentTarget&&e.useTextureStorage){var o=i.mat4.create(),a=i.mat4.create(),s=this.currentTarget;s.flipY?i.mat4.ortho(a,0,s.width,s.height,0,1,-1):i.mat4.ortho(a,0,s.width,0,s.height,1,-1),e.flipY?i.mat4.ortho(o,-e.width,e.width,2*e.height,0,0,1):i.mat4.ortho(o,-e.width,e.width,-e.height,e.height,0,1),this.inkGLContext.blendMode=n,this.textureProgram.drawTexture(e.texture,r,t,a,o)}}},{key:"setTarget",value:function(e,t){var r=this.inkGLContext,n=r.gl;if(e&&!(e instanceof Yr))throw new TypeError("layer must be unset or instanceof InkLayer");if(t&&!(t instanceof re))throw new TypeError("clipRect must be unset or instanceof RectGL");if(e){this.currentTarget=e;var i=new re(0,0,e.storageWidth,e.storageHeight),o=new re(0,0,e.width,e.height);r.resize(i,o),r.setUniforms(e.flipY),t?this.setTargetClipRect(t):this.disableTargetClipRect(),n.bindFramebuffer(n.FRAMEBUFFER,e.framebuffer)}}},{key:"clearColor",value:function(e){this.inkGLContext.clearColorBuffer(e)}},{key:"setTargetClipRect",value:function(e){var t=this.inkGLContext;e=e.floor().intersect(this.currentTarget.graphicsBounds),t._clipRect=e;var r=this.currentTarget.scaleFactor;e=this.currentTarget.flipY?new re(e.x,this.currentTarget.storageHeight-e.top,e.width,e.height):new re(e.x*r,e.y*r,e.width*r,e.height*r),t.scissors(e)}},{key:"disableTargetClipRect",value:function(){var e=this.inkGLContext;e.scissors(null),e._clipRect=e.graphicsBox}},{key:"drawStroke",value:function(e,t,r){return this.currentTarget?0==t.length?null:(this.inkGLContext.blendMaxFallback&&e.blendMode==sr.MAX&&this.inkGLContext.enableStencilBufferForBlending(this.currentTarget),e instanceof dr?this.drawGL(e,t,r):this.draw2D(e,t,r)):null}},{key:"drawGL",value:function(e,t,r){var n,i=null,o=this.inkGLContext._clipRect;r&&(n=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=r.randomSeed),e.blendMode?this.inkGLContext.blendMode=e.blendMode:this.inkGLContext.blendMode=sr.SOURCE_OVER,this.spriteProgram.setBrush(e);for(var a=Math.ceil(t.length/Wr.VERTEX_BATCH_SIZE),s=0;s<a;s++){i=this.spriteProgram.drawSpritesBatch(t,s).union(i)}return r&&(r.randomSeed=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=n),(i=o.intersect(i))&&(i=i.ceil()),i}},{key:"draw2D",value:function(e,t,r){var n=this,i=this.currentTarget.bounds.intersect(t.bounds);if(!i)return null;if(e.spacing>1)t.forEach((function(e){var t=n.triangulate([e]);n.fillStroke(t,r)}));else{var o=this.triangulate(t);this.fillStroke(o,r)}return i}},{key:"triangulate",value:function(e){var t=[],r=[],n=0;e.forEach((function(e){for(var t=[],i=0;i<e.length;i+=2){var o=new Zr(e[i],e[i+1]);o.index=n++,t.push(o)}r.push(t)}));var i=new qr(r.shift());r.forEach((function(e){return i.addHole(e)}));var o=[];try{i.triangulate(),o=i.getTriangles()}catch(e){console.warn(e)}return t.index=[],o.forEach((function(e){var r=e.getPoints().filter((function(e){return isFinite(e.index)}));3==r.length?r.forEach((function(e){t.push(e.x,e.y),t.index.push(e.index)})):console.warn("Undefined triangle:",e.getPoints())})),t}},{key:"fillStroke",value:function(e,t){this.fill(e,t,!0,!0)}},{key:"fill",value:function(e,t,r,n){t=t.premultiply();for(var i=r?4:1,o=i*i,a=1.01/o,s=1.25,u=s/i,l=r?new z(a*t.red,a*t.green,a*t.blue,a*t.alpha):t,c=new Float32Array(e.length*o),h=new Float32Array(2*e.length*o),f=0,d=0,p=0;p<i;p++)for(var y=0;y<i;y++)for(var v={x:p*u-(s-u)/2,y:y*u-(s-u)/2},g=0;g<e.length;g+=6)for(var m=[{x:e[g],y:e[g+1]},{x:e[g+2],y:e[g+3]},{x:e[g+4],y:e[g+5]}],b=0;b<3;b++)c[f++]=m[b%3].x+v.x,c[f++]=m[b%3].y+v.y,h[d++]=l.red,h[d++]=l.green,h[d++]=l.blue,h[d++]=l.alpha;var E=sr.SOURCE_OVER;n?E=sr.MAX:r?E=sr.LIGHTER:t.equals(z.TRANSPERENT)&&(E=sr.COPY),this.inkGLContext.blendMode=E,this.inkGLContext.gl.bindFramebuffer(this.inkGLContext.gl.FRAMEBUFFER,this.currentTarget.framebuffer),n?this.simpleProgram.drawPathVerticesPatch(c,h):this.simpleProgram.drawVertices(c,h)}},{key:"readPixels",value:function(e){var t=this.currentTarget,r=this.inkGLContext.gl;if(e){if(!(e instanceof re))throw new TypeError("box must be instance of RectGL")}else e=t.graphicsBounds;t.flipY&&(e=new re(e.x,t.height-e.y-e.height,e.width,e.height)),this.setTarget(t);var n=new Uint8Array(e.width*e.height*4);return r.readPixels(parseInt(e.x*t.scaleFactor),parseInt(e.y*t.scaleFactor),parseInt(e.width*t.scaleFactor),parseInt(e.height*t.scaleFactor),r.RGBA,r.UNSIGNED_BYTE,n),n}},{key:"writePixels",value:function(e,t){if(e&&!(e instanceof re))throw new TypeError("rect must be instance of RectGL");var r=this.currentTarget,n=this.inkGLContext.gl;if(e||(e=new re(0,0,r.width,r.height)),!r.useTextureStorage)throw new Error("writePixels layer without texture is not supported!");r.flipY&&(e=new re(e.x,r.height-e.y-e.height,e.width,e.height));var i=new re(e.x*r.scaleFactor,e.y*r.scaleFactor,e.width*r.scaleFactor,e.height*r.scaleFactor);n.finish(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,r.texture),n.texSubImage2D(n.TEXTURE_2D,0,parseInt(i.x),parseInt(i.y),parseInt(i.width),parseInt(i.height),n.RGBA,n.UNSIGNED_BYTE,t)}}]),e}();function on(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var an=function(e){g(n,e);var t,r=on(n);function n(e){var t,i;h(this,n),i=r.call(this,e,{display:!0,width:e.inkGLContext.gl.canvas.width,height:e.inkGLContext.gl.canvas.height,flipY:I.typeGL==I.TypeGL.WEB}),Object.defineProperty(m(i),"surface",{value:e.inkGLContext.gl.canvas,enumerable:!0}),Object.defineProperty(m(i),"ctx",{value:e.inkGLContext.gl,enumerable:!0}),Object.defineProperty(m(i),"MAX_SIZE",{value:4096,enumerable:!0});var o=i.ctx.getContextAttributes();if("function"==typeof requestAnimationFrame&&!o.preserveDrawingBuffer){var a=i.createLayer();Object.defineProperty(m(i),"backbuffer",{value:a,enumerable:!0});i.frameID=requestAnimationFrame((function e(r){i.present&&(delete i.present,V((t=m(i),E(n.prototype)),"blend",t).call(t,a,{mode:sr.COPY})),i.frameID=requestAnimationFrame(e)}))}return i}return d(n,[{key:"createLayer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.width,r=e.height;if(t&&r){if(t>this.MAX_SIZE)throw new Error("Max width exceeded: ".concat(t," found, ").concat(this.MAX_SIZE," allowed"));if(r>this.MAX_SIZE)throw new Error("Max height exceeded: ".concat(r," found, ").concat(this.MAX_SIZE," allowed"))}else{var i=n.getDefaultSize(this.width,this.height);e.width=i.width,e.height=i.height}return new Vr(this.inkContext,e)}},{key:"clear",value:function(e,t){this.backbuffer?(this.backbuffer.clear(e,t),this.present=!0):V(E(n.prototype),"clear",this).call(this,e,t)}},{key:"draw",value:function(e,t){var r;return this.backbuffer?(r=this.backbuffer.draw(e,t),this.present=!0):r=V(E(n.prototype),"draw",this).call(this,e,t),r}},{key:"drawStroke",value:function(e,t,r){var i;return this.backbuffer?(i=this.backbuffer.drawStroke(e,t,r),this.present=!0):i=V(E(n.prototype),"drawStroke",this).call(this,e,t,r),i}},{key:"fill",value:function(e,t,r){var i;return this.backbuffer?(i=this.backbuffer.fill(e,t,r),this.present=!0):i=V(E(n.prototype),"fill",this).call(this,e,t,r),i}},{key:"blend",value:function(e,t){this.backbuffer?(this.backbuffer.blend(e,t),this.present=!0):V(E(n.prototype),"blend",this).call(this,e,t)}},{key:"readPixels",value:function(e,t){return this.backbuffer?this.backbuffer.readPixels(e,t):V(E(n.prototype),"readPixels",this).call(this,e,t)}},{key:"writePixels",value:function(e,t){this.backbuffer?(this.backbuffer.writePixels(e,t),this.present=!0):V(E(n.prototype),"writePixels",this).call(this,e,t)}},{key:"toBlob",value:(t=de(he.mark((function e(){var t,r,i,o=arguments;return he.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=o.length>0&&void 0!==o[0]?o[0]:this.bounds,r=o.length>1?o[1]:void 0,i=o.length>2?o[2]:void 0,!this.backbuffer){e.next=9;break}return e.next=6,this.backbuffer.toBlob(t,r,i);case 6:return e.abrupt("return",e.sent);case 9:return e.next=11,V(E(n.prototype),"toBlob",this).call(this,t,r,i);case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"resize",value:function(e,t){V(E(n.prototype),"resize",this).call(this,e,t),this.surface.width=e,this.surface.height=t}},{key:"delete",value:function(){"number"==typeof this.frameID&&cancelAnimationFrame(this.frameID),V(E(n.prototype),"delete",this).call(this),this.backbuffer&&this.backbuffer.delete()}},{key:"deleteLater",value:function(){return V(E(n.prototype),"deleteLater",this).call(this),this.backbuffer&&this.backbuffer.deleteLater(),this}}],[{key:"createInstance",value:function(e,t,r,i){if(!e||"function"!=typeof e.getContext)throw new Error("WebGL context provider is required");if(t>0&&r>0&&(e.width=t,e.height=r),!(e.width>0&&e.width>0))throw new Error("width and height are required and should be positive whole numbers");return new n(new nn(e,i))}},{key:"logGLError",value:function(e){var t=e.getError();if(t>0){var r=Object.keys(e.constructor.prototype).filter((function(r){return e[r]===t})).join(" | ");console.error("WebGL: ".concat(t," - ").concat(r))}}}]),n}(Vr),sn=function(){function e(t,r){var n=this;h(this,e),this.canvas=t;var i=r instanceof Vr?r:void 0,o=r&&!i?r:new Object;this.layer=i||t.createLayer(o),this.preliminaryLayer=void 0,this.layerOptions=o,this.ownLayer=!i,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=z.TRANSPERENT,this.blendMode=sr.SOURCE_OVER,this.randomSeed=void 0,this.transform=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,this.streamUpdatedArea=void 0,Object.defineProperty(this,"settings",{get:function(){return{brush:n.brush,color:n.color,backgroundColor:n.backgroundColor,blendMode:n.blendMode,transform:n.transform,randomSeed:n.initialRandomSeed}},enumerable:!0})}return d(e,[{key:"configure",value:function(e){e.brush&&(this.brush=e.brush),e.color&&(this.color=e.color),e.backgroundColor&&(this.backgroundColor=e.backgroundColor),e.blendMode&&(this.blendMode=e.blendMode),"transform"in e&&this.setTransform(e.transform),this.brush instanceof dr&&isFinite(e.randomSeed)&&(this.initialRandomSeed=e.randomSeed),this.restart=!0}},{key:"setTransform",value:function(e){this.transform=e,this.layer.setTransform(e),this.preliminaryLayer&&this.preliminaryLayer.setTransform(e)}},{key:"draw",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.layer.isDeleted())throw new Error("StrokeRenderer cannot draw, it is already deleted");if(this.restart&&this.reset(),e instanceof Ir){var r,n=e,i=sr.SOURCE_OVER;if(n.renderMode&&!(i=Ir.RenderMode.getBlendMode(n.renderMode)))return void console.warn("Cannot process ".concat(n.renderMode," render mode. Requres custom processing."));this.blendMode=n.style.blendMode||i,n.target=Ir.Target.GL,this.transform&&!this.transform.isIdentity&&(r=n.path.clone(),n.path.transform(this.transform));var o=this.layer.draw(n);r&&(n.path=r),this.strokeBounds=o,this.updatedArea=o,this.restart=!0}else{if(this.validate(e)){e.color&&this.color&&!e.color.equals(this.color)&&(e.color=this.color),this.transform&&!this.transform.isIdentity&&e.transform(this.transform);var a=this.brush instanceof dr?this.strokeLastRendererdDrawContext:this.color,s=this.layer.drawStroke(this.brush,e,a);s&&(this.incompleteStrokeBounds=s.union(this.incompleteStrokeBounds),this.strokeBounds=s.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,t&&(this.restart=!0)}}},{key:"drawPreliminary",value:function(e){if(this.validate(e)){var t=null,r=null;this.brush instanceof dr?(this.strokeLastRendererdDrawContext.copyTo(this.strokePrelimLastRenderedDrawContext),t=this.strokePrelimLastRenderedDrawContext):t=this.color,this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(this.layerOptions),this.preliminaryLayer.setTransform(this.transform)),r=this.preliminaryLayer):r=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&this.preliminaryLayer.blend(this.layer,{mode:sr.COPY,rect:this.updatedArea}),e.color&&this.color&&!e.color.equals(this.color)&&(e.color=this.color),this.transform&&!this.transform.isIdentity&&e.transform(this.transform),this.preliminaryDirtyArea=r.drawStroke(this.brush,e,t),this.updatedArea=ne.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}}},{key:"abort",value:function(){this.restart=!0}},{key:"reset",value:function(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.brush instanceof dr?(this.strokeLastRendererdDrawContext=new zr(this.initialRandomSeed),this.strokePrelimLastRenderedDrawContext||(this.strokePrelimLastRenderedDrawContext=new zr),delete this.initialRandomSeed,this.randomSeed=this.strokeLastRendererdDrawContext.randomSeed):delete this.randomSeed,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.restart=!1}},{key:"validate",value:function(e){if(!this.brush)throw new Error("StrokeRenderer requires 'brush' to be configured");return e&&e.length>0}},{key:"blendUpdatedArea",value:function(e){if(this.updatedArea){var t=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,r=e||this.canvas,n=r.bounds.intersect(this.updatedArea);n&&("function"==typeof this.streamUpdatedArea?this.streamUpdatedArea(t.getImageData(n,!0),n,!1):r.blend(t,{mode:this.blendMode,rect:n})),this.incompleteStrokeBounds=null,this.updatedArea=null}}},{key:"blendStroke",value:function(e,t,r){if(this.strokeBounds){r||(r=this.blendMode);var n=this.layer,i=e||this.canvas;(t=i.bounds.intersect(t||this.strokeBounds))&&("function"==typeof this.streamUpdatedArea?this.streamUpdatedArea(n.getImageData(t,!0),t,!0):i.blend(n,{mode:r,rect:t}))}}},{key:"toStroke",value:function(e){var t=e.getSensorData(),r=e.getSpline(),n=e.getInkPath();r.randomSeed=this.randomSeed;var i=new Ir(this.brush,r,n,t);return t&&(i.sensorDataMapping=t.inkStream.getPipelineMapping()),this.blendMode!=sr.SOURCE_OVER&&(i.renderMode=Ir.RenderMode.get(this.blendMode)),i}},{key:"delete",value:function(){this.ownLayer&&(this.layer.delete(),this.preliminaryLayer&&this.preliminaryLayer.delete())}}]),e}(),un=function e(t,r,n){h(this,e),this.subject=t,this.predicate=r,this.object=n},ln=function(){function e(){var t=this;h(this,e),this.statements=[],Object.defineProperty(this,"length",{get:function(){return t.statements.length},enumerable:!0})}return d(e,[{key:"add",value:function(){for(var e=this,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];r.forEach((function(t){return e.statements.push(t)}))}},{key:"remove",value:function(){for(var e=this,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];r.forEach((function(t){return e.statements.remove(t)}))}},{key:"addTriple",value:function(e,t,r){this.statements.push(new un(e,t,r))}},{key:"search",value:function(e){return this.statements.filter((function(t){var r=!0;return Object.keys(e).forEach((function(n){r=r&&t[n]==e[n]})),r}))}}]),e}(),cn=I.commonJS?require("protobufjs"):globalThis.protobuf,hn={nested:{WacomInkFormat3:{options:{optimize_for:"SPEED",java_multiple_files:!1,java_package:"com.wacom.ink.protobuf",java_outer_classname:"Will3_0_0",csharp_namespace:"Protobuf.WILL_3_0_0"},nested:{Rectangle:{fields:{x:{type:"float",id:1},y:{type:"float",id:2},width:{type:"float",id:3},height:{type:"float",id:4}}},Matrix4:{fields:{m00:{type:"float",id:1},m01:{type:"float",id:2},m02:{type:"float",id:3},m03:{type:"float",id:4},m10:{type:"float",id:5},m11:{type:"float",id:6},m12:{type:"float",id:7},m13:{type:"float",id:8},m20:{type:"float",id:9},m21:{type:"float",id:10},m22:{type:"float",id:11},m23:{type:"float",id:12},m30:{type:"float",id:13},m31:{type:"float",id:14},m32:{type:"float",id:15},m33:{type:"float",id:16}}},Range:{fields:{min:{type:"float",id:1},max:{type:"float",id:2},remapURI:{type:"string",id:3}}},Float32:{fields:{value:{type:"float",id:1}}},Uint32:{fields:{value:{type:"uint32",id:1}}},Property:{fields:{name:{type:"string",id:1},value:{type:"string",id:2}}},SemanticTriple:{fields:{subject:{type:"string",id:1},predicate:{type:"string",id:2},object:{type:"string",id:3}}},InkState:{values:{PLANE:0,HOVERING:1,IN_VOLUME:2,VOLUME_HOVERING:3}},InkSensorMetricType:{values:{LENGTH:0,TIME:1,FORCE:2,ANGLE:3,NORMALIZED:4,LOGICAL:5,DIMENSIONLESS:6}},InkInputProviderType:{values:{PEN:0,TOUCH:1,MOUSE:2,CONTROLLER:3}},InputContext:{fields:{id:{type:"string",id:1},environmentID:{type:"string",id:2},sensorContextID:{type:"string",id:3}}},Environment:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},InkInputProvider:{fields:{id:{type:"string",id:1},type:{type:"InkInputProviderType",id:2},properties:{rule:"repeated",type:"Property",id:3}}},InputDevice:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},SensorContext:{fields:{id:{type:"string",id:1},sensorChannelsContext:{rule:"repeated",type:"SensorChannelsContext",id:2}}},SensorChannelsContext:{fields:{id:{type:"string",id:1},channels:{rule:"repeated",type:"SensorChannel",id:2},samplingRateHint:{type:"Uint32",id:3},latency:{type:"Uint32",id:4},inkInputProviderID:{type:"string",id:5},inputDeviceID:{type:"string",id:6}}},SensorChannel:{fields:{id:{type:"string",id:1},type:{type:"string",id:2},metric:{type:"InkSensorMetricType",id:3},resolution:{type:"double",id:4},min:{type:"float",id:5},max:{type:"float",id:6},precision:{type:"uint32",id:7}}},InputContextData:{fields:{inputContexts:{rule:"repeated",type:"InputContext",id:1},inkInputProviders:{rule:"repeated",type:"InkInputProvider",id:2},inputDevices:{rule:"repeated",type:"InputDevice",id:3},environments:{rule:"repeated",type:"Environment",id:4},sensorContexts:{rule:"repeated",type:"SensorContext",id:5}}},ChannelData:{fields:{sensorChannelID:{type:"string",id:1},values:{rule:"repeated",type:"sint32",id:2}}},SensorData:{fields:{id:{type:"string",id:1},inputContextID:{type:"string",id:2},state:{type:"InkState",id:3},timestamp:{type:"uint64",id:4},dataChannels:{rule:"repeated",type:"ChannelData",id:5}}},Stroke:{fields:{id:{type:"string",id:1},startParameter:{type:"float",id:2},endParameter:{type:"float",id:3},splineX:{rule:"repeated",type:"float",id:4},splineY:{rule:"repeated",type:"float",id:5},splineZ:{rule:"repeated",type:"float",id:6},red:{rule:"repeated",type:"float",id:7},green:{rule:"repeated",type:"float",id:8},blue:{rule:"repeated",type:"float",id:9},alpha:{rule:"repeated",type:"float",id:10},size:{rule:"repeated",type:"float",id:11},rotation:{rule:"repeated",type:"float",id:12},scaleX:{rule:"repeated",type:"float",id:13},scaleY:{rule:"repeated",type:"float",id:14},scaleZ:{rule:"repeated",type:"float",id:15},offsetX:{rule:"repeated",type:"float",id:16},offsetY:{rule:"repeated",type:"float",id:17},offsetZ:{rule:"repeated",type:"float",id:18},sensorDataOffset:{type:"uint32",id:19},sensorDataID:{type:"string",id:20},sensorDataMapping:{rule:"repeated",type:"uint32",id:21},style:{type:"Style",id:22}}},RotationMode:{values:{NONE:0,RANDOM:1,TRAJECTORY:2}},BlendMode:{values:{SOURCE_OVER:0,DESTINATION_OVER:1,DESTINATION_OUT:2,LIGHTER:3,COPY:4,MIN:5,MAX:6}},BrushPrototype:{fields:{coordX:{rule:"repeated",type:"float",id:1},coordY:{rule:"repeated",type:"float",id:2},coordZ:{rule:"repeated",type:"float",id:3},indices:{rule:"repeated",type:"uint32",id:4},shapeURI:{type:"string",id:5},size:{type:"float",id:6}}},VectorBrush:{fields:{name:{type:"string",id:1},prototype:{rule:"repeated",type:"BrushPrototype",id:2},spacing:{type:"float",id:3}}},RasterBrush:{fields:{name:{type:"string",id:1},spacing:{type:"float",id:2},scattering:{type:"float",id:3},rotationMode:{type:"RotationMode",id:4},shapeTexture:{rule:"repeated",type:"bytes",id:5},shapeTextureURI:{rule:"repeated",type:"string",id:6},fillTexture:{type:"bytes",id:7},fillTextureURI:{type:"string",id:8},fillWidth:{type:"float",id:9},fillHeight:{type:"float",id:10},randomizeFill:{type:"bool",id:11},blendMode:{type:"BlendMode",id:12}}},NodeType:{values:{STROKE_GROUP:0,SENSOR_DATA_GROUP:1,STROKE:2,SENSOR_DATA:3}},Node:{fields:{id:{type:"string",id:1},depth:{type:"uint32",id:2},index:{type:"uint32",id:3},type:{type:"NodeType",id:4},groupBoundingBox:{type:"Rectangle",id:5},chunkFromIndex:{type:"uint32",id:6},chunkToIndex:{type:"uint32",id:7}}},View:{fields:{name:{type:"string",id:1},tree:{rule:"repeated",type:"Node",id:2}}},PathPointProperties:{fields:{size:{type:"Float32",id:1},red:{type:"Float32",id:2},green:{type:"Float32",id:3},blue:{type:"Float32",id:4},alpha:{type:"Float32",id:5},rotation:{type:"Float32",id:6},scaleX:{type:"Float32",id:7},scaleY:{type:"Float32",id:8},scaleZ:{type:"Float32",id:9},offsetX:{type:"Float32",id:11},offsetY:{type:"Float32",id:12},offsetZ:{type:"Float32",id:13}}},Style:{fields:{properties:{type:"PathPointProperties",id:1},brushURI:{type:"string",id:2},particlesRandomSeed:{type:"uint32",id:3},renderModeURI:{type:"string",id:4}}},InputData:{fields:{inputContextData:{type:"InputContextData",id:1},sensorData:{rule:"repeated",type:"SensorData",id:2}}},InkData:{fields:{strokes:{rule:"repeated",type:"Stroke",id:1}}},Brushes:{fields:{vectorBrushes:{rule:"repeated",type:"VectorBrush",id:1},rasterBrushes:{rule:"repeated",type:"RasterBrush",id:2}}},TripleStore:{fields:{statements:{rule:"repeated",type:"SemanticTriple",id:1}}},Tool:{oneofs:{brush:{oneof:["vectorBrush","rasterBrush"]}},fields:{vectorBrush:{type:"VectorBrush",id:1},rasterBrush:{type:"RasterBrush",id:2},blendMode:{type:"BlendMode",id:3},context:{type:"PathPointContext",id:4}}},PathPointContext:{fields:{statics:{type:"PathPointProperties",id:1},dynamics:{type:"PathPointSettings",id:2}}},PathPointSettings:{fields:{size:{type:"PropertySettings",id:1},red:{type:"PropertySettings",id:2},green:{type:"PropertySettings",id:3},blue:{type:"PropertySettings",id:4},alpha:{type:"PropertySettings",id:5},rotation:{type:"PropertySettings",id:6},scaleX:{type:"PropertySettings",id:7},scaleY:{type:"PropertySettings",id:8},scaleZ:{type:"PropertySettings",id:9},offsetX:{type:"PropertySettings",id:11},offsetY:{type:"PropertySettings",id:12},offsetZ:{type:"PropertySettings",id:13}}},PropertySettings:{fields:{value:{type:"Range",id:1},velocity:{type:"Range",id:2},pressure:{type:"Range",id:3},altitude:{type:"Range",id:4},radiusX:{type:"Range",id:5},radiusY:{type:"Range",id:6},resolveURI:{type:"string",id:7},dependencies:{rule:"repeated",type:"InputPropertyType",id:8}}},InputPropertyType:{values:{PRESSURE:0,RADIUS_X:1,RADIUS_Y:2,AZIMUTH:3,ALTITUDE:4,ROTATION:5}},InkObject:{fields:{inputData:{type:"InputData",id:1},inkData:{type:"InkData",id:2},brushes:{type:"Brushes",id:3},inkTree:{rule:"repeated",type:"Node",id:4},views:{rule:"repeated",type:"View",id:5},knowledgeGraph:{type:"TripleStore",id:6},transform:{type:"Matrix4",id:7},properties:{rule:"repeated",type:"Property",id:8}}}}}}};function fn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var dn=function(e){g(r,e);var t=fn(r);function r(e){return h(this,r),t.call(this,e)}return r}(D);function pn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var yn=function(e){g(r,e);var t=pn(r);function r(e){var n,i;return h(this,r),n=t.call(this,e),Object.defineProperty(m(n),"bounds",{get:function(){return i||(i=this.getBounds()),i},set:function(e){i=e},enumerable:!0}),Object.defineProperty(m(n),"root",{get:function(){for(var e=this.parent,t=this;e;)t=e,e=e.parent;return t},enumerable:!0}),n}return d(r,[{key:"updateID",value:function(e,t){var r=this.root.model;r&&r.updateRegistry(e,t)}},{key:"getBounds",value:function(){return this.content.bounds}},{key:"invalidateBounds",value:function(){this.bounds=void 0}},{key:"remove",value:function(){this.parent.removeChild(this)}}]),r}(dn);function vn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var gn=function(e){g(r,e);var t=vn(r);function r(e){var n;return h(this,r),(n=t.call(this,e)).children=[],Object.defineProperty(m(n),"type",{value:"GROUP",enumerable:!0}),Object.defineProperty(m(n),"content",{value:n.children,enumerable:!0}),n}return d(r,[{key:"getBounds",value:function(){var e;return this.children.forEach((function(t){e=e?e.union(t.bounds):t.bounds})),e}},{key:"contains",value:function(e){if(!(e instanceof yn))throw new Error("Incompatible node found - ".concat(e.constructor.name,". It should be ink model Element."));for(var t=!1,r=e.parent;r;){if(r==this){t=!0;break}r=r.parent}return t}},{key:"indexOf",value:function(e){if(!(e instanceof yn))throw new Error("Incompatible node found - ".concat(e.constructor.name,". It should be ink model Element."));return this.children.indexOf(e)}},{key:"appendChild",value:function(e,t){if(!(e instanceof yn))throw new Error("Incompatible node found - ".concat(e.constructor.name,". It should be ink model Element."));if(t<0)throw new Error("Index should be a positive number");var r=e.parent;if(r){if(this.root.id!=e.root.id)throw new Error("Moving nodes from one hierarchy to another is not allowed. Make sure root is common for this operation.");e.parent.children.remove(e),e.parent.invalidateBounds()}if(e.parent=this,isFinite(t)&&t<this.children.length?this.children.insert(e,t):this.children.push(e),!r){var n=this.root.model;n&&n.register(e,t)}return this.invalidateBounds(),e}},{key:"removeChild",value:function(e){if(!this.children.includes(e))throw new Error("Node was not found");var t=this.root.model;t&&t.unregister(e),this.invalidateBounds(),this.children.remove(e)}},{key:"remove",value:function(){this.parent?this.parent.removeChild(this):(this.model&&this.model.unregister(this),this.invalidateBounds())}}]),r}(yn);function mn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var bn=function(e){g(r,e);var t=mn(r);function r(e,n){var i;return h(this,r),i=t.call(this),n&&(n=Object.assign({id:void 0},n)),Object.defineProperty(m(i),"type",{value:"PATH",enumerable:!0}),Object.defineProperty(m(i),"index",{get:function(){return i.parent?i.parent.indexOf(m(i)):0},enumerable:!0}),Object.defineProperty(m(i),"content",{value:e,enumerable:!0}),Object.defineProperty(m(i),"interval",{value:Object.seal(n),enumerable:!0}),i}return d(r,[{key:"split",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(this.content instanceof Oe)throw new Error("SensorData is immutable. Split is not applicable.");if(!this.parent)throw new Error("Dettached Path node split is not allowed. Attach to hierarchy first.");if(e<0||e>this.content.length-1)throw new Error("Index out of range {0, ".concat(this.content.length-1,"}"));var n=this.interval?this.interval.fromIndex:0,i=this.interval?this.interval.toIndex:this.content.length-1,o=this.interval?this.interval.fromTValue:this.content.ts,a=this.interval?this.interval.toTValue:this.content.tf,s={fromIndex:n,toIndex:e+1,fromTValue:o,toTValue:t-.05},u={fromIndex:e-1,toIndex:i,fromTValue:1==t?.05:t,toTValue:a};if(s.toIndex+1-s.fromIndex<4)throw new Error("Invalid split index ".concat(e," found - range {").concat(s.fromIndex,", ").concat(s.toIndex,"} is invalid. At least 4 points are needed to define interval."));if(u.toIndex+1-u.fromIndex<4)throw new Error("Invalid split index ".concat(e," found - range {").concat(u.fromIndex,", ").concat(u.toIndex,"} is invalid. At least 4 points are needed to define interval."));var l=new r(this.content,s),c=new r(this.content,u),h=this.index;return this.remove(),this.parent.appendChild(l,h),this.parent.appendChild(c,h+1),[l,c]}}]),r}(yn),En=function(){function e(t,r,n){h(this,e),this.model=t,this.type=r||t.type,this.tree=this.createGroup(n),this.tree.model=this,this.register(this.tree)}return d(e,[{key:"addPath",value:function(e,t){return t||(t=this.tree),t.appendChild(this.createElement(e))}},{key:"createElement",value:function(e,t){return this.model.createElement(e,this,t)}},{key:"createGroup",value:function(e){return this.model.createGroup(e,this)}},{key:"register",value:function(t){var r=this;if(t instanceof gn)t.children.forEach((function(e){return r.register(e)}));else if(t instanceof bn){if(t.content instanceof Ir){if(this.type!=e.Type.STROKE)throw new Error("Incompatible element content found - ".concat(t.content.constructor.name,". Content should be instance of Stroke."))}else{if(!(t.content instanceof Oe))throw new Error("Incompatible element content found - ".concat(t.content.constructor.name,". Content should be ").concat(this.type.name,"."));if(this.type!=e.Type.SENSOR_DATA)throw new Error("Incompatible element content found - ".concat(t.content.constructor.name,". Content should be instance of SensorData."))}if(!this.model.content.includes(t.content))throw new Error("Node content not found in underling ink model - ".concat(t.content.id))}this.model.index(t),this.updateKnowledgeGraph(t.id)}},{key:"unregister",value:function(e){var t=this;e instanceof gn&&e.children.forEach((function(e){return t.unregister(e)})),delete this.model.registry[e.id],this.updateKnowledgeGraph(e.id)}},{key:"updateKnowledgeGraph",value:function(e){if(e){var t=this.model.uriBuilder.buildNodeURI(e);if(this.model.registry[e]){var r,n;if(!this.knowledgeGraph)return;(r=this.model.knowledgeGraph).add.apply(r,j(this.knowledgeGraph.search({subject:t}))),(n=this.model.knowledgeGraph).add.apply(n,j(this.knowledgeGraph.search({object:t})))}else{var i,o;(i=this.model.knowledgeGraph).remove.apply(i,j(this.model.knowledgeGraph.search({subject:t}))),(o=this.model.knowledgeGraph).remove.apply(o,j(this.model.knowledgeGraph.search({object:t})))}}}}]),e}(),xn=function(){function e(){h(this,e)}return d(e,[{key:"setInkModelURI",value:function(e){return this.inkModelURI=e,this}},{key:"setNodeID",value:function(e){return this.inkNodeID=e,this}},{key:"buildNodeURI",value:function(e,t){return this.reset().setInkModelURI(t).setNodeID(e).build()}},{key:"build",value:function(){var e="",t="";return this.inkModelURI&&(e=this.fixedEncodeURIComponent(this.inkModelURI),t="/"),t+="node/"+this.inkNodeID,"".concat("uim:").concat(e).concat(t)}},{key:"fixedEncodeURIComponent",value:function(e){return encodeURIComponent(e).replace(/[!'()*]/g,(function(e){return"%"+e.charCodeAt(0).toString(16)}))}},{key:"reset",value:function(){return this.inkModelURI=void 0,this.inkNodeID=void 0,this}}]),e}(),Pn=function(){function e(){var t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.Type.STROKE,n=arguments.length>1?arguments[1]:void 0;h(this,e),this.type=r,this.tree=this.createGroup(n),this.tree.model=this,this.props={},this.views={},this.knowledgeGraph=new ln,this.uriBuilder=new xn,this.registry={},this.register(this.tree),Object.defineProperty(this,"content",{value:[],enumerable:!0}),Object.defineProperty(this,"strokes",{get:function(){return t.type==e.Type.STROKE?t.content.slice():[]},enumerable:!0}),Object.defineProperty(this,"sensorData",{get:function(){return t.type==e.Type.STROKE?t.content.map((function(e){return e.sensorData})).filter((function(e){return!!e})):t.content},enumerable:!0}),Object.defineProperty(this,"brushes",{get:function(){var e={};return t.strokes.forEach((function(r){return e[r.brush.name]=t.registry[r.brush.name]||r.brush})),Object.values(e)},set:function(e){e.forEach((function(e){return t.registry[e.name]=e}))},enumerable:!0})}return d(e,[{key:"addPath",value:function(e,t){t||(t=this.tree);var r=this.createElement(e);return e.nodeID&&(r.id=e.nodeID),t.appendChild(r)}},{key:"removePath",value:function(e){e.nodeID&&this.registry[e.nodeID].remove()}},{key:"replacePath",value:function(e,t,r){var n=this;if(e.nodeID){var i=this.getItem(e.nodeID),o=i.parent||this.tree,a=t.map((function(e){return n.createElement(e)})),s=o.children.indexOf(i);if(r){var u=o.appendChild(this.createGroup(),s);a.forEach((function(e){return u.appendChild(e)}))}else a.forEach((function(e,t){return o.appendChild(e,s+t)}));this.removePath(e)}}},{key:"createElement",value:function(t,r,n){if(!t)throw new Error("Element content not found");var i=r?r.type:this.type;switch(i){case e.Type.STROKE:if(!(t instanceof Ir))throw new Error("Incompatible element content found - ".concat(t.constructor.name,". Content should be instance of Stroke."));break;case e.Type.SENSOR_DATA:if(!(t instanceof Oe))throw new Error("Incompatible element content found - ".concat(t.constructor.name,". Content should be instance of SensorData."));break;default:throw console.warn(i),new Error("Invalid ink model type found")}return new bn(t,n)}},{key:"createGroup",value:function(e,t){return new gn(e)}},{key:"getItem",value:function(e){return this.registry[e]}},{key:"register",value:function(t,r){var n=this;if(t instanceof gn)t.children.forEach((function(e){return n.register(e)}));else if(t instanceof bn){if(t.content instanceof Ir){if(this.type!=e.Type.STROKE)throw new Error("Incompatible element content found - ".concat(t.content.constructor.name,". Content should be instance of Stroke."))}else{if(!(t.content instanceof Oe))throw new Error("Incompatible element content found - ".concat(t.content.constructor.name,". Content should be ").concat(this.type.name,"."));if(this.type!=e.Type.SENSOR_DATA)throw new Error("Incompatible element content found - ".concat(t.content.constructor.name,". Content should be instance of SensorData."))}Object.defineProperty(t.content,"nodeID",{value:t.id,enumerable:!0,configurable:!0}),isFinite(r)&&r<this.content.length?this.content.insert(t.content,r):this.content.push(t.content),this.index(t.content)}this.index(t),t instanceof dn&&!this.keepViews&&this.resetViews()}},{key:"updateRegistry",value:function(e,t){var r=this.registry[e];delete this.registry[e],this.registry[r.id]=r,this.updateKnowledgeGraph(e,t)}},{key:"unregister",value:function(e){var t=this;e instanceof dn&&this.resetViews(),e instanceof gn?e.children.forEach((function(e){return t.unregister(e)})):e instanceof bn&&(delete e.content.nodeID,delete this.registry[e.content.id],this.content.remove(e.content)),e==this.tree?e.children.clear():delete this.registry[e.id],this.updateKnowledgeGraph(e.id)}},{key:"updateKnowledgeGraph",value:function(e,t){var r,n,i=this.uriBuilder.buildNodeURI(e),o=this.uriBuilder.buildNodeURI(t);o?(this.knowledgeGraph.search({subject:i}).forEach((function(e){return e.subject=o})),this.knowledgeGraph.search({object:i}).forEach((function(e){return e.object=o}))):((r=this.knowledgeGraph).remove.apply(r,j(this.knowledgeGraph.search({subject:i}))),(n=this.knowledgeGraph).remove.apply(n,j(this.knowledgeGraph.search({object:i}))))}},{key:"index",value:function(e){if(this.registry[e.id])throw new Error("Cannot register item with id ".concat(e.id,". Already is available item with such identifier."));if(e instanceof dn){var t=this.type.name;e instanceof gn&&(t="ol<".concat(t,">")),Object.defineProperty(e,"dataType",{value:t,enumerable:!0})}this.registry[e.id]=e}},{key:"createView",value:function(e,t,r,n){var i=new En(this,t,r);return i.name=e,this.views[e]=i,n&&(i.knowledgeGraph=n,i.updateKnowledgeGraph(r)),i}},{key:"resetViews",value:function(){for(var e in this.views)this.views[e].tree.remove(),delete this.views[e]}}]),e}();Object.defineEnum(Pn,"Type",["STROKE","SENSOR_DATA"]),En.Type=Pn.Type;var kn={extension:"uim",contentType:"application/vnd.wacom-ink.model",version:new Uint8Array([3,0,0]),fourCCLength:4,headers:{riffFourCC:"RIFF".toCharArray(!0),formatFourCC:"UINK".toCharArray(!0),headChunkFourCC:"HEAD".toCharArray(!0),inkChunkFourCC:"DATA".toCharArray(!0)}},wn=function(){function e(){h(this,e),this.reset(),Object.defineProperty(this,"data",{get:function(){return this.fileBytes||this.build(),this.fileBytes}})}return d(e,[{key:"encodeInk",value:function(e){e&&this.encode(kn.headers.inkChunkFourCC,e)}},{key:"encode",value:function(e,t){var r=e instanceof Uint8Array?e:e.toCharArray().toUint8Array();if(r.length!=kn.fourCCLength)throw new Error('Invalid fourCC: "'.concat(e,'"'));if(this.fileBytes)throw new Error("File content building completed. Cannot add more chunks.");this.chunks.push(this.createChunk(r,t))}},{key:"build",value:function(){var e=this,t=kn.headers,r=0;this.chunks.unshift(this.createChunk(kn.headers.headChunkFourCC,kn.version)),this.chunks.forEach((function(e){r+=e.length}));var n=t.formatFourCC.length+r,i=t.riffFourCC.length+Uint32Array.BYTES_PER_ELEMENT+n,o=new ArrayBuffer(i);this.fileBytes=new Uint8Array(o),this.dataView=new DataView(o),this.byteOffset=0,this.fileBytes.set(t.riffFourCC,this.byteOffset),this.byteOffset+=t.riffFourCC.length,this.dataView.setUint32(this.byteOffset,n,!0),this.byteOffset+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(t.formatFourCC,this.byteOffset),this.byteOffset+=t.formatFourCC.length,this.chunks.forEach((function(t){e.appendChunk(t),e.byteOffset+=t.length}))}},{key:"createChunk",value:function(e,t){var r=t.length,n=r%2;return{fourCC:e,bytes:t,size:r,length:e.length+Uint32Array.BYTES_PER_ELEMENT+r+n}}},{key:"appendChunk",value:function(e){this.fileBytes.set(e.fourCC,this.byteOffset);var t=this.byteOffset+e.fourCC.length;this.dataView.setUint32(t,e.size,!0),t+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(e.bytes,t)}},{key:"reset",value:function(){this.chunks=[],this.fileBytes=null}}]),e}(),Rn=function(){function e(){h(this,e)}return d(e,[{key:"decode",value:function(e){var t=kn.headers;this.reset(e);var r=this.byteOffset+t.riffFourCC.length;if(!Object.equals(this.fileBytes.subarray(this.byteOffset,r),t.riffFourCC))throw new Error("Invalid RIFF fourCC");this.byteOffset=r,r=this.byteOffset+Uint32Array.BYTES_PER_ELEMENT;var n=this.dataView.getUint32(this.byteOffset,!0)+r;if(n%2!=0)throw new Error("Invalid RIFF file size");if(n!=this.fileBytes.length)throw new Error("Incomplete RIFF file");if(this.byteOffset=r,r=this.byteOffset+t.formatFourCC.length,!Object.equals(this.fileBytes.subarray(this.byteOffset,r),t.formatFourCC))throw new Error("Invalid WILL fourCC");for(this.byteOffset=r;this.byteOffset<n;){var i=this.extractChunk();this.byteOffset+=i.length,Object.equals(i.fourCC,t.headChunkFourCC)?this.version=[i.bytes[0],i.bytes[1],i.bytes[2]]:Object.equals(i.fourCC,t.inkChunkFourCC)?this.ink=i.bytes:this.chunks.push({fourCC:String.fromCharArray(i.fourCC),bytes:i.bytes})}}},{key:"extractChunk",value:function(){var e,t,r=this.fileBytes.subarray(this.byteOffset,this.byteOffset+kn.fourCCLength),n=null,i=this.byteOffset+r.length,o=i;return i=o+Uint32Array.BYTES_PER_ELEMENT,e=this.dataView.getUint32(o,!0),i=(o=i)+e,e>0?(n=this.fileBytes.subarray(o,i),n=new Uint8Array(n,n.byteOffset,n.length)):n=new Uint8Array(0),{fourCC:r,bytes:n,size:e,length:(t=r.length+Uint32Array.BYTES_PER_ELEMENT+e)+t%2}}},{key:"reset",value:function(e){this.fileBytes=e,this.dataView=new DataView(e.buffer),this.byteOffset=0,this.chunks=[]}}]),e}();function In(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Sn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Sn(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Sn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Tn=function(){function e(){h(this,e),e.format||(e.format=cn.Root.fromJSON(hn).WacomInkFormat3),this.riffEncoder=new wn,this.riffDecoder=new Rn}var t,r,n,i;return d(e,[{key:"encodeInkModel",value:(i=de(he.mark((function t(r){var n,i,o=this;return he.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.structure=!0,t.t0=e.format.InkObject,t.t1=this.encodeInkInput(r.sensorData),t.t2=this.encodeInkData(r.strokes),t.next=6,this.encodeBrushes(r.brushes);case 6:return t.t3=t.sent,t.t4=this.encodeNodeTree(r),t.t5=Object.values(r.views).map((function(e){return o.encodeView(e)})),t.t6=this.encodeKnowledgeGraph(r.knowledgeGraph),t.t7=this.encodeMat4(r.transform),t.t8=this.encodeProperties(r.props),t.t9={inputData:t.t1,inkData:t.t2,brushes:t.t3,inkTree:t.t4,views:t.t5,knowledgeGraph:t.t6,transform:t.t7,properties:t.t8},n=t.t0.create.call(t.t0,t.t9),this.structure=!1,i=e.encode(n),this.riffEncoder.reset(),this.riffEncoder.encodeInk(i),t.abrupt("return",this.riffEncoder.data);case 19:case"end":return t.stop()}}),t,this)}))),function(e){return i.apply(this,arguments)})},{key:"decodeInkModel",value:function(t,r){var n=this;t instanceof ArrayBuffer&&(t=new Uint8Array(t)),this.riffDecoder.decode(t);var i=e.format.InkObject.decode(this.riffDecoder.ink);if(this.structure=i,r){var o=this.decodeKnowledgeGraph(i.knowledgeGraph);i.views.forEach((function(e){return n.decodeView(e,r,o)}))}else{var a=this.decodeInkInput(i.inputData),s=this.decodeBrushes(i.brushes),u=this.decodeInkData(i.inkData,s,a),l=i.inkTree.first,c=l.type==e.format.NodeType.STROKE_GROUP?Pn.Type.STROKE:Pn.Type.SENSOR_DATA,h=l.type==e.format.NodeType.STROKE_GROUP?u:a;r=new Pn(c,l.id),this.decodeNodeTree(r,i.inkTree.slice(1),h),i.views.forEach((function(e){return n.decodeView(e,r)})),r.knowledgeGraph=this.decodeKnowledgeGraph(i.knowledgeGraph),r.props=this.decodeProperties(i.properties),r.transform=this.decodeMat4(i.transform),r.brushes=Object.values(s)}return delete this.structure,r}},{key:"encodeInkInput",value:function(t){var r=this,n={},i={},o={},a={},s={};t.forEach((function(e){var t=e.context;n[t.id]||(n[t.id]=t,s[t.environment.id]||(s[t.environment.id]=t.environment),i[t.sensorContext.id]||(i[t.sensorContext.id]=t.sensorContext,t.sensorContext.channelsContexts.forEach((function(e){o[e.device.id]||(o[e.device.id]=e.device),e.inkProvider&&(a[e.inkProvider.id]||(a[e.inkProvider.id]=e.inkProvider))}))))}));var u=e.format.InputData.create({sensorData:t.map((function(e){return r.encodeSensorData(e)})),inputContextData:e.format.InputContextData.create({inputContexts:Object.values(n).map((function(t){return e.format.InputContext.create({id:t.id,environmentID:t.environment.id,sensorContextID:t.sensorContext.id})})),sensorContexts:Object.values(i).map((function(t){return e.format.SensorContext.create({id:t.id,sensorChannelsContext:t.channelsContexts.map((function(t){return e.format.SensorChannelsContext.create({id:t.id,channels:t.channels.map((function(t){return e.format.SensorChannel.create({id:t.id,type:t.type,metric:e.format.InkSensorMetricType[t.metric.name],resolution:t.resolution,min:t.min,max:t.max,precision:t.precision})})),samplingRateHint:isFinite(t.samplingRate)?e.format.Uint32.create({value:t.samplingRate}):void 0,latency:isFinite(t.latency)?e.format.Uint32.create({value:t.latency}):void 0,inkInputProviderID:t.inkProvider?t.inkProvider.id:null,inputDeviceID:t.device.id})}))})})),inkInputProviders:Object.values(a).map((function(t){return e.format.InkInputProvider.create({id:t.id,type:e.format.InkInputProviderType[t.type.name],properties:r.encodeProperties(t.props)})})),inputDevices:Object.values(o).map((function(t){return e.format.InputDevice.create({id:t.id,properties:r.encodeProperties(t.props)})})),environments:Object.values(s).map((function(t){return e.format.Environment.create({id:t.id,properties:r.encodeProperties(t.props)})}))})});return this.structure?u:e.encode(u)}},{key:"decodeInkInput",value:function(t){var r=this;if(t){var n=this.structure?t:e.format.InputData.decode(t),i={},o={},a={},s={},u={};return n.inputContextData.environments.forEach((function(e){var t=new ge;r.decodeProperties(e.properties,t.props),Object.freeze(t),t.id!=e.id&&console.warn("Environment decode id missmatch - found ".concat(e.id,", expected ").concat(t.id)),u[t.id]=t})),n.inputContextData.inkInputProviders.forEach((function(t){var n=r.decodeProperties(t.properties),i=new M(M.Type[e.format.InkInputProviderType[t.type]],n);Object.freeze(i),i.id!=t.id&&console.warn("InkInputProvider decode id missmatch - found ".concat(t.id,", expected ").concat(i.id)),s[i.id]=i})),n.inputContextData.inputDevices.forEach((function(e){var t=new Me;r.decodeProperties(e.properties,t.props),Object.freeze(t),t.id!=e.id&&console.warn("InputDevice decode id missmatch - found ".concat(e.id,", expected ").concat(t.id)),a[t.id]=t})),n.inputContextData.sensorContexts.forEach((function(t){var r=new Ie;t.sensorChannelsContext.forEach((function(t){var n=new we(a[t.inputDeviceID],s[t.inkInputProviderID]);t.samplingRateHint&&(n.samplingRate=t.samplingRateHint.value),t.latency&&(n.latency=t.latency.value),t.channels.forEach((function(t){var r=Pe.Metric[e.format.InkSensorMetricType[t.metric]],i=new Pe(t.type,r,t.resolution,t.min,t.max);i.precision=t.precision,n.add(i),i.id!=t.id&&console.warn("SensorChannel decode id missmatch - found ".concat(t.id,", expected ").concat(i.id))})),r.addContext(n),n.id!=t.id&&console.warn("SensorChannelsContext decode id missmatch - found ".concat(t.id,", expected ").concat(n.id))})),Object.freeze(r),o[r.id]=r,r.id!=t.id&&console.warn("SensorContext decode id missmatch - found ".concat(t.id,", expected ").concat(r.id))})),n.inputContextData.inputContexts.forEach((function(e){var t=new Te(u[e.environmentID],o[e.sensorContextID]);Object.freeze(t),t.id!=e.id&&console.warn("InputContext decode id missmatch - found ".concat(e.id,", expected ").concat(t.id)),i[t.id]=t})),n.sensorData.map((function(e){return r.decodeSensorData(e,i[e.inputContextID])}))}}},{key:"encodeSensorData",value:function(t){var r=e.format.SensorData.create({id:t.id,inputContextID:t.context.id,state:e.format.InkState[t.inkState.name],timestamp:t.created});return t.streams.forEach((function(t){var n={};t.channels.forEach((function(e){return n[e.id]=[]}));for(var i=function(e){var r=t.get(e);t.channels.forEach((function(e){n[e.id].push(r[ue.getPropName(e.name)])}))},o=0;o<t.length;o++)i(o);t.channels.forEach((function(t){if(!("precision"in t))throw new Error("Precision not found for channel with id: ".concat(t.id));var i=e.format.ChannelData.create({sensorChannelID:t.id}),o=n[t.id],a=Math.pow(10,t.precision),s=Math.round(o[0]*a);i.values.push(s);for(var u=1;u<o.length;u++){var l=Math.round(o[u]*a);i.values.push(l-s),s=l}r.dataChannels.push(i)}))})),r}},{key:"decodeSensorData",value:function(t,r){if(0==t.dataChannels.length)throw new Error("Not found corresponding data channels for sensor data with id ".concat(t.id));var n=new Oe(r);n.id=t.id,n.created=parseInt(T.fromValue(t.timestamp).toString()),n.inkState=Oe.InkState[e.format.InkState[t.state]];var i={};return t.dataChannels.forEach((function(e){var t=r.sensorContext.getContextByChannelID(e.sensorChannelID);if(!t)throw new Error("Not found corresponding channel context for data with channelID ".concat(e.sensorChannelID));var n=t.get(e.sensorChannelID),o=Math.pow(10,n.precision),a=e.values[0],s=[];s.push(a/o);for(var u=1;u<e.values.length;u++){var l=a+e.values[u];s.push(l/o),a=l}i[e.sensorChannelID]=s})),r.sensorContext.channelsContexts.forEach((function(e){for(var t=i[e.channels.first.id].length,r=new Ce(e.channels),o=function(t){e.channels.forEach((function(e){var n=i[e.id];r.data.push(n[t])}))},a=0;a<t;a++)o(a);n.add(r)})),n}},{key:"encodeInkData",value:function(t){var r=this,n=e.format.InkData.create({strokes:t.map((function(e){return r.encodeStroke(e)}))});return this.structure?n:e.encode(n)}},{key:"decodeInkData",value:function(t,r){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(t){var o=this.structure?t:e.format.InkData.decode(t),a={};return i.forEach((function(e){return a[e.id]=e})),o.strokes.map((function(e){return n.decodeStroke(e,r,a)}))}}},{key:"encodeStroke",value:function(t){for(var r=e.format.Stroke.create({id:t.id,startParameter:t.ts,endParameter:t.tf}),n=function(e){var n=t.pointAt(e);t.layout.forEach((function(e){switch(e){case te.Property.X:r.splineX.push(n.x);break;case te.Property.Y:r.splineY.push(n.y);break;case te.Property.Z:r.splineZ.push(n.z);break;case te.Property.RED:r.red.push(n.red/255);break;case te.Property.GREEN:r.green.push(n.green/255);break;case te.Property.BLUE:r.blue.push(n.blue/255);break;case te.Property.ALPHA:r.alpha.push(n.alpha);break;case te.Property.SIZE:r.size.push(n.size);break;case te.Property.ROTATION:r.rotation.push(n.rotation);break;case te.Property.SCALE_X:r.scaleX.push(n.scaleX);break;case te.Property.SCALE_Y:r.scaleY.push(n.scaleY);break;case te.Property.SCALE_Z:r.scaleZ.push(n.scaleZ);break;case te.Property.OFFSET_X:r.offsetX.push(n.offsetX);break;case te.Property.OFFSET_Y:r.offsetY.push(n.offsetY);break;case te.Property.OFFSET_Z:r.offsetZ.push(n.offsetZ);break;default:throw new Error("Invalid layout property provided: ".concat(e))}}))},i=0;i<t.length;i++)n(i);return t.sensorData&&(r.sensorDataID=t.sensorData.id,r.sensorDataOffset=t.sensorDataOffset,r.sensorDataMapping=t.sensorDataMapping),r.style=e.format.Style.create({brushURI:t.brush.name,renderModeURI:t.renderMode,particlesRandomSeed:t.randomSeed,properties:this.encodePathPointProperties(t.pointProps)}),r}},{key:"decodeStroke",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(0==e.splineX.length||0==e.splineY.length)throw new Error("Incomplete path definition");var n=[te.Property.X,te.Property.Y];e.splineZ.length>0&&n.push(te.Property.Z),e.red&&e.red.length>0&&n.push(te.Property.RED),e.green&&e.green.length>0&&n.push(te.Property.GREEN),e.blue&&e.blue.length>0&&n.push(te.Property.BLUE),e.alpha&&e.alpha.length>0&&n.push(te.Property.ALPHA),e.size.length>0&&n.push(te.Property.SIZE),e.rotation.length>0&&n.push(te.Property.ROTATION),e.scaleX.length>0&&n.push(te.Property.SCALE_X),e.scaleY.length>0&&n.push(te.Property.SCALE_Y),e.scaleZ.length>0&&n.push(te.Property.SCALE_Z),e.offsetX.length>0&&n.push(te.Property.OFFSET_X),e.offsetY.length>0&&n.push(te.Property.OFFSET_Y),e.offsetZ.length>0&&n.push(te.Property.OFFSET_Z);for(var i=e.splineX.length,o=n.length,a="undefined"==typeof SharedArrayBuffer?new Float32Array(i*o):new Float32Array(new SharedArrayBuffer(i*o*Float32Array.BYTES_PER_ELEMENT)),s=function(t){n.forEach((function(r,n){var i;switch(r){case te.Property.X:i=e.splineX[t];break;case te.Property.Y:i=e.splineY[t];break;case te.Property.Z:i=e.splineZ[t];break;case te.Property.RED:i=Math.round(255*e.red[t]);break;case te.Property.GREEN:i=Math.round(255*e.green[t]);break;case te.Property.BLUE:i=Math.round(255*e.blue[t]);break;case te.Property.ALPHA:i=e.alpha[t];break;case te.Property.SIZE:i=e.size[t];break;case te.Property.ROTATION:i=e.rotation[t];break;case te.Property.SCALE_X:i=e.scaleX[t];break;case te.Property.SCALE_Y:i=e.scaleY[t];break;case te.Property.SCALE_Z:i=e.scaleZ[t];break;case te.Property.OFFSET_X:i=e.offsetX[t];break;case te.Property.OFFSET_Y:i=e.offsetY[t];break;case te.Property.OFFSET_Z:i=e.offsetZ[t];break;default:throw new Error("Invalid layout property provided: ".concat(r.name))}a[t*o+n]=i}))},u=0;u<i;u++)s(u);var l=t[e.style.brushURI]||e.style.brushURI,c=this.decodePathPointProperties(e.style.properties),h=r[e.sensorDataID],f=new bt(n,a,c,e.startParameter,e.endParameter);f.randomSeed=e.style.particlesRandomSeed;var d=new Ir(l,f,void 0,h);return d.id=e.id,d.renderMode=e.style.renderModeURI,d.sensorDataOffset=e.sensorDataOffset,d.sensorDataMapping=e.sensorDataMapping,d}},{key:"encodeBrushes",value:(n=de(he.mark((function t(r){var n,i,o,a,s,u;return he.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=e.format.Brushes.create(),i=In(r),t.prev=2,i.s();case 4:if((o=i.n()).done){t.next=17;break}if(!((a=o.value)instanceof We)){t.next=11;break}s=this.encodeBrush2D(a),n.vectorBrushes.push(s),t.next=15;break;case 11:return t.next=13,this.encodeBrushGL(a);case 13:u=t.sent,n.rasterBrushes.push(u);case 15:t.next=4;break;case 17:t.next=22;break;case 19:t.prev=19,t.t0=t.catch(2),i.e(t.t0);case 22:return t.prev=22,i.f(),t.finish(22);case 25:return t.abrupt("return",this.structure?n:e.encode(n));case 26:case"end":return t.stop()}}),t,this,[[2,19,22,25]])}))),function(e){return n.apply(this,arguments)})},{key:"decodeBrushes",value:function(t){var r=this;if(t){var n=this.structure?t:e.format.Brushes.decode(t),i={};return n.vectorBrushes.forEach((function(e){return i[e.name]=r.decodeBrush2D(e)})),n.rasterBrushes.forEach((function(e){return i[e.name]=r.decodeBrushGL(e)})),this.structure?i:Object.values(i)}}},{key:"encodeBrush2D",value:function(t){if(!t.name)throw new Error("Encode Brush2D failed. name property is required.");var r=e.format.VectorBrush.create({name:t.name,spacing:t.spacing});return(Array.isArray(t.shape)?t.shape:[t.shape]).forEach((function(t){var n=e.format.BrushPrototype.create({size:t.size});if(t.descriptor.shape.name)n.shapeURI=t.descriptor.shape.name;else for(var i=0;i<t.shape.length;i+=2)n.coordX.push(t.shape[i]),n.coordY.push(t.shape[i+1]);r.prototype.push(n)})),r}},{key:"decodeBrush2D",value:function(e){var t=[];return e.prototype.forEach((function(e){var r;if(e.shapeURI)r=e.shapeURI;else{r=new Float32Array(2*e.coordX.length);for(var n=0;n<r.length/2;n++)r[2*n]=e.coordX[n],r[2*n+1]=e.coordY[n]}t.push(new Ue(r,e.size))})),new We(e.name,t,e.spacing)}},{key:"encodeBrushGL",value:(r=de(he.mark((function t(r){var n,i,o,a;return he.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r.name){t.next=2;break}throw new Error("Encode BrushGL failed. name property is required.");case 2:if(n={shape:[],shapeURI:[],fill:void 0,filleURI:void 0},!Array.isArray(r.shape)){t.next=11;break}if(!((i=r.descriptor.shape.map((function(e){return e.name})).filter((function(e){return e}))).length>0)){t.next=9;break}if(i.length==r.shape.length){t.next=8;break}throw new Error("Brush ".concat(r.name," shape names length do not match with brush mipmap"));case 8:n.shapeURI=i;case 9:t.next=12;break;case 11:r.descriptor.shape.name&&n.shapeURI.push(r.descriptor.shape.name);case 12:if(n.fillURI=r.descriptor.fill.name,0!=n.shapeURI.length&&n.fillURI){t.next=23;break}return t.next=16,r.getShapeBinary();case 16:return t.t0=t.sent,t.next=19,r.getFillBinary();case 19:t.t1=t.sent,o={shape:t.t0,fill:t.t1},0==n.shapeURI.length&&(Array.isArray(r.shape)?n.shape=o.shape:n.shape.push(o.shape)),n.fillURI||(n.fill=o.fill);case 23:return a=r.blendMode.replace(/-/g,"_").toUpperCase(),t.abrupt("return",e.format.RasterBrush.create({name:r.name,spacing:r.spacing,scattering:r.scattering,blendMode:e.format.BlendMode[a],rotationMode:e.format.RotationMode[r.rotationMode.name],shapeTexture:n.shape,shapeTextureURI:n.shapeURI,fillTexture:n.fill,fillTextureURI:n.fillURI,fillWidth:r.fillTextureSize.width,fillHeight:r.fillTextureSize.height,randomizeFill:r.randomizeFill}));case 25:case"end":return t.stop()}}),t)}))),function(e){return r.apply(this,arguments)})},{key:"decodeBrushGL",value:function(t){var r,n;if(t.shapeTextureURI.length>0)r=1==t.shapeTextureURI.length?{name:t.shapeTextureURI.first}:t.shapeTextureURI.map((function(e){return{name:e}}));else{if(!(t.shapeTexture.length>0))throw new Error("Decode BrushGL shape - insufficent data found");r=1==t.shapeTexture.length?{value:t.shapeTexture.first}:t.shapeTexture.map((function(e){return{value:e}}))}if(t.fillTextureURI)n={name:t.fillTextureURI};else{if(!t.fillTexture)throw new Error("Decode BrushGL fill - insufficent data found");n={value:t.fillTexture}}return new dr(t.name,r,n,{spacing:t.spacing,scattering:t.scattering,blendMode:sr[e.format.BlendMode[t.blendMode]],rotationMode:dr.RotationMode[t.rotationMode]},{randomize:t.randomizeFill,size:{width:t.fillWidth,height:t.fillHeight}})}},{key:"encodeView",value:function(t){return e.format.View.create({name:t.name,tree:this.encodeNodeTree(t)})}},{key:"decodeView",value:function(t,r,n){var i=t.tree.first;if(!r.views[t.name]||r.views[t.name].tree.id!=t.tree[0].id){var o=i.type==e.format.NodeType.STROKE_GROUP?Pn.Type.STROKE:Pn.Type.SENSOR_DATA,a=r.createView(t.name,o,i.id,n);this.decodeNodeTree(a,t.tree.slice(1))}}},{key:"encodeNodeTree",value:function(e){var t=[];return t.push(this.encodeNode(e.type,e.tree,0)),this.addChildren(t,e,e.tree.children,1),t}},{key:"addChildren",value:function(e,t,r,n){var i=this;r.forEach((function(r){var o=r instanceof bn?(t.model||t).content.indexOf(r.content):void 0;e.push(i.encodeNode(t.type,r,n,o)),r instanceof gn&&i.addChildren(e,t,r.children,n+1)}))}},{key:"encodeNode",value:function(t,r,n,i){var o=t.name;r instanceof gn&&(o+="_GROUP");var a=r.interval||{};return e.format.Node.create({id:r.id,type:e.format.NodeType[o],depth:n,index:i,groupBoundingBox:r.bounds,chunkFromIndex:a.fromIndex,chunkToIndex:a.toIndex})}},{key:"decodeNodeTree",value:function(t,r,n){var i=t.tree,o=0;n||(n=(t.type==Pn.Type.STROKE?this.structure.inkData.strokes:this.structure.inputData.sensorData).map((function(e){return t.model.getItem(e.id)})));var a,s=In(r);try{for(s.s();!(a=s.n()).done;){for(var u=a.value;o>=u.depth;)i=i.parent,o--;if(u.type==e.format.NodeType.STROKE_GROUP||u.type==e.format.NodeType.SENSOR_DATA_GROUP)i=i.appendChild(t.createGroup(u.id)),u.groupBoundingBox&&(i.bounds=new ne(u.groupBoundingBox.x,u.groupBoundingBox.y,u.groupBoundingBox.width,u.groupBoundingBox.height));else{var l=void 0;if(u.chunkToIndex>u.chunkFromIndex){var c={fromIndex:u.chunkFromIndex,toIndex:u.chunkToIndex,fromTValue:0,toTValue:1};l=t.createElement(n[u.index],c)}else l=t.createElement(n[u.index]);l.id=u.id,i=i.appendChild(l)}o=u.depth}}catch(e){s.e(e)}finally{s.f()}}},{key:"encodeProperties",value:function(t){return Object.keys(t).map((function(r){return e.format.Property.create({name:r,value:t[r]})}))}},{key:"decodeProperties",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e.forEach((function(e){return t[e.name]=e.value})),t}},{key:"encodeKnowledgeGraph",value:function(t){if(t){var r=e.format.TripleStore.create({statements:t.statements.map((function(t){return e.format.SemanticTriple.create({subject:t.subject,predicate:t.predicate,object:t.object})}))});return this.structure?r:e.encode(r)}}},{key:"decodeKnowledgeGraph",value:function(t){if(t){var r=new ln,n=this.structure?t:e.format.TripleStore.decode(t);return n&&n.statements.forEach((function(e){return r.addTriple(e.subject,e.predicate,e.object)})),r}}},{key:"encodeMat4",value:function(t){if(t)return e.format.Matrix4.create({m00:t.m11,m01:t.m12,m02:t.m13,m03:t.m14,m10:t.m21,m11:t.m22,m12:t.m23,m13:t.m24,m20:t.m31,m21:t.m32,m22:t.m33,m23:t.m34,m30:t.m41,m31:t.m42,m32:t.m43,m33:t.m44})}},{key:"decodeMat4",value:function(e){if(e)return $.fromMatrix([e.m00,e.m01,e.m02,e.m03,e.m10,e.m11,e.m12,e.m13,e.m20,e.m21,e.m22,e.m23,e.m30,e.m31,e.m32,e.m33])}},{key:"encodeTool",value:(t=de(he.mark((function t(r){var n,i,o,a,s,u=arguments;return he.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=u.length>1&&void 0!==u[1]?u[1]:{},i=u.length>2&&void 0!==u[2]?u[2]:{},o=u.length>3&&void 0!==u[3]?u[3]:sr.SOURCE_OVER,t.t0=e.format.Tool,t.t1=r instanceof We?this.encodeBrush2D(r):void 0,!(r instanceof dr)){t.next=11;break}return t.next=8,this.encodeBrushGL(r);case 8:t.t2=t.sent,t.next=12;break;case 11:t.t2=void 0;case 12:return t.t3=t.t2,t.t4=e.format.PathPointContext.create({statics:this.encodePathPointProperties(i),dynamics:this.encodePathPointSettings(n)}),t.t5={vectorBrush:t.t1,rasterBrush:t.t3,context:t.t4},a=t.t0.create.call(t.t0,t.t5),o!=sr.SOURCE_OVER&&(s=o.replace(/-/g,"_").toUpperCase(),a.blendMode=e.format.BlendMode[s]),t.abrupt("return",e.encode(a));case 18:case"end":return t.stop()}}),t,this)}))),function(e){return t.apply(this,arguments)})},{key:"decodeTool",value:function(t){if(t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r=e.format.Tool.decode(t);return{brush:"vectorBrush"==r.brush?this.decodeBrush2D(r.vectorBrush):this.decodeBrushGL(r.rasterBrush),blendMode:sr[e.format.BlendMode[r.blendMode]],statics:this.decodePathPointProperties(r.context.statics),dynamics:this.decodePathPointSettings(r.context.dynamics)}}}},{key:"encodePathPointProperties",value:function(t){var r=e.format.PathPointProperties.create();for(var n in e.format.PathPointProperties.fields){var i=t[n];isFinite(i)&&("red"!=n&&"green"!=n&&"blue"!=n||(i/=255),r[n]=e.format.Float32.create({value:i}))}return r}},{key:"decodePathPointProperties",value:function(t){if(t){var r={};for(var n in e.format.PathPointProperties.fields){var i=t[n];if(i){var o=i.value;"red"!=n&&"green"!=n&&"blue"!=n||(o=Math.round(255*o)),r[n]=o}}return r}}},{key:"encodePathPointSettings",value:function(t){var r=e.format.PathPointSettings.create();for(var n in e.format.PathPointSettings.fields)t[n]&&!t[n].disabled&&(r[n]=this.encodePropertySettings(n,t[n]));return r}},{key:"decodePathPointSettings",value:function(t){if(t){var r={};for(var n in e.format.PathPointSettings.fields)t[n]&&(r[n]=this.decodePropertySettings(t[n]));return r}}},{key:"encodePropertySettings",value:function(t,r){var n=this,i=function(r){if(r)return e.format.Range.create({min:r.min,max:r.max,remapURI:n.getActionDescriptorName(t,"Remap",r.remap)})};return e.format.PropertySettings.create({value:i(r.value),velocity:i(r.velocity),pressure:i(r.pressure),altitude:i(r.altitude),radiusX:i(r.radiusX),radiusY:i(r.radiusY),resolveURI:this.getActionDescriptorName(t,"Resolve",r.resolve),dependencies:(r.dependencies||[]).map((function(t){return e.format.InputPropertyType[t.name]}))})}},{key:"getActionDescriptorName",value:function(e,t,r){if(r){if("function"==typeof r)throw new Error("Encode '".concat(e,"' property failed. ").concat(t," action name property is required. Please provide ActionDescriptor for it's definition."));if("string"==typeof r)return r;if(r.name)return r.name;throw new Error("Encode '".concat(e,"' property failed. ").concat(t," action name property is required. Please provide ActionDescriptor for it's definition."))}}},{key:"decodePropertySettings",value:function(t){var r={},n=function(e,t){t&&(r[e]={min:t.min,max:t.max,remap:t.remapURI})};return n("value",t.value),n("velocity",t.velocity),n("pressure",t.pressure),n("altitude",t.altitude),n("radiusX",t.radiusX),n("radiusY",t.radiusY),r.resolve=t.resolveURI,t.dependencies.length>0&&(r.dependencies=t.dependencies.map((function(t){return Pe.Type[e.format.InputPropertyType[t]]}))),r}}],[{key:"encode",value:function(e){return e.constructor.encode(e).finish()}}]),e}();function An(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return On(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return On(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function On(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Cn=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.Mode.WHOLE_STROKE;h(this,e),this.mode=t,this.segmentInterpolator=new St(1,!1,!0),this.convexHullChainProducer=new Jt,this.holesBuilder=new Tt}return d(e,[{key:"updateSegmentation",value:function(t){if(!this.context)throw new Error("Required spatial context not found");var r,n=[],i=!1,o=An(t);try{for(o.s();!(r=o.n()).done;){var a=r.value;if(0!=a.length){var s=ne.ofPolygon(a),u=this.context.search(s);if(u.length>0){var l,c,h=[],f=An(u);try{for(f.s();!(c=f.n()).done;){var d=c.value;if(0==d.depth){var p=this.context.getStroke(d.strokeID),y=this.buildStrokeSegments(p);this.context.updateTree(d,y),h=h.concat(y),i=!0}else if(1==d.depth){for(var v=[],g=this.segmentInterpolator.split(d.spline),m=this.context.getBrushApplier(d.strokeID).get(g),b=0;b<g.length-1;b++){var E=[m[b],m[b+1]];v.push({strokeID:d.strokeID,segmentIndex:d.segmentIndex,splineIndex:b,bounds:ne.ofPolygons(E),point:g.getPoint(b),spline:new bt(d.spline.layout,d.spline.points,d.spline.pointProps,g.getPointT(b),g.getPointT(b+1)),shapesPath:E,depth:2})}this.context.updateTree(d,v),h=h.concat(v),i=!0}else if(2==d.depth){this.convexHullChainProducer.reset();var x=this.convexHullChainProducer.get(d.shapesPath);d.depth=3,d.hulls=x,this.context.tree.canvas&&this.context.tree.canvas.refresh(),i=!0}else if(3==d.depth){if(st.intersection(d.hulls,a))if(this.mode==e.Mode.PARTIAL_STROKE){for(var P=[],k=this.segmentInterpolator.get(d.spline),w=this.context.getBrushApplier(d.strokeID).get(k),R=0;R<k.length;R++){var I=ne.ofPolygon(w[R]),S=I,T=d.spline,A=k.getPointT(R),O=k.getPointT(R-1),C=k.getPointT(R+1);if(isNaN(O)&&(O=d.spline.ts),isNaN(C)&&(C=d.spline.tf),I.width!=I.height){var D=Math.max(I.width,I.height);I=new ne(I.center.x-D/2,I.center.y-D/2,D,D)}P.push({strokeID:d.strokeID,segmentIndex:d.segmentIndex,splineIndex:d.splineIndex,pointIndex:R,bounds:I,point:k.getPoint(R),spline:T,prevT:O,t:A,nextT:C,shape:w[R],shapeBounds:S,depth:4})}this.context.updateTree(d,P),h=h.concat(P),i=!0}else n.push(d)}else ne.intersect(s,d.bounds)&&(d.affected=!0),n.push(d)}}catch(e){f.e(e)}finally{f.f()}if(h.length>0&&this.context.load(h),i)return this.updateSegmentation(t);(l=this.nodes).push.apply(l,n)}}}}catch(e){o.e(e)}finally{o.f()}}},{key:"buildStrokeSegments",value:function(t){for(var r=[],n=this.context.getBrushApplier(t.id),i=0;i<t.segmentsCount;i++){var o=e.buildStrokeSegment(t,i,n);r.push(o)}return r}},{key:"createIntervals",value:function(e,t){var r=this,n={intersected:{},selected:[]};if(0==t.length)return n;var i=this.holesBuilder.build(this.context,e,t),o=function(e){var o=r.context.getNodes(e),a=[],s=[];n.intersected[e]={intervals:a,holes:s},i[e].forEach((function(u,l){var c,h=0==u.fromIndex&&u.fromTValue==o.first.ts,f=u.toIndex==o.last.segmentIndex&&u.toTValue==o.last.tf;if(h&&f)return n.selected.push(e),void delete n.intersected[e];s.push(u),r.context.tree.canvas&&r.context.tree.canvas.addOperation("drawIntersection",t,r.context.getNodes(u.strokeID).slice(u.fromNodeIndex,u.toNodeIndex+1)),h?c={fromIndex:u.toIndex,fromTValue:u.toTValue,fromNodeIndex:u.toNodeIndex}:f?(a.last||a.push({fromIndex:0,fromTValue:o.first.spline.ts,fromNodeIndex:0}),a.last.toIndex=u.fromIndex+3,a.last.toTValue=u.fromTValue,a.last.toNodeIndex=u.fromNodeIndex):a.last?(a.last.toIndex=u.fromIndex+3,a.last.toTValue=u.fromTValue,a.last.toNodeIndex=u.fromNodeIndex,c={fromIndex:u.toIndex,fromTValue:u.toTValue,fromNodeIndex:u.toNodeIndex}):(a.push({fromIndex:0,fromTValue:o.first.spline.ts,toIndex:u.fromIndex+3,toTValue:u.fromTValue,fromNodeIndex:0,toNodeIndex:u.fromNodeIndex}),c={fromIndex:u.toIndex,fromTValue:u.toTValue,fromNodeIndex:u.toNodeIndex}),c&&a.push(c),l!=i[e].length-1||f||(a.last.toIndex=o.last.segmentIndex+3,a.last.toTValue=o.last.spline.tf,a.last.toNodeIndex=o.length-1);var d=[];a.forEach((function(e){if(1==e.fromTValue){var t=o.filter((function(t){return t.segmentIndex==e.fromIndex+1})).first,r=o.filter((function(t){return t.segmentIndex==e.fromIndex}));s.push({fromNodeIndex:r.first.nodeIndex||o.indexOf(r.first),toNodeIndex:r.last.nodeIndex||o.indexOf(r.last),type:"OVERLAPPING_INC"}),e.fromIndex++,e.fromTValue=0,e.fromNodeIndex=o.indexOf(t)}if(0==e.toTValue){var n=e.toIndex-3,i=o.filter((function(e){return e.segmentIndex==n-1})).last,a=o.filter((function(e){return e.segmentIndex==n}));s.push({fromNodeIndex:a.first.nodeIndex||o.indexOf(a.first),toNodeIndex:a.last.nodeIndex||o.indexOf(a.last),type:"OVERLAPPING_DEC"}),e.toIndex--,e.toTValue=1,e.toNodeIndex=o.indexOf(i)}if(e.toIndex-e.fromIndex<3)d.push(e);else if(e.toIndex-e.fromIndex==3&&e.fromTValue==e.toTValue){var u=o.filter((function(t){return t.segmentIndex==e.fromIndex}));s.push({fromNodeIndex:u.first.nodeIndex||o.indexOf(u.first),toNodeIndex:u.last.nodeIndex||o.indexOf(u.last),type:"INVALID"}),d.push(e)}})),d.forEach((function(e){return a.remove(e)}))}))};for(var a in i)o(a);return n}},{key:"reset",value:function(e){if(!e)throw new Error("Required spatial context not found");this.context=e,this.nodes=[],this.context.tree.canvas&&this.context.tree.canvas.refresh()}}],[{key:"buildStrokeNode",value:function(e){return{strokeID:e.id,bounds:e.bounds,point:e.getPoint(0),depth:0}}},{key:"buildStrokeSegment",value:function(e,t,r){if(t<0||t>=e.segmentsCount)throw new Error("Invalid index ".concat(t," found. Ensure that index range is {0, ").concat(e.segmentsCount-1,"}."));var n=.166666666666,i=e.getSegment(t),o=i.getPoint(0),a=i.getPoint(1),s=i.getPoint(2),u=i.getPoint(3),l=-n*o.x+a.x+n*s.x,c=-n*o.y+a.y+n*s.y,h=+n*a.x+s.x-n*u.x,f=+n*a.y+s.y-n*u.y,d=a.toArray(e.layout).concat(s.toArray(e.layout)),p=new xt(e.layout,d,e.pointProps),y=r.get(p),v=ne.ofPolygon(y.first),g=ne.ofPolygon(y.last),m=Math.max(v.width,g.height),b=Math.max(v.height,g.height),E=Math.max(m,b),x=new ne(l-E/2,c-b/2,E,E),P=new ne(h-E/2,f-b/2,E,E),k=v.union(g).union(x).union(P);return{strokeID:e.id,segmentIndex:t,bounds:k,point:i.getPoint(0),spline:i,shapesPath:y,depth:1}}}]),e}();Object.defineEnum(Cn,"Mode",["WHOLE_STROKE","PARTIAL_STROKE"]);var Dn=function(){function e(){h(this,e),this.tree=new mt,this.strokes={},this.brushAppliers={},this.nodes={}}return d(e,[{key:"add",value:function(e){e.brush instanceof dr||(this.strokes[e.id]=e,this.loadStrokeNode(e))}},{key:"getStroke",value:function(e){return this.strokes[e]}},{key:"getBrushApplier",value:function(e){var t=this.strokes[e].brush;return this.brushAppliers[t.name]||(this.brushAppliers[t.name]=new Wt(t)),this.brushAppliers[t.name]}},{key:"getNodes",value:function(e){return this.nodes[e]}},{key:"loadStrokeNode",value:function(e){var t=Cn.buildStrokeNode(e);this.nodes[e.id]=[t],this.load(t)}},{key:"reload",value:function(e){this.unload(this.nodes[e.id]),this.loadStrokeNode(e)}},{key:"remove",value:function(e){var t="string"==typeof e?e:e.id;this.unload(this.nodes[t]),delete this.nodes[t],delete this.strokes[t]}},{key:"update",value:function(e,t){var r=this,n={intersected:[],selected:[],dirtyArea:void 0};return Object.keys(e).forEach((function(i){var o=r.strokes[i],a=r.split(o,e[i]);a&&(n.intersected.push({stroke:o,strokes:a}),t||(n.dirtyArea=o.bounds.union(n.dirtyArea)),e[i].intervals.forEach((function(e,t){e.inside&&n.selected.push(a[t])})))})),n}},{key:"split",value:function(e,t){var r=this,n=t.intervals,i=t.holes;if(0==n.length)return[];var o=e.split(n);if(o){o.forEach((function(e){r.strokes[e.id]=e}));var a=[],s=[];return n.map((function(t){return r.nodes[e.id].slice(t.fromNodeIndex,t.toNodeIndex+1)})).forEach((function(t,i){var u,l,c=o[i],h=r.getBrushApplier(c.id),f=n[i].fromIndex,d=n[i].toIndex-3;if(c.ts!=t.first.spline.ts){var p=t.first.segmentIndex,y=r.nodes[e.id].filter((function(e){return e.segmentIndex==p}));t=t.filter((function(e){return e.segmentIndex!=p})),p>=f&&(u=Cn.buildStrokeSegment(c,p-f,h),a.push(u)),s.push.apply(s,j(y))}if(t.length>0&&c.tf!=t.last.spline.tf){var v=t.last.segmentIndex,g=r.nodes[e.id].filter((function(e){return e.segmentIndex==v}));t=t.filter((function(e){return e.segmentIndex!=v})),v<=d&&(l=Cn.buildStrokeSegment(c,v-f,h),a.push(l)),s.push.apply(s,j(g))}t.forEach((function(e){e.strokeID=c.id,e.segmentIndex-=f})),u&&t.unshift(u),l&&t.push(l),r.nodes[c.id]=t})),i.forEach((function(t){return s.push.apply(s,j(r.nodes[e.id].slice(t.fromNodeIndex,t.toNodeIndex+1)))})),this.unload(s),this.load(a),delete this.nodes[e.id],delete this.strokes[e.id],o}}},{key:"replace",value:function(e,t){var r=this;t.forEach((function(e){return r.add(e)})),this.remove(e)}},{key:"load",value:function(e){Array.isArray(e)||(e=[e]),0!=e.length&&(this.tree.load(e),this.tree.canvas&&this.tree.canvas.refresh())}},{key:"updateTree",value:function(e,t){this.tree.remove(e),this.nodes[e.strokeID].replace(e,t)}},{key:"unload",value:function(e){var t=this;Array.isArray(e)||(e=[e]),e.forEach((function(e){return t.tree.remove(e)})),this.tree.canvas&&this.tree.canvas.refresh()}},{key:"search",value:function(e){return this.tree.search(e)}},{key:"reset",value:function(){this.strokes={},this.brushAppliers={},this.nodes={},this.tree.clear(),this.tree.canvas&&this.tree.canvas.refresh()}}]),e}();function Nn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var Mn=function(e){g(r,e);var t=Nn(r);function r(e){return h(this,r),t.call(this,e)}return d(r,[{key:"intersect",value:function(e){if(!this.context)throw new Error("Required spatial context not found");return this.nodes=[],this.updateSegmentation(e),this.mode==r.Mode.PARTIAL_STROKE?this.createIntervals(this.nodes,e):{intersected:{},selected:this.nodes.map((function(e){return e.strokeID})).unique()}}},{key:"intersectSegmentation",value:function(e){if(!this.context)throw new Error("Required spatial context not found");return this.createIntervals(this.nodes,e)}}]),r}(Cn);function Ln(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=E(e);if(t){var i=E(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var _n=function(e){g(r,e);var t=Ln(r);function r(e){return h(this,r),t.call(this,e)}return d(r,[{key:"select",value:function(e){var t=this;if(!this.context)throw new Error("Required spatial context not found");if(this.mode==r.Mode.PARTIAL_STROKE){var n=e.spline.getPoint(0).toArray(e.layout),i=e.spline.getPoint(e.spline.length-1).toArray(e.layout),o=[].concat(j(n),j(n),j(i),j(i)),a=new Ir(e.brush,new bt(e.layout,o,e.pointProps));this.updateSegmentation(a.path)}var s={intersected:{},selected:[]},u=e.bounds,l=st.createClipperPath(e.spline),c=this.context.search(u),h=this.nodes.map((function(e){return e.strokeID})).unique(),f=c.map((function(e){return e.strokeID})).unique().filter((function(e){return!h.includes(e)}));if(this.context.tree.canvas&&this.context.tree.canvas.addOperation("drawSelection",u,e.points,e.path.first),this.mode==r.Mode.PARTIAL_STROKE){var d=this.createIntervals(this.nodes,e.path);s=d,h.forEach((function(e){var r=[];d.intersected[e]&&(r=d.intersected[e].intervals),r.forEach((function(r){var n=t.context.getNodes(e)[r.fromNodeIndex];r.inside=st.containsPoint(l,n.point),t.context.tree.canvas&&t.context.tree.canvas.addOperation("fillPoint",n.point,5,r.inside?z.WHITE:z.BLACK)}))}))}else s.selected=h;return f.forEach((function(e){var r=t.context.getNodes(e)[0];st.containsPoint(l,r.point)&&s.selected.push(e),t.context.tree.canvas&&t.context.tree.canvas.addOperation("fillPoint",r.point,5,z.WHITE)})),Object.defineProperty(s,"length",{get:function(){return Object.keys(s.intersected).length+s.selected.length},enumerable:!0}),this.context.tree.canvas&&this.context.tree.canvas.refresh(),s}}]),r}(Cn),Fn=Ft,Bn=jt,Un=Yt,jn=St,Gn=qt,Yn=Wt,zn=Jt,Xn=er,Vn=rr,Hn=ir;e.BlendMode=sr,e.Brush2D=We,e.BrushApplier=Yn,e.BrushGL=dr,e.BrushPrototype=Ue,e.Color=z,e.ConvexHullChainProducer=zn,e.ConvexHullProducer=Lt,e.CurvatureBasedInterpolator=Gn,e.DistanceBasedInterpolator=jn,e.Environment=ge,e.InkBuilder=mr,e.InkBuilderAsync=wr,e.InkCanvas2D=Lr,e.InkCanvasGL=an,e.InkCodec=Tn,e.InkController=p,e.InkInputProvider=M,e.InkModel=Pn,e.InkPath2D=Nt,e.InputContext=Te,e.InputDevice=Me,e.InputListener=ce,e.InterpolatedSpline=xt,e.Intersector=Mn,e.Matrix=$,e.OffscreenCanvasGL=jr,e.PathPoint=te,e.PathPointContext=Ke,e.PathProducer=Fn,e.PathSegment=Ct,e.Pipeline=or,e.PipelineStage=Hn,e.Point=Y,e.PointerData=Ot,e.Poly=st,e.PolygonMerger=Xn,e.PolygonSimplifier=Vn,e.Rect=ne,e.Scalar=be,e.Selector=_n,e.SemanticTriple=un,e.SensorChannel=Pe,e.SensorChannelsContext=we,e.SensorContext=Ie,e.SensorData=Oe,e.SensorStream=Ce,e.ShapeFactory=Le,e.Smoother=Bn,e.SpatialContext=Dn,e.Spline=bt,e.SplineProducer=Un,e.Stroke=Ir,e.StrokeRenderer2D=_r,e.StrokeRendererGL=sn,e.TextTable=ie,e.TripleStore=ln,e.TypedArrayCodec=Fe,e.URIResolver=_e,e.fsx=He,e.math=At,e.utils=ue,e.uuid=A,e.version=R,Object.defineProperty(e,"__esModule",{value:!0})}));
